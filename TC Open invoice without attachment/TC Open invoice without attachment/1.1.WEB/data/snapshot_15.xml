<?xml version="1.0" encoding="utf-8"?>
<HTTPSnapshot xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" id="15">
  <HTTPTask id="524" hostname="sapui5.hana.ondemand.com" path="https://sapui5.hana.ondemand.com/1.71.4/resources/sap/ushell/components/homepage/Component-preload.js" url="https://sapui5.hana.ondemand.com/1.71.4/resources/sap/ushell/components/homepage/Component-preload.js" ip="2.23.181.71" port="443" connectionId="106" origin="Primary" frame="1" startDateTime="2019-11-15T17:22:27.482+03:00" startTime="1676531" endTime="1676531">
    <HTTPRequest method="GET">
      <HTTPHeaders>
        <HTTPHeaderEntity name="User-Agent" index="0">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>TW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzYzLjAuMzIzOS4xMzIgU2FmYXJpLzUzNy4zNg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept" index="1">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Ki8q</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Referer" index="2">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>aHR0cHM6Ly9wcm9jdXJlcGFydGVzdGMxLXNhcGNpbS10ZXN0LXBlcmZvcm1hbmNlLmludGVybmFsLmNmYXBwcy5zYXAuaGFuYS5vbmRlbWFuZC5jb20vY3AucG9ydGFsL3NpdGU=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept-Encoding" index="3">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Z3ppcCwgZGVmbGF0ZQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept-Language" index="4">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>ZW4tVVMsZW47cT0wLjk=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Host" index="5">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>c2FwdWk1LmhhbmEub25kZW1hbmQuY29t</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPAllHeaders>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>R0VUIGh0dHBzOi8vc2FwdWk1LmhhbmEub25kZW1hbmQuY29tLzEuNzEuNC9yZXNvdXJjZXMvc2FwL3VzaGVsbC9jb21wb25lbnRzL2hvbWVwYWdlL0NvbXBvbmVudC1wcmVsb2FkLmpzIEhUVFAvMS4xDQpVc2VyLUFnZW50OiBNb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXaW42NDsgeDY0KSBBcHBsZVdlYktpdC81MzcuMzYgKEtIVE1MLCBsaWtlIEdlY2tvKSBDaHJvbWUvNjMuMC4zMjM5LjEzMiBTYWZhcmkvNTM3LjM2DQpBY2NlcHQ6ICovKg0KUmVmZXJlcjogaHR0cHM6Ly9wcm9jdXJlcGFydGVzdGMxLXNhcGNpbS10ZXN0LXBlcmZvcm1hbmNlLmludGVybmFsLmNmYXBwcy5zYXAuaGFuYS5vbmRlbWFuZC5jb20vY3AucG9ydGFsL3NpdGUNCkFjY2VwdC1FbmNvZGluZzogZ3ppcCwgZGVmbGF0ZQ0KQWNjZXB0LUxhbmd1YWdlOiBlbi1VUyxlbjtxPTAuOQ0KSG9zdDogc2FwdWk1LmhhbmEub25kZW1hbmQuY29tDQoNCg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPAllHeaders>
      </HTTPHeaders>
    </HTTPRequest>
    <HTTPResponse>
      <contentLenght>27550</contentLenght>
      <HTTPHeaders>
        <HTTPHeaderEntity name="Content-Type" index="0">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>YXBwbGljYXRpb24vamF2YXNjcmlwdA==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Access-Control-Allow-Origin" index="1">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Kg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Encoding" index="2">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Z3ppcA==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="ETag" index="3">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Vy8iMS43MS40Ig==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Last-Modified" index="4">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>V2VkLCAzMCBPY3QgMjAxOSAyMzowODowNyBHTVQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Server" index="5">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>QWthbWFpIFJlc291cmNlIE9wdGltaXplcg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Strict-Transport-Security" index="6">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>bWF4LWFnZT0zMTUzNjAwMDsgaW5jbHVkZVN1YkRvbWFpbnM7IHByZWxvYWQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Vary" index="7">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>QWNjZXB0LUVuY29kaW5n</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="X-XSS-Protection" index="8">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>MA==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Length" index="9">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Mjc1NTA=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Cache-Control" index="10">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>cHVibGljLCBtYXgtYWdlPTMwMjEyNTU3</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Expires" index="11">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>RnJpLCAzMCBPY3QgMjAyMCAwNjo0NDo1NSBHTVQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Date" index="12">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>RnJpLCAxNSBOb3YgMjAxOSAxNDoyMjoxOCBHTVQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Connection" index="13">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>a2VlcC1hbGl2ZQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="timing-allow-origin" index="14">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Kg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="X-cache-akamai" index="15">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>c3RhYmxl</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPAllHeaders>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkFjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbjogKg0KQ29udGVudC1FbmNvZGluZzogZ3ppcA0KRVRhZzogVy8iMS43MS40Ig0KTGFzdC1Nb2RpZmllZDogV2VkLCAzMCBPY3QgMjAxOSAyMzowODowNyBHTVQNClNlcnZlcjogQWthbWFpIFJlc291cmNlIE9wdGltaXplcg0KU3RyaWN0LVRyYW5zcG9ydC1TZWN1cml0eTogbWF4LWFnZT0zMTUzNjAwMDsgaW5jbHVkZVN1YkRvbWFpbnM7IHByZWxvYWQNClZhcnk6IEFjY2VwdC1FbmNvZGluZw0KWC1YU1MtUHJvdGVjdGlvbjogMA0KQ29udGVudC1MZW5ndGg6IDI3NTUwDQpDYWNoZS1Db250cm9sOiBwdWJsaWMsIG1heC1hZ2U9MzAyMTI1NTcNCkV4cGlyZXM6IEZyaSwgMzAgT2N0IDIwMjAgMDY6NDQ6NTUgR01UDQpEYXRlOiBGcmksIDE1IE5vdiAyMDE5IDE0OjIyOjE4IEdNVA0KQ29ubmVjdGlvbjoga2VlcC1hbGl2ZQ0KdGltaW5nLWFsbG93LW9yaWdpbjogKg0KWC1jYWNoZS1ha2FtYWk6IHN0YWJsZQ0KDQo=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPAllHeaders>
      </HTTPHeaders>
      <HTTPBody>
        <HTTPDataSet>
          <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
            <ActualData>Ly9AdWk1LWJ1bmRsZSBDb21wb25lbnQtcHJlbG9hZC5qcwpzYXAudWkucmVxdWlyZS5wcmVsb2FkKHsKCSJzYXAvdXNoZWxsL2NvbXBvbmVudHMvaG9tZXBhZ2UvQWN0aW9uTW9kZS5qcyI6ZnVuY3Rpb24oKXsvLyAke2NvcHlyaWdodH0KCi8qKgogKiBAZmlsZU92ZXJ2aWV3IFRpbGUgYWN0aW9uIG1vZGUgaW1wbGVtZW50YXRpb24uCiAqCiAqIEluIHRpbGUgYWN0aW9uIG1vZGUgdGhlIHVzZXIgY2FuIGxhdW5jaCBhbiBhY3Rpb24gYXNzb2NpYXRlZCB3aXRoIGEgdGlsZS4KICogVGhlIG1vZGUgaXMgbGF1bmNoZWQgd2hlbiBjbGlja2luZyBvbiB0aGUgRWRpdCBidXR0b24gaW4gdGhlIHVzZXIgbWVudS4KICoKICogVGlsZSBhY3Rpb24gbW9kZSBjYW4gYmUgYWN0aXZhdGVkIG9ubHkgZnJvbSB0aGUgbGF1bmNocGFkLiBpdCBpcyBub3QgYWNjZXNzaWJsZSBmcm9tIHRoZSBjYXRhbG9nIG9yIGZyb20gYW4gYXBwbGljYXRpb24uCiAqIFdoZW4gdGhlIG1vZGUgaXMgYWN0aXZlIGFuZCB0aGUgdXNlciBjbGlja3Mgb24gYSB0aWxlIC0gdGhlIHRpbGUncyBjb3JyZXNwb25kaW5nIGFjdGlvbnMgYXJlIHByZXNlbnRlZCBpbiBhbiBhY3Rpb24gc2hlZXQKICogIGFuZCB0aGUgdXNlciBjYW4gY2xpY2svbGF1bmNoIGFueSBvZiB0aGVtLgogKgogKiBFdmVyeSB1c2VyIGFjdGlvbiAoZS5nLiBtZW51IGJ1dHRvbnMsIGRyYWctYW5kLWRyb3ApIGV4Y2VwdCBmb3IgY2xpY2tpbmcgYSB0aWxlIC0gc3RvcHMvZGVhY3RpdmF0ZXMgdGhlIGFjdGlvbiBtb2RlLgogKgogKiBUaGlzIG1vZHVsZSBDb250YWlucyB0aGUgZm9sbG93aW5nOgogKiAgLSBDb25zdHJ1Y3RvciBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYWN0aW9uIG1vZGUgYWN0aXZhdGlvbiBidXR0b25zCiAqICAtIEFjdGl2YXRpb24gaGFuZGxlcgogKiAgLSBEZWFjdGl2YXRpb24gaGFuZGxlcgogKiAgLSBSZW5kZXJpbmcgdGlsZSBhY3Rpb24gbWVudQogKgogKiBAdmVyc2lvbiAke3ZlcnNpb259CiAqLwovKioKICogQG5hbWVzcGFjZQogKiBAbmFtZSBzYXAudXNoZWxsLmNvbXBvbmVudHMuaG9tZXBhZ2UuQWN0aW9uTW9kZQogKiBAc2luY2UgMS4yNi4wCiAqIEBwcml2YXRlCiAqLwpzYXAudWkuZGVmaW5lKFsKICAgICJzYXAvdXNoZWxsL3Jlc291cmNlcyIsCiAgICAic2FwL20vbGlicmFyeSIsCiAgICAic2FwL20vQnV0dG9uIiwKICAgICJzYXAvdWkvdGhpcmRwYXJ0eS9qcXVlcnkiCl0sIGZ1bmN0aW9uICgKICAgIHJlc291cmNlcywKICAgIG1vYmlsZUxpYnJhcnksCiAgICBCdXR0b24sCiAgICBqUXVlcnkKKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgLy8gc2hvcnRjdXQgZm9yIHNhcC5tLlBsYWNlbWVudFR5cGUKICAgIHZhciBQbGFjZW1lbnRUeXBlID0gbW9iaWxlTGlicmFyeS5QbGFjZW1lbnRUeXBlOwoKICAgIC8qIGdsb2JhbCBoYXNoZXIgKi8KCiAgICAvKioKICAgICAqIENvbnN0cnVjdG9yIGZ1bmN0aW9uCiAgICAgKiBDcmVhdGVzIGFjdGlvbiBtb2RlIGFjdGl2YXRpb24gYnV0dG9uczoKICAgICAqICAxLiBBIG5ldyBidXR0b24gaW4gdGhlIHVzZXIgbWVudQogICAgICogIDIuIEEgZmxvYXRpbmcgYnV0dG9uCiAgICAgKi8KICAgIHZhciBBY3Rpb25Nb2RlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMub0V2ZW50QnVzID0gc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpOwoKICAgICAgICB0aGlzLmluaXQgPSBmdW5jdGlvbiAob01vZGVsKSB7CiAgICAgICAgICAgIHRoaXMub01vZGVsID0gb01vZGVsOwogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQWN0aXZhdGlvbiBoYW5kbGVyIG9mIHRpbGUgYWN0aW9ucyBtb2RlCiAgICAgKgogICAgICogUGVyZm9ybXMgdGhlIGZvbGxvd2luZyBhY3Rpb25zOgogICAgICogLSBTaG93cyBhIHRvYXN0IG1lc3NhZ2UgaW5kaWNhdGluZyB0aGUgYWN0aXZhdGVkIG1vZGUKICAgICAqIC0gU2V0cyB0aGUgZmVhdHVyZSdzIG1vZGVsIHByb3BlcnR5IHRvIGluZGljYXRlIHRoYXQgdGhlIGZlYXR1cmUgaXMgYWN0aXZhdGVkCiAgICAgKiAtIFJlZ2lzdGVycyBkZWFjdGl2YXRpb24gY2xpY2sgaGFuZGxlciwgY2FsbGVkIHdoZW4gdGhlIHVzZXIgY2xpY2tzIG91dHNpZGUgb2YgYSB0aWxlCiAgICAgKiAtIEFkZHMgdGhlIGNvdmVyIERJViB0byBhbGwgdGlsZXMgYWRkaW5nIHRoZSBtb2RlJ3MgZ3JleSBvcGFjaXR5IGFuZCBjbGljayBoYW5kbGVyIGZvciBvcGVuaW5nIHRoZSBhY3Rpb25zIG1lbnUKICAgICAqIC0gRGlzYWJsZXMgZHJhZyBjYXBhYmlsaXR5IG9uIHRpbGVzCiAgICAgKiAtIENoYW5nZXMgdGhlIGFwcGVhcmFuY2Ugb2YgdGhlIGZsb2F0aW5nIGFjdGl2YXRpb24gYnV0dG9uCiAgICAgKi8KICAgIEFjdGlvbk1vZGUucHJvdG90eXBlLl9hY3RpdmF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLm9Nb2RlbC5zZXRQcm9wZXJ0eSgiL3RpbGVBY3Rpb25Nb2RlQWN0aXZlIiwgdHJ1ZSk7CiAgICAgICAgdGhpcy5hT3JpZ0hpZGRlbkdyb3Vwc0lkcyA9IHRoaXMuZ2V0SG9tZXBhZ2VNYW5hZ2VyKCkuZ2V0Q3VycmVudEhpZGRlbkdyb3VwSWRzKHRoaXMub01vZGVsKTsKICAgICAgICB2YXIgb0Rhc2hib2FyZEdyb3VwcyA9IHNhcC51aS5nZXRDb3JlKCkuYnlJZCgiZGFzaGJvYXJkR3JvdXBzIik7CiAgICAgICAgb0Rhc2hib2FyZEdyb3Vwcy5hZGRMaW5rc1RvVW5zZWxlY3RlZEdyb3VwcygpOwoKICAgICAgICAvLyBDaGFuZ2UgYWN0aW9uIG1vZGUgYnV0dG9uIGRpc3BsYXkgaW4gdGhlIHVzZXIgYWN0aW9ucyBtZW51CiAgICAgICAgdmFyIG9UaWxlQWN0aW9uc0J1dHRvbiA9IHNhcC51aS5nZXRDb3JlKCkuYnlJZCgiQWN0aW9uTW9kZUJ0biIpOwogICAgICAgIGlmIChvVGlsZUFjdGlvbnNCdXR0b24pIHsKICAgICAgICAgICAgb1RpbGVBY3Rpb25zQnV0dG9uLnNldFRvb2x0aXAocmVzb3VyY2VzLmkxOG4uZ2V0VGV4dCgiZXhpdEVkaXRNb2RlIikpOwogICAgICAgICAgICBvVGlsZUFjdGlvbnNCdXR0b24uc2V0VGV4dChyZXNvdXJjZXMuaTE4bi5nZXRUZXh0KCJleGl0RWRpdE1vZGUiKSk7CiAgICAgICAgICAgIC8vIG9ubHkgYXZhaWFibGUgaWYgdGhlIGFjdGlvbiBtb2RlIGJ1dHRvbiBpcyBpbiB0aGUgc2hlbGwgaGVhZGVyCiAgICAgICAgICAgIGlmIChvVGlsZUFjdGlvbnNCdXR0b24uc2V0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIG9UaWxlQWN0aW9uc0J1dHRvbi5zZXRTZWxlY3RlZCh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLm9FdmVudEJ1cy5wdWJsaXNoKCJsYXVuY2hwYWQiLCAiYWN0aW9uTW9kZUFjdGl2ZSIpOwogICAgfTsKCiAgICAvKioKICAgICAqIERlYWN0aXZhdGlvbiBoYW5kbGVyIG9mIHRpbGUgYWN0aW9ucyBtb2RlCiAgICAgKgogICAgICogUGVyZm9ybXMgdGhlIGZvbGxvd2luZyBhY3Rpb25zOgogICAgICogLSBVbnJlZ2lzdGVycyBkZWFjdGl2YXRpb24gY2xpY2sgaGFuZGxlcgogICAgICogLSBTZXRzIHRoZSBmZWF0dXJlJ3MgbW9kZWwgcHJvcGVydHkgdG8gaW5kaWNhdGUgdGhhdCB0aGUgZmVhdHVyZSBpcyBkZWFjdGl2YXRlZAogICAgICogLSBFbmFibGVzIGRyYWcgY2FwYWJpbGl0eSBvbiB0aWxlcwogICAgICogLSBEZXN0cm95cyB0aGUgdGlsZSBhY3Rpb25zIG1lbnUgY29udHJvbAogICAgICogLSBSZW1vdmVkIHRoZSBjb3ZlciBESVYgZnJvbSB0byBhbGwgdGhlIHRpbGVzCiAgICAgKiAtIEFkZHMgdGhlIGNvdmVyIERJViB0byBhbGwgdGlsZXMgYWRkaW5nIHRoZSBtb2RlJ3MgZ3JleSBvcGFjaXR5IGFuZCBjbGljayBoYW5kbGVyIGZvciBvcGVuaW5nIHRoZSBhY3Rpb25zIG1lbnUKICAgICAqIC0gQ2hhbmdlcyB0aGUgYXBwZWFyYW5jZSBvZiB0aGUgZmxvYXRpbmcgYWN0aXZhdGlvbiBidXR0b24KICAgICAqLwogICAgQWN0aW9uTW9kZS5wcm90b3R5cGUuX2RlYWN0aXZhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5vTW9kZWwuc2V0UHJvcGVydHkoIi90aWxlQWN0aW9uTW9kZUFjdGl2ZSIsIGZhbHNlKTsKICAgICAgICB0aGlzLm9FdmVudEJ1cy5wdWJsaXNoKCJsYXVuY2hwYWQiLCAiYWN0aW9uTW9kZUluYWN0aXZlIiwgdGhpcy5hT3JpZ0hpZGRlbkdyb3Vwc0lkcyk7CgogICAgICAgIHZhciB0aWxlQWN0aW9uc01lbnUgPSBzYXAudWkuZ2V0Q29yZSgpLmJ5SWQoIlRpbGVBY3Rpb25zIik7CiAgICAgICAgaWYgKHRpbGVBY3Rpb25zTWVudSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRpbGVBY3Rpb25zTWVudS5kZXN0cm95KCk7CiAgICAgICAgfQogICAgICAgIHNhcC51aS5yZXF1aXJlKFsic2FwL20vTWVzc2FnZVRvYXN0Il0sIGZ1bmN0aW9uIChNZXNzYWdlVG9hc3QpIHsKICAgICAgICAgICAgTWVzc2FnZVRvYXN0LnNob3cocmVzb3VyY2VzLmkxOG4uZ2V0VGV4dCgic2F2ZWRDaGFuZ2VzIiksIHsgZHVyYXRpb246IDQwMDAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIENoYW5nZSBhY3Rpb24gbW9kZSBidXR0b24gZGlzcGxheSBpbiB0aGUgdXNlciBhY3Rpb25zIG1lbnUKICAgICAgICB2YXIgb1RpbGVBY3Rpb25zQnV0dG9uID0gc2FwLnVpLmdldENvcmUoKS5ieUlkKCJBY3Rpb25Nb2RlQnRuIik7CiAgICAgICAgaWYgKG9UaWxlQWN0aW9uc0J1dHRvbikgewogICAgICAgICAgICBvVGlsZUFjdGlvbnNCdXR0b24uc2V0VG9vbHRpcChyZXNvdXJjZXMuaTE4bi5nZXRUZXh0KCJhY3RpdmF0ZUVkaXRNb2RlIikpOwogICAgICAgICAgICBvVGlsZUFjdGlvbnNCdXR0b24uc2V0VGV4dChyZXNvdXJjZXMuaTE4bi5nZXRUZXh0KCJhY3RpdmF0ZUVkaXRNb2RlIikpOwogICAgICAgICAgICAvLyBvbmx5IGF2YWlhYmxlIGlmIHRoZSBhY3Rpb24gbW9kZSBidXR0b24gaXMgaW4gdGhlIHNoZWxsIGhlYWRlcgogICAgICAgICAgICBpZiAob1RpbGVBY3Rpb25zQnV0dG9uLnNldFNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICBvVGlsZUFjdGlvbnNCdXR0b24uc2V0U2VsZWN0ZWQoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBBY3Rpb25Nb2RlLnByb3RvdHlwZS50b2dnbGVBY3Rpb25Nb2RlID0gZnVuY3Rpb24gKG9Nb2RlbCwgc1NvdXJjZSwgZGFzaGJvYXJkR3JvdXBzKSB7CiAgICAgICAgZGFzaGJvYXJkR3JvdXBzID0gZGFzaGJvYXJkR3JvdXBzIHx8IFtdOwoKICAgICAgICB2YXIgdmlzaWJsZUdyb3VwcyA9IGRhc2hib2FyZEdyb3Vwcy5maWx0ZXIoZnVuY3Rpb24gKGdyb3VwKSB7CiAgICAgICAgICAgIHJldHVybiBncm91cC5nZXRWaXNpYmxlKCk7CiAgICAgICAgfSk7CgogICAgICAgIHZhciBvRGF0YSA9IHsKICAgICAgICAgICAgZ3JvdXA6IHZpc2libGVHcm91cHNbb01vZGVsLmdldFByb3BlcnR5KCIvdG9wR3JvdXBJblZpZXdQb3J0SW5kZXgiKV0sCiAgICAgICAgICAgIHJlc3RvcmVMYXN0Rm9jdXNlZFRpbGU6IHRydWUKICAgICAgICB9OwoKICAgICAgICBpZiAob01vZGVsLmdldFByb3BlcnR5KCIvdGlsZUFjdGlvbk1vZGVBY3RpdmUiKSkgewogICAgICAgICAgICB0aGlzLl9kZWFjdGl2YXRlKCk7CgogICAgICAgICAgICAvLyBpZiB0aGUgVGlsZUNvbnRhaW5lciBoZWFkZXIgd2FzIGZvY3VzZWQsIHdlIG5lZWQgdG8gcmVzdG9yZSBmb2N1cyB0byB0aGUgY2xvc2VzdCB0aWxlCiAgICAgICAgICAgIHZhciBqcUxhc3RGb2N1c2VkSGVhZGVyID0galF1ZXJ5KCIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lckhlYWRlclt0YWJpbmRleD0wXSIpOwogICAgICAgICAgICBpZiAoanFMYXN0Rm9jdXNlZEhlYWRlci5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBqcVRpbGVDb250YWluZXIgPSBqcUxhc3RGb2N1c2VkSGVhZGVyWzBdLmNsb3Nlc3QoIi5zYXBVc2hlbGxUaWxlQ29udGFpbmVyIik7CiAgICAgICAgICAgICAgICBpZiAoanFUaWxlQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgb0RhdGEucmVzdG9yZUxhc3RGb2N1c2VkVGlsZUNvbnRhaW5lckJ5SWQgPSBqcVRpbGVDb250YWluZXIuaWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9hY3RpdmF0ZSgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5vRXZlbnRCdXMucHVibGlzaCgibGF1bmNocGFkIiwgInNjcm9sbFRvR3JvdXAiLCBvRGF0YSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQXBwbHkgYWN0aW9uL2VkaXQgbW9kZSBDU1MgY2xhc3NlcyBvbiBhIGdyb3VwLgogICAgICogVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgd2hlbiBpbiBlZGl0L2FjdGlvbiBtb2RlIGFuZCB0aWxlcyB3ZXJlIGRyYWdnZWQsCiAgICAgKiAgc2luY2UgdGhlIGdyb3VwIGlzIGJlaW5nIHJlLXJlbmRlcmVkIGFuZCB0aGUgZGFzaGJvYXJkIGlzIHN0aWxsIGluIGFjdGlvbi9lZGl0IG1vZGUKICAgICAqLwogICAgQWN0aW9uTW9kZS5wcm90b3R5cGUuYWN0aXZhdGVHcm91cEVkaXRNb2RlID0gZnVuY3Rpb24gKG9Hcm91cCkgewogICAgICAgIHZhciBqcUdyb3VwRWxlbWVudCA9IGpRdWVyeShvR3JvdXAuZ2V0RG9tUmVmKCkpLmZpbmQoIi5zYXBVc2hlbGxUaWxlQ29udGFpbmVyQ29udGVudCIpOwoKICAgICAgICBqcUdyb3VwRWxlbWVudC5hZGRDbGFzcygic2FwVXNoZWxsVGlsZUNvbnRhaW5lckVkaXRNb2RlIik7CiAgICB9OwogICAgQWN0aW9uTW9kZS5wcm90b3R5cGUuZ2V0SG9tZXBhZ2VNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghdGhpcy5vSG9tZXBhZ2VNYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMub0hvbWVwYWdlTWFuYWdlciA9IHNhcC51c2hlbGwuY29tcG9uZW50cy5nZXRIb21lcGFnZU1hbmFnZXIoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMub0hvbWVwYWdlTWFuYWdlcjsKICAgIH07CgogICAgLyoqCiAgICAgKiBPcGVucyB0aGUgdGlsZSBtZW51LCBwcmVzZW50aW5nIHRoZSB0aWxlJ3MgYWN0aW9ucwogICAgICoKICAgICAqIFBlcmZvcm1zIHRoZSBmb2xsb3dpbmcgYWN0aW9uczoKICAgICAqIC0gUmV0dXJuaW5nIHRoZSBjbGlja2VkIHRpbGUgdG8gaXRzIG9yaWdpbmFsIGFwcGVhcmFuY2UKICAgICAqIC0gVHJpZXMgdG8gZ2V0IGFuIGV4aXN0aW5nIGFjdGlvbiBzaGVldCBpbiBjYXNlIGFjdGlvbnMgbWVudSB3YXMgYWxyZWFkeSBvcGVuZWQgZHVyaW5nIHRoaXMgc2Vzc2lvbiBvZiBhY3Rpb24gbW9kZQogICAgICogLSBJZiB0aGlzIGlzIHRoZSBmaXJzdCB0aW1lIHRoZSB1c2VyIG9wZW5zIGFjdGlvbnMgbWVudSBkdXJpbmcgdGhpcyBzZXNzaW9uIG9mIGFjdGlvbiBtb2RlIC0gbGF6eSBjcmVhdGlvbiBhIG5ldyBhY3Rpb24gc2hlZXQKICAgICAqIC0gR2V0cyB0aGUgcmVsZXZhbnQgdGlsZSdzIGFjdGlvbnMgZnJvbSBsYXVuY2ggcGFnZSBzZXJ2aWNlIGFuZCBjcmVhdGUgYnV0dG9ucyBhY2NvcmRpbmdseQogICAgICogLSBPcGVuIHRoZSBhY3Rpb24gc2hlZXQgYnkgdGhlIGNsaWNrZWQgdGlsZQogICAgICoKICAgICAqIEBwYXJhbSBvRXZlbnQgRXZlbnQgb2JqZWN0IG9mIHRoZSB0aWxlIGNsaWNrIGFjdGlvbgogICAgICovCiAgICBBY3Rpb25Nb2RlLnByb3RvdHlwZS5fb3BlbkFjdGlvbnNNZW51ID0gZnVuY3Rpb24gKG9FdmVudCwgb1ZpZXcpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgIG9UaWxlQ29udHJvbCA9IG9WaWV3IHx8IG9FdmVudC5nZXRTb3VyY2UoKSwKICAgICAgICAgICAgYUFjdGlvbnMgPSBbXSwKICAgICAgICAgICAgb0FjdGlvblNoZWV0ID0gc2FwLnVpLmdldENvcmUoKS5ieUlkKCJUaWxlQWN0aW9ucyIpLAogICAgICAgICAgICBvQWN0aW9uU2hlZXRUYXJnZXQsCiAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICBhQWN0aW9uc0J1dHRvbnMgPSBbXSwKICAgICAgICAgICAgbm9BY3Rpb25zQnV0dG9uLAogICAgICAgICAgICBvQnV0dG9uLAogICAgICAgICAgICBvQWN0aW9uLAogICAgICAgICAgICBvVGlsZSwKICAgICAgICAgICAgZm5IYW5kbGVBY3Rpb25QcmVzcywKICAgICAgICAgICAgY292ZXJEaXY7CgogICAgICAgIGlmIChvVGlsZUNvbnRyb2wpIHsKICAgICAgICAgICAgb1RpbGUgPSBvVGlsZUNvbnRyb2wuZ2V0QmluZGluZ0NvbnRleHQoKS5nZXRPYmplY3QoKS5vYmplY3Q7CiAgICAgICAgICAgIGFBY3Rpb25zID0gdGhpcy5nZXRIb21lcGFnZU1hbmFnZXIoKS5nZXRUaWxlQWN0aW9ucyhvVGlsZSk7CiAgICAgICAgfQogICAgICAgIHRoYXQub1RpbGVDb250cm9sID0gb1RpbGVDb250cm9sOwogICAgICAgIGpRdWVyeSgiLnNhcFVzaGVsbFRpbGVBY3Rpb25MYXllckRpdlNlbGVjdGVkIikucmVtb3ZlQ2xhc3MoInNhcFVzaGVsbFRpbGVBY3Rpb25MYXllckRpdlNlbGVjdGVkIik7CgogICAgICAgIGNvdmVyRGl2ID0galF1ZXJ5KG9FdmVudC5nZXRTb3VyY2UoKS5nZXREb21SZWYoKSkuZmluZCgiLnNhcFVzaGVsbFRpbGVBY3Rpb25MYXllckRpdiIpOwogICAgICAgIGNvdmVyRGl2LmFkZENsYXNzKCJzYXBVc2hlbGxUaWxlQWN0aW9uTGF5ZXJEaXZTZWxlY3RlZCIpOwoKICAgICAgICAvL2luIGEgbG9ja2VkIGdyb3VwIHdlIGRvIG5vdCBzaG93IGFueSBhY3Rpb24KICAgICAgICAvLyh0aGlzIGlzIGhlcmUgdG8gcHJldmVudCB0aGUgdGlsZS1zZXR0aW5ncyBhY3Rpb24gYWRkZWQgYnkgRHluYW1pYyAmIFN0YXRpYyB0aWxlcyBmcm9tIGJlaW5nIG9wZW5lZCkKICAgICAgICAvL05PVEUgLSB3aGVuIHJlbW92aW5nIHRoaXMgY2hlY2sgKGFjY29yZGluZyB0byByZXF1aXJlbWVudHMgYnkgUE8pCiAgICAgICAgLy8tIHdlIG11c3QgZGlzYWJsZSB0aGUgdGlsZVNldHRpbmdzIGFjdGlvbiBpbiBhIGRpZmZlcmVudCB3YXkKICAgICAgICB2YXIgb1RpbGVNb2RlbCA9IG9UaWxlQ29udHJvbC5nZXRNb2RlbCgpOwogICAgICAgIHZhciBzR3JvdXBCaW5kaW5nUGF0aCA9IG9UaWxlQ29udHJvbC5nZXRQYXJlbnQoKS5nZXRCaW5kaW5nQ29udGV4dCgpLmdldFBhdGgoKTsKICAgICAgICBpZiAoYUFjdGlvbnMubGVuZ3RoID09PSAwIHx8IG9UaWxlTW9kZWwuZ2V0UHJvcGVydHkoc0dyb3VwQmluZGluZ1BhdGggKyAiL2lzR3JvdXBMb2NrZWQiKSkgewogICAgICAgICAgICAvLyBDcmVhdGUgYSBzaW5nbGUgYnV0dG9uIGZvciBwcmVzZW50aW5nICJUaWxlIGhhcyBubyBhY3Rpb25zIiBtZXNzYWdlIHRvIHRoZSB1c2VyCiAgICAgICAgICAgIG5vQWN0aW9uc0J1dHRvbiA9IG5ldyBCdXR0b24oewogICAgICAgICAgICAgICAgdGV4dDogcmVzb3VyY2VzLmkxOG4uZ2V0VGV4dCgidGlsZUhhc05vQWN0aW9ucyIpLAogICAgICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFBY3Rpb25zQnV0dG9ucy5wdXNoKG5vQWN0aW9uc0J1dHRvbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgYUFjdGlvbnMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICBvQWN0aW9uID0gYUFjdGlvbnNbaW5kZXhdOwogICAgICAgICAgICAgICAgLy8gVGhlIHByZXNzIGhhbmRsZXIgb2YgYSBidXR0b24gKHJlcHJlc2VudGluZyBhIHNpbmdsZSBhY3Rpb24pIGluIGEgdGlsZSdzIGFjdGlvbiBzaGVldAogICAgICAgICAgICAgICAgZm5IYW5kbGVBY3Rpb25QcmVzcyA9IChmdW5jdGlvbiAob0FjdGlvbikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuX2hhbmRsZUFjdGlvblByZXNzKG9BY3Rpb24sIG9UaWxlQ29udHJvbCk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0ob0FjdGlvbikpOwogICAgICAgICAgICAgICAgb0J1dHRvbiA9IG5ldyBCdXR0b24oewogICAgICAgICAgICAgICAgICAgIHRleHQ6IG9BY3Rpb24udGV4dCwKICAgICAgICAgICAgICAgICAgICBpY29uOiBvQWN0aW9uLmljb24sCiAgICAgICAgICAgICAgICAgICAgcHJlc3M6IGZuSGFuZGxlQWN0aW9uUHJlc3MKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYUFjdGlvbnNCdXR0b25zLnB1c2gob0J1dHRvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vRm9yIHRpbGVzIC0gYWN0aW9ucyBtZW51IGlzIG9wZW5lZCBieSAibW9yZSIgaWNvbiwgZm9yIGxpbmtzLCB0aGVyZSBpcyBhbiBhY3Rpb24gYnV0dG9uCiAgICAgICAgLy9XaGljaCBjYW5ub3QgYmUgY29udHJvbGxlZCBieSBGTFAgY29kZS4KICAgICAgICAvL0luIGNhc2Ugb2YgbGluaywgd2UgZmlyc3QgdHJ5IHRvIGFjY2VzcyB0aGUgIm1vcmUiIGJ1dHRvbiBhbmQgb3BlbiBhbiBhY3Rpb24gc2hlZXQgYnkgaXQuCiAgICAgICAgLy9PdGhlcndpc2UgdGhlIGFjdGlvbiBzaGVldCB3aWxsIG5vdCBiZSBsb2NhdGVkIHVuZGVyIHRoZSAibW9yZSIgYnV0dG9uIGFuZCBvdGhlciB3ZWlyZCB0aGluZ3Mgd2lsbCBoYXBwZW4uCiAgICAgICAgb0FjdGlvblNoZWV0VGFyZ2V0ID0gb0V2ZW50LmdldFNvdXJjZSgpLmdldEFjdGlvblNoZWV0SWNvbiA/IG9FdmVudC5nZXRTb3VyY2UoKS5nZXRBY3Rpb25TaGVldEljb24oKSA6IHVuZGVmaW5lZDsKICAgICAgICBpZiAoIW9BY3Rpb25TaGVldFRhcmdldCkgewogICAgICAgICAgICB2YXIgb01vcmVBY3Rpb24gPSBzYXAudWkuZ2V0Q29yZSgpLmJ5SWQob0V2ZW50LmdldFNvdXJjZSgpLmdldElkKCkgKyAiLWFjdGlvbi1tb3JlIik7CiAgICAgICAgICAgIGlmIChvTW9yZUFjdGlvbikgewogICAgICAgICAgICAgICAgb0FjdGlvblNoZWV0VGFyZ2V0ID0gb01vcmVBY3Rpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvQWN0aW9uU2hlZXRUYXJnZXQgPSBvRXZlbnQuZ2V0U291cmNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghb0FjdGlvblNoZWV0KSB7CiAgICAgICAgICAgIHNhcC51aS5yZXF1aXJlKFsic2FwL20vQWN0aW9uU2hlZXQiXSwgZnVuY3Rpb24gKEFjdGlvblNoZWV0KSB7CiAgICAgICAgICAgICAgICBvQWN0aW9uU2hlZXQgPSBuZXcgQWN0aW9uU2hlZXQoIlRpbGVBY3Rpb25zIiwgewogICAgICAgICAgICAgICAgICAgIHBsYWNlbWVudDogUGxhY2VtZW50VHlwZS5Cb3R0b20sCiAgICAgICAgICAgICAgICAgICAgYWZ0ZXJDbG9zZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkoIi5zYXBVc2hlbGxUaWxlQWN0aW9uTGF5ZXJEaXZTZWxlY3RlZCIpLnJlbW92ZUNsYXNzKCJzYXBVc2hlbGxUaWxlQWN0aW9uTGF5ZXJEaXZTZWxlY3RlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb0V2ZW50QnVzID0gc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpOwogICAgICAgICAgICAgICAgICAgICAgICBvRXZlbnRCdXMucHVibGlzaCgiZGFzaGJvYXJkIiwgImFjdGlvblNoZWV0Q2xvc2UiLCB0aGF0Lm9UaWxlQ29udHJvbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGF0Ll9vcGVuQWN0aW9uU2hlZXQob0FjdGlvblNoZWV0LCBhQWN0aW9uc0J1dHRvbnMsIG9BY3Rpb25TaGVldFRhcmdldCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoYXQuX29wZW5BY3Rpb25TaGVldChvQWN0aW9uU2hlZXQsIGFBY3Rpb25zQnV0dG9ucywgb0FjdGlvblNoZWV0VGFyZ2V0KTsKICAgICAgICB9CiAgICB9OwoKICAgIC8qCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIG9wZW4gdGhlIEFjdGlvbiBTaGVldCBvbiB0aGUgZ2l2ZW4gdGFyZ2V0IHdpdGggdGhlIHByb3ZpZGVkIGJ1dHRvbnMuCiAgICAgKi8KICAgIEFjdGlvbk1vZGUucHJvdG90eXBlLl9vcGVuQWN0aW9uU2hlZXQgPSBmdW5jdGlvbiAob0FjdGlvblNoZWV0LCBhQnV0dG9ucywgb1RhcmdldCkgewogICAgICAgIGFCdXR0b25zID0gYUJ1dHRvbnMgfHwgW107CiAgICAgICAgb0FjdGlvblNoZWV0LmRlc3Ryb3lCdXR0b25zKCk7CiAgICAgICAgYUJ1dHRvbnMuZm9yRWFjaChmdW5jdGlvbiAob0J1dHRvbikgewogICAgICAgICAgICBvQWN0aW9uU2hlZXQuYWRkQnV0dG9uKG9CdXR0b24pOwogICAgICAgIH0pOwogICAgICAgIG9BY3Rpb25TaGVldC5vcGVuQnkob1RhcmdldCk7CiAgICB9OwoKICAgIC8qKgogICAgICogUHJlc3MgaGFuZGxlciBvZiBhIGJ1dHRvbiAocmVwcmVzZW50aW5nIGEgc2luZ2xlIGFjdGlvbikgaW4gYSB0aWxlJ3MgYWN0aW9uIHNoZWV0CiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IG9BY3Rpb24gVGhlIGV2ZW50IG9iamVjdCBpbml0aWF0ZWQgYnkgdGhlIGNsaWNrIGFjdGlvbiBvbiBhbiBlbGVtZW50IGluIHRoZSB0aWxlJ3MgYWN0aW9uIHNoZWV0LgogICAgICogICBJbiBhZGRpdGlvbiB0byB0aGUgdGV4dCBhbmQgaWNvbiBwcm9wZXJ0aWVzLCBvQWN0aW9uIGNvbnRhaW5zIG9uZSBvZiB0aGUgZm9sbG93aW5nOgogICAgICogICAgIDEuIEEgInByZXNzIiBwcm9wZXJ0eSB0aGF0IGluY2x1ZGVzIGEgY2FsbGJhY2sgZnVuY3Rpb24uCiAgICAgKiAgICAgICAgSW4gdGhpcyBjYXNlIHRoZSBhY3Rpb24gKGNob3NlbiBieSB0aGUgdXNlcikgaXMgbGF1bmNoZWQgYnkgY2FsbGluZyB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkCiAgICAgKiAgICAgMi4gQSAidGFyZ2V0VXJsIiBwcm9wZXJ0eSB0aGF0IGluY2x1ZGVzIGVpdGhlciBhIGhhc2ggcGFydCBvZiBhIGZ1bGwgVVJMLgogICAgICogICAgICAgIEluIHRoaXMgY2FzZSB0aGUgYWN0aW9uIChjaG9zZW4gYnkgdGhlIHVzZXIpIGlzIGxhdW5jaGVkIGJ5IG5hdmlnYXRpbmcgdG8gdGhlIFVSTAogICAgICovCiAgICBBY3Rpb25Nb2RlLnByb3RvdHlwZS5faGFuZGxlQWN0aW9uUHJlc3MgPSBmdW5jdGlvbiAob0FjdGlvbiwgb1RpbGVDb250cm9sKSB7CiAgICAgICAgaWYgKG9BY3Rpb24ucHJlc3MpIHsKICAgICAgICAgICAgb0FjdGlvbi5wcmVzcy5jYWxsKG9BY3Rpb24sIG9UaWxlQ29udHJvbCk7CiAgICAgICAgfSBlbHNlIGlmIChvQWN0aW9uLnRhcmdldFVSTCkgewogICAgICAgICAgICBpZiAob0FjdGlvbi50YXJnZXRVUkwuaW5kZXhPZigiIyIpID09PSAwKSB7CiAgICAgICAgICAgICAgICBoYXNoZXIuc2V0SGFzaChvQWN0aW9uLnRhcmdldFVSTCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3aW5kb3cub3BlbihvQWN0aW9uLnRhcmdldFVSTCwgIl9ibGFuayIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2FwLnVpLnJlcXVpcmUoWwogICAgICAgICAgICAgICAgInNhcC9tL01lc3NhZ2VUb2FzdCIKICAgICAgICAgICAgXSwgZnVuY3Rpb24gKE1lc3NhZ2VUb2FzdCkgewogICAgICAgICAgICAgICAgTWVzc2FnZVRvYXN0LnNob3coIk5vIEFjdGlvbiIpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwoKICAgIHJldHVybiBuZXcgQWN0aW9uTW9kZSgpOwp9LCAvKiBiRXhwb3J0PSAqLyB0cnVlKTsKfSwKCSJzYXAvdXNoZWxsL2NvbXBvbmVudHMvaG9tZXBhZ2UvQ29tcG9uZW50LmpzIjpmdW5jdGlvbigpey8vICR7Y29weXJpZ2h0fQ0Kc2FwLnVpLmRlZmluZShbDQogICAgInNhcC91aS9jb3JlL1VJQ29tcG9uZW50IiwNCiAgICAic2FwL3VzaGVsbC9ib290c3RyYXAvY29tbW9uL2NvbW1vbi5sb2FkLm1vZGVsIiwNCiAgICAic2FwL3VzaGVsbC9jb21wb25lbnRzL0hvbWVwYWdlTWFuYWdlciIsDQogICAgInNhcC91c2hlbGwvY29tcG9uZW50cy9TaGFyZWRDb21wb25lbnRVdGlscyIsDQogICAgInNhcC91c2hlbGwvQ29uZmlnIiwNCiAgICAic2FwL3VzaGVsbC9yZXNvdXJjZXMiDQpdLCBmdW5jdGlvbiAoDQogICAgICAgIFVJQ29tcG9uZW50LA0KICAgICAgICBvTW9kZWxXcmFwcGVyLA0KICAgICAgICBIb21lcGFnZU1hbmFnZXIsDQogICAgICAgIG9TaGFyZWRDb21wb25lbnRVdGlscywNCiAgICAgICAgQ29uZmlnLA0KICAgICAgICByZXNvdXJjZXMNCikgew0KICAgICJ1c2Ugc3RyaWN0IjsNCg0KICAgIHJldHVybiBVSUNvbXBvbmVudC5leHRlbmQoInNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5Db21wb25lbnQiLCB7DQoNCiAgICAgICAgbWV0YWRhdGE6IHsNCiAgICAgICAgICAgIHZlcnNpb246ICIke3ZlcnNpb259IiwNCg0KICAgICAgICAgICAgbGlicmFyeTogInNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZSIsDQoNCiAgICAgICAgICAgIGRlcGVuZGVuY2llczogew0KICAgICAgICAgICAgICAgIGxpYnM6IFsic2FwLm0iXQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGNvbmZpZzogew0KICAgICAgICAgICAgICAgIHNlbWFudGljT2JqZWN0OiAiU2hlbGwiLA0KICAgICAgICAgICAgICAgIGFjdGlvbjogImhvbWUiLA0KICAgICAgICAgICAgICAgIHRpdGxlOiByZXNvdXJjZXMuaTE4bi5nZXRUZXh0KCJob21lQnRuX3Rvb2x0aXAiKSwNCiAgICAgICAgICAgICAgICBmdWxsV2lkdGg6IHRydWUsDQogICAgICAgICAgICAgICAgaGlkZUxpZ2h0QmFja2dyb3VuZDogdHJ1ZQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9LA0KDQogICAgICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIC8vIG1vZGVsIGluc3RhbnRpYXRlZCBieSB0aGUgbW9kZWwgd3JhcHBlcg0KICAgICAgICAgICAgdGhpcy5vTW9kZWwgPSBvTW9kZWxXcmFwcGVyLmdldE1vZGVsKCk7DQogICAgICAgICAgICB0aGlzLnNldE1vZGVsKHRoaXMub01vZGVsKTsNCg0KICAgICAgICAgICAgLy8gVGhpcyBuZWVkcyB0byBiZSBjYWxsZWQgX2FmdGVyXyB0aGUgbW9kZWwgaXMgY3JlYXRlZA0KICAgICAgICAgICAgVUlDb21wb25lbnQucHJvdG90eXBlLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsNCg0KICAgICAgICAgICAgLy8gVE9ETzogUGxlYXNlIHJlbW92ZSBhbGwgJ05ld0hvbWVwYWdlTWFuYWdlcicgcmVmZXJlbmNlcyBhZnRlciBjb21wbGV0ZSBhbGlnbm1lbnQhDQogICAgICAgICAgICB2YXIgb0Rhc2hib2FyZE1nckRhdGEgPSB7DQogICAgICAgICAgICAgICAgbW9kZWw6IHRoaXMub01vZGVsLA0KICAgICAgICAgICAgICAgIHZpZXc6IHRoaXMub0Rhc2hib2FyZFZpZXcNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICB0aGlzLm9Ib21lcGFnZU1hbmFnZXIgPSBuZXcgSG9tZXBhZ2VNYW5hZ2VyKCJkYXNoYm9hcmRNZ3IiLCBvRGFzaGJvYXJkTWdyRGF0YSk7DQoNCiAgICAgICAgICAgIHRoaXMuc2V0TW9kZWwocmVzb3VyY2VzLmkxOG5Nb2RlbCwgImkxOG4iKTsNCg0KICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZSgic2FwLnVzaGVsbC5zZXJ2aWNlcy5Vc2FnZUFuYWx5dGljcyIsICJ1c2FnZUFuYWx5dGljc1N0YXJ0ZWQiLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgc2FwLnVpLnJlcXVpcmUoWyJzYXAvdXNoZWxsL2NvbXBvbmVudHMvaG9tZXBhZ2UvRkxQQW5hbHl0aWNzIl0pOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIG9TaGFyZWRDb21wb25lbnRVdGlscy50b2dnbGVVc2VyQWN0aXZpdHlMb2coKTsNCg0KICAgICAgICAgICAgLy8gZG9uJ3QgdXNlIHRoZSByZXR1cm5lZCBwcm9taXNlIGJ1dCByZWdpc3RlciB0byB0aGUgY29uZmlnIGNoYW5nZQ0KICAgICAgICAgICAgLy8gZm9yIGZ1dHVyZSBjb25maWcgY2hhbmdlcw0KICAgICAgICAgICAgb1NoYXJlZENvbXBvbmVudFV0aWxzLmdldEVmZmVjdGl2ZUhvbWVwYWdlU2V0dGluZygiL2NvcmUvaG9tZS9ob21lUGFnZUdyb3VwRGlzcGxheSIsICIvY29yZS9ob21lL2VuYWJsZUhvbWVQYWdlU2V0dGluZ3MiKTsNCiAgICAgICAgICAgIENvbmZpZy5vbigiL2NvcmUvaG9tZS9ob21lUGFnZUdyb3VwRGlzcGxheSIpLmRvKGZ1bmN0aW9uIChzTmV3RGlzcGxheU1vZGUpIHsNCiAgICAgICAgICAgICAgICB0aGlzLm9Ib21lcGFnZU1hbmFnZXIuaGFuZGxlRGlzcGxheU1vZGVDaGFuZ2Uoc05ld0Rpc3BsYXlNb2RlKTsNCiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7DQoNCiAgICAgICAgICAgIG9TaGFyZWRDb21wb25lbnRVdGlscy5nZXRFZmZlY3RpdmVIb21lcGFnZVNldHRpbmcoIi9jb3JlL2hvbWUvc2l6ZUJlaGF2aW9yIiwgIi9jb3JlL2hvbWUvc2l6ZUJlaGF2aW9yQ29uZmlndXJhYmxlIik7DQogICAgICAgICAgICBDb25maWcub24oIi9jb3JlL2hvbWUvc2l6ZUJlaGF2aW9yIikuZG8oZnVuY3Rpb24gKHNTaXplQmVoYXZpb3IpIHsNCiAgICAgICAgICAgICAgICB2YXIgb01vZGVsID0gdGhpcy5vSG9tZXBhZ2VNYW5hZ2VyLmdldE1vZGVsKCk7DQoNCiAgICAgICAgICAgICAgICBvTW9kZWwuc2V0UHJvcGVydHkoIi9zaXplQmVoYXZpb3IiLCBzU2l6ZUJlaGF2aW9yKTsNCiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7DQogICAgICAgIH0sDQoNCiAgICAgICAgY3JlYXRlQ29udGVudDogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdGhpcy5vRGFzaGJvYXJkVmlldyA9IHNhcC51aS52aWV3KHsNCiAgICAgICAgICAgICAgICB2aWV3TmFtZTogInNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5EYXNoYm9hcmRDb250ZW50IiwNCiAgICAgICAgICAgICAgICB0eXBlOiAiSlMiLA0KICAgICAgICAgICAgICAgIGFzeW5jOiB0cnVlDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLm9EYXNoYm9hcmRWaWV3Ow0KICAgICAgICB9LA0KDQogICAgICAgIGV4aXQ6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHRoaXMub0hvbWVwYWdlTWFuYWdlci5kZXN0cm95KCk7DQogICAgICAgIH0NCiAgICB9KTsNCn0pOwp9LAoJInNhcC91c2hlbGwvY29tcG9uZW50cy9ob21lcGFnZS9EYXNoYm9hcmRDb250ZW50LmNvbnRyb2xsZXIuanMiOmZ1bmN0aW9uKCl7Ly8gJHtjb3B5cmlnaHR9CgpzYXAudWkuZGVmaW5lKFsKICAgICJzYXAvdWkvdGhpcmRwYXJ0eS9qcXVlcnkiLAogICAgIi4vRGFzaGJvYXJkVUlBY3Rpb25zIiwKICAgICJzYXAvdXNoZWxsL3V0aWxzIiwKICAgICJzYXAvdXNoZWxsL0V2ZW50SHViIiwKICAgICJzYXAvdWkvRGV2aWNlIiwKICAgICJzYXAvdXNoZWxsL3Jlc291cmNlcyIsCiAgICAic2FwL3VzaGVsbC9MYXlvdXQiLAogICAgInNhcC91aS9tb2RlbC9GaWx0ZXIiLAogICAgInNhcC91aS9tb2RlbC9GaWx0ZXJPcGVyYXRvciIsCiAgICAic2FwL2Jhc2UvTG9nIgpdLCBmdW5jdGlvbiAoCiAgICBqUXVlcnksCiAgICBEYXNoYm9hcmRVSUFjdGlvbnMsCiAgICB1dGlscywKICAgIEV2ZW50SHViLAogICAgRGV2aWNlLAogICAgcmVzb3VyY2VzLAogICAgTGF5b3V0LAogICAgRmlsdGVyLAogICAgRmlsdGVyT3BlcmF0b3IsCiAgICBMb2cKKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgc2FwLnVpLmNvbnRyb2xsZXIoInNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5EYXNoYm9hcmRDb250ZW50IiwgewogICAgICAgIG9uSW5pdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgb0V2ZW50QnVzID0gc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpOwogICAgICAgICAgICB0aGlzLmhhbmRsZURhc2hib2FyZFNjcm9sbCA9IHRoaXMuX2hhbmRsZURhc2hib2FyZFNjcm9sbC5iaW5kKHRoaXMpOwoKICAgICAgICAgICAgb0V2ZW50QnVzLnN1YnNjcmliZSgic2FwLnVzaGVsbCIsICJhcHBPcGVuZWQiLCB0aGlzLl9hcHBPcGVuZWRIYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgb0V2ZW50QnVzLnN1YnNjcmliZSgibGF1bmNocGFkIiwgImRhc2hib2FyZE1vZGVsQ29udGVudExvYWRlZCIsIHRoaXMuX21vZGVsTG9hZGVkLCB0aGlzKTsKICAgICAgICAgICAgb0V2ZW50QnVzLnN1YnNjcmliZSgibGF1bmNocGFkIiwgImFjdGlvbk1vZGVJbmFjdGl2ZSIsIHRoaXMuX2hhbmRsZUdyb3VwVmlzaWJpbGl0eUNoYW5nZXMsIHRoaXMpOwogICAgICAgICAgICBvRXZlbnRCdXMuc3Vic2NyaWJlKCJsYXVuY2hwYWQiLCAic3dpdGNoVGFiQmFySXRlbSIsIHRoaXMuX2hhbmRsZVRhYkJhckl0ZW1QcmVzc0V2ZW50SGFuZGxlciwgdGhpcyk7CgogICAgICAgICAgICAvL3doZW4gdGhlIGJyb3dzZXIgdGFiIGlzIGhpZGRlbiB3ZSB3YW50IHRvIHN0b3Agc2VuZGluZyByZXF1ZXN0cyBmcm9tIHRpbGVzCiAgICAgICAgICAgIHdpbmRvdy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgdXRpbHMuaGFuZGxlVGlsZXNWaXNpYmlsaXR5LCBmYWxzZSk7CgogICAgICAgICAgICAvL09uIEFuZHJvaWQgNC54LCBhbmQgU2FmYXJpIG1vYmlsZSBpbiBDaHJvbWUgYW5kIFNhZmFyaSBicm93c2VycyBzb21ldGltZXMgd2UgY2FuIHNlZSBidWcgd2l0aCBzY3JlZW4gcmVuZGVyaW5nCiAgICAgICAgICAgIC8vc28gX3dlYmtpdE1vYmlsZVJlbmRlckZpeCBmdW5jdGlvbiBtZWFudCB0byBmaXggaXQgYWZ0ZXIgIGBjb250ZW50UmVmcmVzaGAgZXZlbnQuCiAgICAgICAgICAgIGlmIChEZXZpY2UuYnJvd3Nlci5tb2JpbGUpIHsKICAgICAgICAgICAgICAgIG9FdmVudEJ1cy5zdWJzY3JpYmUoImxhdW5jaHBhZCIsICJjb250ZW50UmVmcmVzaCIsIHRoaXMuX3dlYmtpdE1vYmlsZVJlbmRlckZpeCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pc0Rlc2t0b3AgPSAoRGV2aWNlLnN5c3RlbS5kZXNrdG9wICYmIChuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZigidGFibGV0IikgPCAwKSk7CiAgICAgICAgfSwKCiAgICAgICAgb25FeGl0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBvRXZlbnRCdXMgPSBzYXAudWkuZ2V0Q29yZSgpLmdldEV2ZW50QnVzKCk7CiAgICAgICAgICAgIG9FdmVudEJ1cy51bnN1YnNjcmliZSgibGF1bmNocGFkIiwgImNvbnRlbnRSZWZyZXNoIiwgdGhpcy5fd2Via2l0TW9iaWxlUmVuZGVyRml4LCB0aGlzKTsKICAgICAgICAgICAgb0V2ZW50QnVzLnVuc3Vic2NyaWJlKCJzYXAudXNoZWxsIiwgImFwcE9wZW5lZCIsIHRoaXMuX2FwcE9wZW5lZEhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBvRXZlbnRCdXMudW5zdWJzY3JpYmUoImxhdW5jaHBhZCIsICJkYXNoYm9hcmRNb2RlbENvbnRlbnRMb2FkZWQiLCB0aGlzLl9tb2RlbExvYWRlZCwgdGhpcyk7CiAgICAgICAgICAgIG9FdmVudEJ1cy51bnN1YnNjcmliZSgibGF1bmNocGFkIiwgInN3aXRjaFRhYkJhckl0ZW0iLCB0aGlzLl9oYW5kbGVUYWJCYXJJdGVtUHJlc3NFdmVudEhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICB3aW5kb3cuZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigidmlzaWJpbGl0eWNoYW5nZSIsIHV0aWxzLmhhbmRsZVRpbGVzVmlzaWJpbGl0eSwgZmFsc2UpOwogICAgICAgICAgICBpZiAodGhpcy5vRGFzaGJvYXJkVUlBY3Rpb25zTW9kdWxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9EYXNoYm9hcmRVSUFjdGlvbnNNb2R1bGUuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMub0Rhc2hib2FyZFVJQWN0aW9uc01vZHVsZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG9uQWZ0ZXJSZW5kZXJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdXRpbHMuc2V0UGVyZm9ybWFuY2VNYXJrKCJGTFAgLSBkYXNoYm9hcmQgYWZ0ZXIgcmVuZGVyaW5nIik7CgogICAgICAgICAgICB2YXIgb0hvbWVwYWdlTWFuYWdlciA9IHNhcC51c2hlbGwuY29tcG9uZW50cy5nZXRIb21lcGFnZU1hbmFnZXIoKTsKICAgICAgICAgICAgaWYgKCFvSG9tZXBhZ2VNYW5hZ2VyLmdldFByZXBhcmVkR3JvdXBNb2RlbCgpKSB7CiAgICAgICAgICAgICAgICBvSG9tZXBhZ2VNYW5hZ2VyLmxvYWRQZXJzb25hbGl6ZWRHcm91cHMoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIEV2ZW50SHViLm9uY2UoImZpcnN0U2VnbWVudENvbXBsZXRlTG9hZGVkIikuZG8ob0hvbWVwYWdlTWFuYWdlci5oYW5kbGVGaXJzdFNlZ21lbnRMb2FkZWQuYmluZChvSG9tZXBhZ2VNYW5hZ2VyKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBvRXZlbnRCdXMgPSBzYXAudWkuZ2V0Q29yZSgpLmdldEV2ZW50QnVzKCksCiAgICAgICAgICAgICAgICBvTW9kZWwsCiAgICAgICAgICAgICAgICB0b3BWaWV3UG9ydEdyb3VwSW5kZXgsCiAgICAgICAgICAgICAgICBvR3JvdXAsCiAgICAgICAgICAgICAgICBiSXNJbkVkaXRUaXRsZSwKICAgICAgICAgICAgICAgIHRpbWVyOwoKICAgICAgICAgICAgLy9CaW5kIGxhdW5jaHBhZCBldmVudCBoYW5kbGVycwogICAgICAgICAgICBvRXZlbnRCdXMudW5zdWJzY3JpYmUoImxhdW5jaHBhZCIsICJzY3JvbGxUb0dyb3VwIiwgdGhpcy5fc2Nyb2xsVG9Hcm91cCwgdGhpcyk7CiAgICAgICAgICAgIG9FdmVudEJ1cy51bnN1YnNjcmliZSgibGF1bmNocGFkIiwgInNjcm9sbFRvR3JvdXBCeU5hbWUiLCB0aGlzLl9zY3JvbGxUb0dyb3VwQnlOYW1lLCB0aGlzKTsKICAgICAgICAgICAgb0V2ZW50QnVzLnN1YnNjcmliZSgibGF1bmNocGFkIiwgInNjcm9sbFRvR3JvdXAiLCB0aGlzLl9zY3JvbGxUb0dyb3VwLCB0aGlzKTsKICAgICAgICAgICAgb0V2ZW50QnVzLnN1YnNjcmliZSgibGF1bmNocGFkIiwgInNjcm9sbFRvR3JvdXBCeU5hbWUiLCB0aGlzLl9zY3JvbGxUb0dyb3VwQnlOYW1lLCB0aGlzKTsKCiAgICAgICAgICAgIERldmljZS5vcmllbnRhdGlvbi5hdHRhY2hIYW5kbGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBqcVRpbGVDb250YWluZXJzID0galF1ZXJ5KCIjZGFzaGJvYXJkR3JvdXBzIikuZmluZCgiLnNhcFVzaGVsbFRpbGVDb250YWluZXIiKS5maWx0ZXIoIjp2aXNpYmxlIik7CiAgICAgICAgICAgICAgICBpZiAoanFUaWxlQ29udGFpbmVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBvTW9kZWwgPSB0aGlzLmdldFZpZXcoKS5nZXRNb2RlbCgpOwogICAgICAgICAgICAgICAgICAgIHRvcFZpZXdQb3J0R3JvdXBJbmRleCA9IG9Nb2RlbC5nZXRQcm9wZXJ0eSgiL3RvcEdyb3VwSW5WaWV3UG9ydEluZGV4Iik7CgogICAgICAgICAgICAgICAgICAgIGlmIChqcVRpbGVDb250YWluZXJzLmdldCh0b3BWaWV3UG9ydEdyb3VwSW5kZXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9Hcm91cCA9IHNhcC51aS5nZXRDb3JlKCkuYnlJZChqcVRpbGVDb250YWluZXJzLmdldCh0b3BWaWV3UG9ydEdyb3VwSW5kZXgpLmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgYklzSW5FZGl0VGl0bGUgPSBvTW9kZWwuZ2V0UHJvcGVydHkoIi9lZGl0VGl0bGUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHVibGlzaEFzeW5jKCJsYXVuY2hwYWQiLCAic2Nyb2xsVG9Hcm91cCIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwOiBvR3JvdXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0luRWRpdFRpdGxlOiBiSXNJbkVkaXRUaXRsZQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAgICAgalF1ZXJ5KHdpbmRvdykuYmluZCgicmVzaXplIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgICAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dCh0aGlzLnJlc2l6ZUhhbmRsZXIuYmluZCh0aGlzKSwgMzAwKTsKICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTsKCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRvcEdyb3VwSW5Nb2RlbCgpOwogICAgICAgIH0sCgogICAgICAgIF9kYXNoYm9hcmREZWxldGVUaWxlSGFuZGxlcjogZnVuY3Rpb24gKG9FdmVudCkgewogICAgICAgICAgICB2YXIgb1RpbGVDb250cm9sID0gb0V2ZW50LmdldFNvdXJjZSgpLAogICAgICAgICAgICAgICAgb1RpbGVNb2RlbCA9IG9UaWxlQ29udHJvbC5nZXRCaW5kaW5nQ29udGV4dCgpLmdldE9iamVjdCgpLAogICAgICAgICAgICAgICAgb0RhdGEgPSB7IHRpbGVJZDogb1RpbGVNb2RlbC51dWlkIH07CiAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS5wdWJsaXNoKCJsYXVuY2hwYWQiLCAiZGVsZXRlVGlsZSIsIG9EYXRhLCB0aGlzKTsKICAgICAgICB9LAoKICAgICAgICBkYXNoYm9hcmRUaWxlUHJlc3M6IGZ1bmN0aW9uIChvRXZlbnQpIHsKICAgICAgICAgICAgdmFyIG9UaWxlQ29udHJvbCA9IG9FdmVudC5nZXRTb3VyY2UoKTsKICAgICAgICAgICAgaWYgKCFvVGlsZUNvbnRyb2wpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2V0IGZvY3VzIG9uIHRpbGUgdXBvbiBjbGlja2luZyBvbiB0aGUgdGlsZSBvbiBhIGRlc2t0b3AKICAgICAgICAgICAgLy8gVW5sZXNzIHRoZXJlIGlzIGFuIGlucHV0IGVsZW1lbnQgaW5zaWRlIHRpbGUsIG9yIHRpbGUgaXMgc2xpZGUgdGlsZSB0aGVuIGxlYXZlIHRoZSBmb2N1cyBvbiBpdAogICAgICAgICAgICBpZiAoRGV2aWNlLnN5c3RlbS5kZXNrdG9wKSB7CiAgICAgICAgICAgICAgICB2YXIgYlNsaWRlVGlsZSA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQuaWQuaW5kZXhPZigiZmVlZFRpbGUiKSAhPT0gLTE7CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudC50YWdOYW1lICE9PSAiSU5QVVQiICYmIGJTbGlkZVRpbGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2FwLnVpLmdldENvcmUoKS5ieUlkKG9UaWxlQ29udHJvbC5nZXRJZCgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzYXAudXNoZWxsLmNvbXBvbmVudHMuQ29tcG9uZW50S2V5c0hhbmRsZXIuc2V0VGlsZUZvY3VzKG9UaWxlQ29udHJvbC4kKCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLnB1Ymxpc2goImxhdW5jaHBhZCIsICJkYXNoYm9hcmRUaWxlQ2xpY2siLCB7IHV1aWQ6IG9UaWxlQ29udHJvbC5nZXRVdWlkKCkgfSk7CiAgICAgICAgfSwKCiAgICAgICAgX3VwZGF0ZVRvcEdyb3VwSW5Nb2RlbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgb01vZGVsID0gdGhpcy5nZXRWaWV3KCkuZ2V0TW9kZWwoKSwKICAgICAgICAgICAgICAgIHRvcFZpZXdQb3J0R3JvdXBJbmRleCA9IHRoaXMuX2dldEluZGV4T2ZUb3BHcm91cEluVmlld1BvcnQoKTsKCiAgICAgICAgICAgIHZhciBpU2VsZWN0ZWRHcm91cEluTW9kZWwgPSB0aGlzLl9nZXRNb2RlbEdyb3VwRnJvbVZpc2libGVJbmRleCh0b3BWaWV3UG9ydEdyb3VwSW5kZXgpOwoKICAgICAgICAgICAgb01vZGVsLnNldFByb3BlcnR5KCIvaVNlbGVjdGVkR3JvdXAiLCBpU2VsZWN0ZWRHcm91cEluTW9kZWwpOwogICAgICAgICAgICBvTW9kZWwuc2V0UHJvcGVydHkoIi90b3BHcm91cEluVmlld1BvcnRJbmRleCIsIHRvcFZpZXdQb3J0R3JvdXBJbmRleCk7CiAgICAgICAgfSwKCiAgICAgICAgX2dldEluZGV4T2ZUb3BHcm91cEluVmlld1BvcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG9WaWV3ID0gdGhpcy5nZXRWaWV3KCksCiAgICAgICAgICAgICAgICBvRG9tUmVmID0gb1ZpZXcuZ2V0RG9tUmVmKCksCiAgICAgICAgICAgICAgICBvU2Nyb2xsYWJsZUVsZW1lbnQgPSBvRG9tUmVmLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJzZWN0aW9uIiksCiAgICAgICAgICAgICAgICBqcVRpbGVDb250YWluZXJzID0galF1ZXJ5KG9TY3JvbGxhYmxlRWxlbWVudCkuZmluZCgiLnNhcFVzaGVsbFRpbGVDb250YWluZXIiKSwKICAgICAgICAgICAgICAgIG9PZmZzZXQgPSBqcVRpbGVDb250YWluZXJzLm5vdCgiLnNhcFVzaGVsbEhpZGRlbiIpLmVxKDApLm9mZnNldCgpLAogICAgICAgICAgICAgICAgZmlyc3RDb250YWluZXJPZmZzZXQgPSAob09mZnNldCAmJiBvT2Zmc2V0LnRvcCkgfHwgMCwKICAgICAgICAgICAgICAgIGFUaWxlQ29udGFpbmVyc1RvcEFuZEJvdHRvbXMgPSBbXSwKICAgICAgICAgICAgICAgIG5TY3JvbGxUb3AgPSBvU2Nyb2xsYWJsZUVsZW1lbnRbMF0uc2Nyb2xsVG9wLAogICAgICAgICAgICAgICAgdG9wR3JvdXBJbmRleCA9IDA7CgogICAgICAgICAgICAvLyBJbiBzb21lIHdlaXJkIGNvcm5lciBjYXNlcywgdGhvc2UgbWF5IG5vdCBiZSBkZWZpbmVkIC0+IGJhaWwgb3V0LgogICAgICAgICAgICBpZiAoIWpxVGlsZUNvbnRhaW5lcnMgfHwgIW9PZmZzZXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b3BHcm91cEluZGV4OwogICAgICAgICAgICB9CgogICAgICAgICAgICBqcVRpbGVDb250YWluZXJzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCFqUXVlcnkodGhpcykuaGFzQ2xhc3MoInNhcFVzaGVsbEhpZGRlbiIpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5Db250YWluZXJUb3BQb3MgPSBqUXVlcnkodGhpcykucGFyZW50KCkub2Zmc2V0KCkudG9wOwogICAgICAgICAgICAgICAgICAgIGFUaWxlQ29udGFpbmVyc1RvcEFuZEJvdHRvbXMucHVzaChbbkNvbnRhaW5lclRvcFBvcywgbkNvbnRhaW5lclRvcFBvcyArIGpRdWVyeSh0aGlzKS5wYXJlbnQoKS5oZWlnaHQoKV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIHZpZXdQb3J0VG9wID0gblNjcm9sbFRvcCArIGZpcnN0Q29udGFpbmVyT2Zmc2V0OwoKICAgICAgICAgICAgalF1ZXJ5LmVhY2goYVRpbGVDb250YWluZXJzVG9wQW5kQm90dG9tcywgZnVuY3Rpb24gKGluZGV4LCBjdXJyZW50VGlsZUNvbnRhaW5lclRvcEFuZEJvdHRvbSkgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUaWxlQ29udGFpbmVyVG9wID0gY3VycmVudFRpbGVDb250YWluZXJUb3BBbmRCb3R0b21bMF0sCiAgICAgICAgICAgICAgICAgICAgY3VycmVudFRpbGVDb250YWluZXJCb3R0b20gPSBjdXJyZW50VGlsZUNvbnRhaW5lclRvcEFuZEJvdHRvbVsxXTsKCiAgICAgICAgICAgICAgICAvLycyNCcgcmVmZXJzIHRvIHRoZSBoaWdodCBkZWNyZW1lbnRhdGlvbiBvZiB0aGUgcHJldmlvdXMgVGlsZUNvbnRhaW5lciB0byBpbXByb3ZlIHRoZSBzeW5jIGJldHdlZW4gdGhlICB0b3AgZ3JvdXAgaW4gdGhlIHZpZXdwb3J0IGFuZCB0aGUgIHNlbGVjdGVkIGdyb3VwIGluIHRoZSBhbmNob3IgYmFyLgogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUaWxlQ29udGFpbmVyVG9wIC0gMjQgPD0gdmlld1BvcnRUb3AgJiYgdmlld1BvcnRUb3AgPD0gY3VycmVudFRpbGVDb250YWluZXJCb3R0b20pIHsKICAgICAgICAgICAgICAgICAgICB0b3BHcm91cEluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRvcEdyb3VwSW5kZXg7CiAgICAgICAgfSwKCiAgICAgICAgX2hhbmRsZURhc2hib2FyZFNjcm9sbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgb1ZpZXcgPSB0aGlzLmdldFZpZXcoKSwKICAgICAgICAgICAgICAgIG9Nb2RlbCA9IG9WaWV3LmdldE1vZGVsKCksCiAgICAgICAgICAgICAgICBuRGVsYXkgPSA0MDA7CgogICAgICAgICAgICB2YXIgc0hvbWVQYWdlR3JvdXBEaXNwbGF5ID0gb01vZGVsLmdldFByb3BlcnR5KCIvaG9tZVBhZ2VHcm91cERpc3BsYXkiKSwKICAgICAgICAgICAgICAgIGJFbmFibGVBbmNob3JCYXIgPSBzSG9tZVBhZ2VHcm91cERpc3BsYXkgIT09ICJ0YWJzIiwKICAgICAgICAgICAgICAgIGJUaWxlQWN0aW9uTW9kZUFjdGl2ZSA9IG9Nb2RlbC5nZXRQcm9wZXJ0eSgiL3RpbGVBY3Rpb25Nb2RlQWN0aXZlIik7CgogICAgICAgICAgICAvLyBXZSB3YW50IHRvIHNldCB0aWxlcyB2aXNpYmlsaXR5IG9ubHkgYWZ0ZXIgdGhlIHVzZXIgZmluaXNoZWQgdGhlIHNjcm9sbGluZy4KICAgICAgICAgICAgLy8gSW4gSUUgdGhpcyBldmVudCBpcyB0aHJvd24gYWxzbyBhZnRlciBzY3JvbGwgZGlyZWN0aW9uIGNoYW5nZSwgc28gd2Ugd2FpdCAxIHNlY29uZCB0bwogICAgICAgICAgICAvLyBkZXRlcm1pbmUgd2hldGhlciBzY3JvbGxpbmcgd2FzIGVuZGVkIGNvbXBsZXRlbHkgb3Igbm90CiAgICAgICAgICAgIGZ1bmN0aW9uIGZIYW5kbGVUaWxlc1Zpc2liaWxpdHkgKCkgewogICAgICAgICAgICAgICAgdXRpbHMuaGFuZGxlVGlsZXNWaXNpYmlsaXR5KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dElkKTsKICAgICAgICAgICAgdGhpcy50aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZIYW5kbGVUaWxlc1Zpc2liaWxpdHksIG5EZWxheSk7CgogICAgICAgICAgICBpZiAoIURldmljZS5zeXN0ZW0ucGhvbmUpIHsKICAgICAgICAgICAgICAgIC8vY2xvc2UgYW5jaG9yIHBvcG92ZXIgaWYgaXQgaXMgb3BlbgogICAgICAgICAgICAgICAgb1ZpZXcub0FuY2hvck5hdmlnYXRpb25CYXIuY2xvc2VPdmVyZmxvd1BvcHVwKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiRW5hYmxlQW5jaG9yQmFyIHx8IGJUaWxlQWN0aW9uTW9kZUFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVG9wR3JvdXBJbk1vZGVsKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vdXBkYXRlIGFuY2hvciBuYXZpZ2F0aW9uIGJhcgogICAgICAgICAgICBvVmlldy5vQW5jaG9yTmF2aWdhdGlvbkJhci5yZUFycmFuZ2VOYXZpZ2F0aW9uQmFyRWxlbWVudHMoKTsKICAgICAgICB9LAoKICAgICAgICAvL0RlbGV0ZSBvciBSZXNldCBhIGdpdmVuIGdyb3VwIGFjY29yZGluZyB0byB0aGUgcmVtb3ZhYmxlIHN0YXRlLgogICAgICAgIF9oYW5kbGVHcm91cERlbGV0aW9uOiBmdW5jdGlvbiAob0dyb3VwQmluZGluZ0N0eCkgewogICAgICAgICAgICB2YXIgb0V2ZW50QnVzID0gc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLAogICAgICAgICAgICAgICAgb0dyb3VwID0gb0dyb3VwQmluZGluZ0N0eC5nZXRPYmplY3QoKSwKICAgICAgICAgICAgICAgIGJJc0dyb3VwUmVtb3ZhYmxlID0gb0dyb3VwLnJlbW92YWJsZSwKICAgICAgICAgICAgICAgIHNHcm91cFRpdGxlID0gb0dyb3VwLnRpdGxlLAogICAgICAgICAgICAgICAgc0dyb3VwSWQgPSBvR3JvdXAuZ3JvdXBJZCwKICAgICAgICAgICAgICAgIG9SZXNvdXJjZUJ1bmRsZSA9IHJlc291cmNlcy5pMThuLAogICAgICAgICAgICAgICAgb01lc3NhZ2VTcnZjID0gc2FwLnVzaGVsbC5Db250YWluZXIuZ2V0U2VydmljZSgiTWVzc2FnZSIpLAogICAgICAgICAgICAgICAgbUFjdGlvbnMsCiAgICAgICAgICAgICAgICBtQ3VycmVudEFjdGlvbiwKICAgICAgICAgICAgICAgIG9WaWV3ID0gdGhpcy5nZXRWaWV3KCk7CgogICAgICAgICAgICBzYXAudWkucmVxdWlyZShbInNhcC9tL01lc3NhZ2VCb3giXSwgZnVuY3Rpb24gKE1lc3NhZ2VCb3gpIHsKICAgICAgICAgICAgICAgIG1BY3Rpb25zID0gTWVzc2FnZUJveC5BY3Rpb247CiAgICAgICAgICAgICAgICBtQ3VycmVudEFjdGlvbiA9IChiSXNHcm91cFJlbW92YWJsZSA/IG1BY3Rpb25zLkRFTEVURSA6IG9SZXNvdXJjZUJ1bmRsZS5nZXRUZXh0KCJSZXNldEdyb3VwQnRuIikpOwogICAgICAgICAgICAgICAgb01lc3NhZ2VTcnZjLmNvbmZpcm0ob1Jlc291cmNlQnVuZGxlLmdldFRleHQoYklzR3JvdXBSZW1vdmFibGUgPyAiZGVsZXRlX2dyb3VwX21zZyIgOiAicmVzZXRfZ3JvdXBfbXNnIiwgc0dyb3VwVGl0bGUpLCBmdW5jdGlvbiAob0FjdGlvbikgewogICAgICAgICAgICAgICAgICAgIGlmIChvQWN0aW9uID09PSBtQ3VycmVudEFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBvRXZlbnRCdXMucHVibGlzaCgibGF1bmNocGFkIiwgYklzR3JvdXBSZW1vdmFibGUgPyAiZGVsZXRlR3JvdXAiIDogInJlc2V0R3JvdXAiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cElkOiBzR3JvdXBJZAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBvUmVzb3VyY2VCdW5kbGUuZ2V0VGV4dChiSXNHcm91cFJlbW92YWJsZSA/ICJkZWxldGVfZ3JvdXAiIDogInJlc2V0X2dyb3VwIiksIFttQ3VycmVudEFjdGlvbiwgbUFjdGlvbnMuQ0FOQ0VMXSk7CiAgICAgICAgICAgICAgICBvVmlldy5vQW5jaG9yTmF2aWdhdGlvbkJhci51cGRhdGVWaXNpYmlsaXR5KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIF9tb2RlbExvYWRlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLmJNb2RlbEluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgc2FwLnVzaGVsbC5MYXlvdXQuZ2V0SW5pdFByb21pc2UoKS50aGVuKGZ1bmN0aW9uICgpIHsgLy8gVE9ETzogcGVuZGluZyBkZXBlbmRlbmN5IG1pZ3JhdGlvbgogICAgICAgICAgICAgICAgdGhpcy5faW5pdGlhbGl6ZVVJQWN0aW9ucygpOwogICAgICAgICAgICB9LmJpbmQodGhpcykpOwogICAgICAgIH0sCgogICAgICAgIF9pbml0aWFsaXplVUlBY3Rpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5vRGFzaGJvYXJkVUlBY3Rpb25zTW9kdWxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9EYXNoYm9hcmRVSUFjdGlvbnNNb2R1bGUgPSBuZXcgRGFzaGJvYXJkVUlBY3Rpb25zKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5vRGFzaGJvYXJkVUlBY3Rpb25zTW9kdWxlLmluaXRpYWxpemVVSUFjdGlvbnModGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgLy9mb3JjZSBicm93c2VyIHRvIHJlcGFpbnQgQm9keSwgYnkgc2V0dGluZyBpdCBgZGlzcGxheWAgcHJvcGVydHkgdG8gJ25vbmUnIGFuZCB0byAnYmxvY2snIGFnYWluCiAgICAgICAgX2ZvcmNlQnJvd3NlclJlcmVuZGVyRWxlbWVudDogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGFuaW1hdGlvbkZyYW1lID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCB3aW5kb3cud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lOwogICAgICAgICAgICBpZiAoYW5pbWF0aW9uRnJhbWUpIHsKICAgICAgICAgICAgICAgIGFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGlzcGxheSA9IGVsZW1lbnQuc3R5bGUuZGlzcGxheTsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgTG9nLmluZm8oInVuc3VwcG9ydGVkIGJyb3dzZXIgZm9yIGFuaW1hdGlvbiBmcmFtZSIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy9mdW5jdGlvbiBmaXhlcyBBbmRyb2lkIDQueCBDaHJvbWUsIGFuZCBTYWZhcmkgYnVnIHdpdGggcG9vciByZW5kZXJpbmcKICAgICAgICBfd2Via2l0TW9iaWxlUmVuZGVyRml4OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vZm9yY2UgQ2hyb21lIHRvIHJlcGFpbnQgQm9keSwgYnkgc2V0dGluZyBpdCBgZGlzcGxheWAgcHJvcGVydHkgdG8gJ25vbmUnIGFuZCB0byAnYmxvY2snIGFnYWluCiAgICAgICAgICAgIGlmIChEZXZpY2UuYnJvd3Nlci5jaHJvbWUgfHwgRGV2aWNlLm9zLmFuZHJvaWQpIHsKICAgICAgICAgICAgICAgIC8vIHRoaXMgaW5jbHVkZXMgYWxtb3N0IGFsbCBicm93c2VycyBhbmQgZGV2aWNlcwogICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBpcyB0aGUgSU9TNiAoYXMgdGhlIHByZXZpb3VzIGZpeCBjYXVzZXMgZG91YmxlIGZsaWNrZXJpbmcKICAgICAgICAgICAgICAgIC8vIGFuZCB0aGlzIG9uZSBvbmx5IG9uZSBmbGlja2VyaW5nKQogICAgICAgICAgICAgICAgdGhpcy5fZm9yY2VCcm93c2VyUmVyZW5kZXJFbGVtZW50KGRvY3VtZW50LmJvZHkpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcmVzaXplSGFuZGxlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB1dGlscy5yZWNhbGN1bGF0ZUJvdHRvbVNwYWNlKCk7CiAgICAgICAgICAgIHV0aWxzLmhhbmRsZVRpbGVzVmlzaWJpbGl0eSgpOwoKICAgICAgICAgICAgLy8gInJlc2V0IiB0aGUgYXBwUmVuZGVyZWQgZXZlbnQgaW4gY2FzZSB0aGUgdXNlciB3YW50cyB0byBuYXZpZ2F0ZSBiYWNrIHRvIHRoZSBzYW1lIGFwcC4KICAgICAgICAgICAgaWYgKEV2ZW50SHViLmxhc3QoIkFwcFJlbmRlcmVkIikgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgRXZlbnRIdWIuZW1pdCgiQXBwUmVuZGVyZWQiLCB1bmRlZmluZWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBMYXlvdXQgY2FsY3VsYXRpb24gaXMgcmVsZXZhbnQgb25seSB3aGVuIHRoZSBkYXNoYm9hcmQgaXMgcHJlc2VudGVkCiAgICAgICAgICAgIGlmIChMYXlvdXQgJiYgalF1ZXJ5KCIjZGFzaGJvYXJkR3JvdXBzIikuaXMoIjp2aXNpYmxlIikpIHsKICAgICAgICAgICAgICAgIExheW91dC5yZVJlbmRlckdyb3Vwc0xheW91dChudWxsKTsKICAgICAgICAgICAgICAgIHRoaXMuX2luaXRpYWxpemVVSUFjdGlvbnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9hcHBPcGVuZWRIYW5kbGVyOiBmdW5jdGlvbiAoc0NoYW5uZWxJZCwgc0V2ZW50SWQsIG9EYXRhKSB7CiAgICAgICAgICAgIHZhciBvUGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICAgICAgc1BhcmVudE5hbWUsCiAgICAgICAgICAgICAgICBvTW9kZWwgPSB0aGlzLmdldFZpZXcoKS5nZXRNb2RlbCgpOwoKICAgICAgICAgICAgLy8gY2hlY2tpbmcgaWYgYXBwbGljYXRpb24gY29tcG9uZW50IG9wZW5lZCBpcyBub3QgdGhlIEZMUCBBcHAgQ29tcG9uZW50IChlLmcuIG5hdmlnYXRpb24gdG8gYW4gYXBwLCBub3QgJ0hvbWUnKQogICAgICAgICAgICAvLyBjYWxsIHRvIHNldCBhbGwgdGlsZXMgdmlzaWJpbGl0eSBvZmYgKHNvIG5vIHRpbGUgY2FsbHMgd2lsbCBydW4gaW4gdGhlIGJhY2tncm91bmQpCiAgICAgICAgICAgIG9QYXJlbnRDb21wb25lbnQgPSB0aGlzLmdldE93bmVyQ29tcG9uZW50KCk7CiAgICAgICAgICAgIHNQYXJlbnROYW1lID0gb1BhcmVudENvbXBvbmVudC5nZXRNZXRhZGF0YSgpLmdldENvbXBvbmVudE5hbWUoKTsKICAgICAgICAgICAgaWYgKG9EYXRhLmFkZGl0aW9uYWxJbmZvcm1hdGlvbiAmJiBvRGF0YS5hZGRpdGlvbmFsSW5mb3JtYXRpb24uaW5kZXhPZihzUGFyZW50TmFtZSkgPT09IC0xKSB7CiAgICAgICAgICAgICAgICB1dGlscy5zZXRUaWxlc05vVmlzaWJpbGl0eSgpOyAvLyBzZXR0aW5nIG5vIHZpc2liaWxpdHkgb24gYWxsIHZpc2libGUgdGlsZXMKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaW4gYSBkaXJlY3QgbmF2aWdhdGlvbiBzY2VuYXJpbyB0aGUgQWN0aW9uTW9kZSBtaWdodCBub3QgZXhpc3QgeWV0LgogICAgICAgICAgICAvLyBJbiB0aGlzIGNhc2Ugd2Ugd291bGQgbGlrZSB0byBza2lwIHRoaXMgY2hlY2suCgogICAgICAgICAgICBpZiAob01vZGVsLmdldFByb3BlcnR5KCIvdGlsZUFjdGlvbk1vZGVBY3RpdmUiKSAmJiBzYXAudXNoZWxsLmNvbXBvbmVudHMuaG9tZXBhZ2UuQWN0aW9uTW9kZSkgewogICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLkFjdGlvbk1vZGUudG9nZ2xlQWN0aW9uTW9kZShvTW9kZWwsICJNZW51IEl0ZW0iKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMub0Rhc2hib2FyZFVJQWN0aW9uc01vZHVsZSkgewogICAgICAgICAgICAgICAgdGhpcy5vRGFzaGJvYXJkVUlBY3Rpb25zTW9kdWxlLmRpc2FibGVBbGxEYXNoYm9hcmRVaUFjdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2Nyb2xsaW5nIHRoZSBkYXNoYm9hcmQgYWNjb3JkaW5nIHRvIGdyb3VwIG5hbWUsIGluIG9yZGVyIHRvIHNob3cgYSBkZXNpcmVkIGdyb3VwCiAgICAgICAgICovCiAgICAgICAgX3Njcm9sbFRvR3JvdXBCeU5hbWU6IGZ1bmN0aW9uIChzQ2hhbm5lbElkLCBzRXZlbnRJZCwgb0RhdGEpIHsKICAgICAgICAgICAgdmFyIGFHcm91cHMgPSB0aGlzLmdldFZpZXcoKS5nZXRNb2RlbCgpLmdldFByb3BlcnR5KCIvZ3JvdXBzIiksCiAgICAgICAgICAgICAgICBzR3JvdXBOYW1lID0gb0RhdGEuZ3JvdXBOYW1lLAogICAgICAgICAgICAgICAgb0xhdW5jaFBhZ2VTcnYgPSBzYXAudXNoZWxsLkNvbnRhaW5lci5nZXRTZXJ2aWNlKCJMYXVuY2hQYWdlIik7CgogICAgICAgICAgICBhR3JvdXBzLmZvckVhY2goZnVuY3Rpb24gKG9Hcm91cCkgewogICAgICAgICAgICAgICAgaWYgKG9MYXVuY2hQYWdlU3J2LmdldEdyb3VwVGl0bGUob0dyb3VwLm9iamVjdCkgPT09IHNHcm91cE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zY3JvbGxUb0dyb3VwKHNDaGFubmVsSWQsIHNFdmVudElkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSWQ6IG9Hcm91cC5ncm91cElkCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2Nyb2xsaW5nIHRoZSBkYXNoYm9hcmQgaW4gb3JkZXIgdG8gc2hvdyBhIGRlc2lyZWQgZ3JvdXAKICAgICAgICAgKi8KICAgICAgICBfc2Nyb2xsVG9Hcm91cDogZnVuY3Rpb24gKHNDaGFubmVsSWQsIHNFdmVudElkLCBvRGF0YSkgewogICAgICAgICAgICAvLyBkb24ndCBkaXNwbGF5IGdyb3VwIGhlYWRlciBhZnRlciBzY3JvbGwgaW4gbm9uIGVkaXQgbW9kZS4gR3JvdXAgaGVhZGVyIHdpbGwgYmUgdmlzaWJsZSBpbiB0aGUgYW5jaG9yIGJhcgogICAgICAgICAgICAvLyBjaGVjayBpZiBncm91cCBoZWFkZXIgaXMgdmlzaWJsZSwgYW5kIG9ubHkgdGhlbiBzY3JvbGwgYWRkaXRpb25hbCAzcmVtIHRvIGhpZGUgaXQKICAgICAgICAgICAgLy8gaW4gZWRpdCBtb2RlIGhpZGUgdGhlIGJlZm9yZSBjb250ZW50ICsgMC41cmVtIHBhZGRpbmcKICAgICAgICAgICAgdmFyIHNHcm91cElkID0gb0RhdGEuZ3JvdXAgPyBvRGF0YS5ncm91cC5nZXRHcm91cElkKCkgOiBvRGF0YS5ncm91cElkOwogICAgICAgICAgICB2YXIgb0dyb3VwOwoKICAgICAgICAgICAgaWYgKHRoaXMub1ZpZXcub0Rhc2hib2FyZEdyb3Vwc0JveC5nZXRHcm91cHMoKSkgewogICAgICAgICAgICAgICAgLy8gQ2FsbGluZyBhZ2FpbiBnZXRHcm91cHMoKSBiZWNhdXNlIG9mIHRoZSBsYXp5IGxvYWRpbmcgbWVjaGFuaXNtCiAgICAgICAgICAgICAgICBvR3JvdXAgPSB0aGlzLm9WaWV3Lm9EYXNoYm9hcmRHcm91cHNCb3guZ2V0R3JvdXBzKCkucmVkdWNlKGZ1bmN0aW9uIChyZXN1bHQsIGdyb3VwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdyb3VwICYmIGdyb3VwLmdldEdyb3VwSWQoKSA9PT0gc0dyb3VwSWQgPyBncm91cCA6IHJlc3VsdDsKICAgICAgICAgICAgICAgIH0sIG51bGwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgb0dyb3VwRWxlbWVudCA9IG9Hcm91cCAmJiBvR3JvdXAuZ2V0RG9tUmVmKCk7CgogICAgICAgICAgICBpZiAoIW9Hcm91cEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG9Ub3BFbGVtZW50ID0gb0dyb3VwRWxlbWVudC5xdWVyeVNlbGVjdG9yKCIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lckVkaXRNb2RlIikgfHwgb0dyb3VwRWxlbWVudC5xdWVyeVNlbGVjdG9yKCIuc2FwVXNoZWxsVGlsZXNDb250YWluZXItc29ydGFibGUiKTsKCiAgICAgICAgICAgIGlmICghb1RvcEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNhcFVzaGVsbERhc2hib2FyZFBhZ2UtY29udCIpLnNjcm9sbFRvcCA9IG9Ub3BFbGVtZW50Lm9mZnNldFRvcDsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgIGlmIChEZXZpY2Uuc3lzdGVtLmRlc2t0b3ApIHsKICAgICAgICAgICAgICAgICAgICB2YXIganFUaWxlQ29udGFpbmVyID0gb0dyb3VwLiQoKTsKICAgICAgICAgICAgICAgICAgICAvLyByZWdhcmRsZXNzIHRvIGdyb3VwIGNoYW5nZSAtIGlmIHdlIG5lZWQgdG8gcmVzdG9yZSBsYXN0IGZvY3VzZWQgdGlsZSB3ZSBtdXN0IGRvIHNvLgogICAgICAgICAgICAgICAgICAgIGlmIChvRGF0YS5yZXN0b3JlTGFzdEZvY3VzZWRUaWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiTG9va0Zvckxhc3RWaXNpdGVkSW5TYW1lR3JvdXAgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIG5lZWQgdG8gcmVzdG9yZSBmb2N1cyBvbiBhIHNwZWNpZmljIHRpbGUtY29udGFpbmVyIChyYXRoZXIgdGhlbiBjdXJyZW50IGdyb3VwKQogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGVuIHdlIHN1cHBseSB0aGUgdGlsZSBjb250YWluZXIgYW5kIHNldCB0cnVlIHRvIGJMb29rRm9yTGFzdFZpc2l0ZWRJblNhbWVHcm91cCAoc2VlIGdvVG9MYXN0VmlzaXRlZFRpbGUgbWV0aG9kKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAob0RhdGEucmVzdG9yZUxhc3RGb2N1c2VkVGlsZUNvbnRhaW5lckJ5SWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpxVGlsZUNvbnRhaW5lciA9IGpRdWVyeSgiIyIgKyBvRGF0YS5yZXN0b3JlTGFzdEZvY3VzZWRUaWxlQ29udGFpbmVyQnlJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiTG9va0Zvckxhc3RWaXNpdGVkSW5TYW1lR3JvdXAgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBzYXAudXNoZWxsLmNvbXBvbmVudHMuQ29tcG9uZW50S2V5c0hhbmRsZXIuZ29Ub0xhc3RWaXNpdGVkVGlsZShqcVRpbGVDb250YWluZXIsIGJMb29rRm9yTGFzdFZpc2l0ZWRJblNhbWVHcm91cCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvRGF0YS5ncm91cENoYW5nZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IGZvY3VzIG9uIHRoZSBmaXJzdCBjb250ZW50IG9mIHRoZSBncm91cCB3ZSBzY3JvbGxlZCB0bwogICAgICAgICAgICAgICAgICAgICAgICB2YXIganFHcm91cENvbnRlbnQgPSBqcVRpbGVDb250YWluZXIuZmluZCgiLnNhcFVzaGVsbFRpbGUsIC5zYXBNR1RMaW5lTW9kZSwgLnNhcEZDYXJkIikuZmlsdGVyKCI6dmlzaWJsZSIpLmVxKDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpxR3JvdXBDb250ZW50Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5jb21wb25lbnRzLkNvbXBvbmVudEtleXNIYW5kbGVyLnNldFRpbGVGb2N1cyhqcUdyb3VwQ29udGVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9EYXRhLmlzSW5FZGl0VGl0bGUpIHsKICAgICAgICAgICAgICAgICAgICBvR3JvdXAuc2V0RWRpdE1vZGUodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1dGlscy5oYW5kbGVUaWxlc1Zpc2liaWxpdHkoKTsKICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogSGFuZGxlciBmb3IgZHJvcHBpbmcgYSB0aWxlIG9iamVjdCBhdCB0aGUgZW5kIG9mIGRyYWcgYW5kIGRyb3AgYWN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGV2ZW50CiAgICAgICAgICogQHBhcmFtIHVpIDogdGlsZSBET00gUmVmZXJlbmNlCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICBfaGFuZGxlRHJvcDogZnVuY3Rpb24gKGV2ZW50LCB1aSkgewogICAgICAgICAgICB2YXIgb0xheW91dCA9IExheW91dC5nZXRMYXlvdXRFbmdpbmUoKSwKICAgICAgICAgICAgICAgIHRpbGVNb3ZlSW5mbyA9IG9MYXlvdXQubGF5b3V0RW5kQ2FsbGJhY2soKSwKICAgICAgICAgICAgICAgIGJJc1Nob3J0RHJvcCA9ICF0aWxlTW92ZUluZm8uZHN0QXJlYSwKICAgICAgICAgICAgICAgIG9FdmVudEJ1cyA9IHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKSwKICAgICAgICAgICAgICAgIG5vUmVmcmVzaFNyYywKICAgICAgICAgICAgICAgIG5vUmVmcmVzaERzdCwKICAgICAgICAgICAgICAgIHNUaWxlVXVpZCwKICAgICAgICAgICAgICAgIG9EZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLAogICAgICAgICAgICAgICAgb1ZpZXcgPSB0aGlzLmdldFZpZXcoKSwKICAgICAgICAgICAgICAgIG9Nb2RlbCA9IG9WaWV3LmdldE1vZGVsKCksCiAgICAgICAgICAgICAgICBiVGFiTW9kZSA9IG9Nb2RlbC5nZXRQcm9wZXJ0eSgiL2hvbWVQYWdlR3JvdXBEaXNwbGF5IikgJiYgb01vZGVsLmdldFByb3BlcnR5KCIvaG9tZVBhZ2VHcm91cERpc3BsYXkiKSA9PT0gInRhYnMiLAogICAgICAgICAgICAgICAgYkVkaXRNb2RlID0gb01vZGVsLmdldFByb3BlcnR5KCIvdGlsZUFjdGlvbk1vZGVBY3RpdmUiKSwKICAgICAgICAgICAgICAgIGJJc1Nob3J0RHJvcFRvTG9ja2VkID0gdHJ1ZSwKICAgICAgICAgICAgICAgIGllSHRtbDVEbkQgPSAhIShvTW9kZWwuZ2V0UHJvcGVydHkoIi9wZXJzb25hbGl6YXRpb24iKSAmJiAoRGV2aWNlLmJyb3dzZXIubXNpZSB8fCBEZXZpY2UuYnJvd3Nlci5lZGdlKSAmJiBEZXZpY2UuYnJvd3Nlci52ZXJzaW9uID49IDExICYmCiAgICAgICAgICAgICAgICAgICAgKERldmljZS5zeXN0ZW0uY29tYmkgfHwgRGV2aWNlLnN5c3RlbS50YWJsZXQpKSwKICAgICAgICAgICAgICAgIGJJc0xpbmtQZXJzb25hbGl6YXRpb25TdXBwb3J0ZWQgPSB0aWxlTW92ZUluZm8udGlsZS5nZXRCaW5kaW5nQ29udGV4dCgpLmdldE9iamVjdCgpLmlzTGlua1BlcnNvbmFsaXphdGlvblN1cHBvcnRlZDsKCiAgICAgICAgICAgIExheW91dC5nZXRMYXlvdXRFbmdpbmUoKS5fdG9nZ2xlQW5jaG9ySXRlbUhpZ2hsaWdodGluZyhmYWxzZSk7CiAgICAgICAgICAgIC8vU2hvcnQgZHJvcCB0byBhIGxvY2tlZCBncm91cAogICAgICAgICAgICBpZiAodGlsZU1vdmVJbmZvLmRzdEdyb3VwKSB7CiAgICAgICAgICAgICAgICB2YXIgZHN0R3JvdXBCaW5kaW5nQ29udGV4dCA9IHRpbGVNb3ZlSW5mby5kc3RHcm91cC5nZXRCaW5kaW5nQ29udGV4dCgpLAogICAgICAgICAgICAgICAgICAgIGlzRGVzdEdyb3VwTG9ja2VkID0gZHN0R3JvdXBCaW5kaW5nQ29udGV4dC5nZXRQcm9wZXJ0eShkc3RHcm91cEJpbmRpbmdDb250ZXh0LnNQYXRoKS5pc0dyb3VwTG9ja2VkOwogICAgICAgICAgICAgICAgYklzU2hvcnREcm9wVG9Mb2NrZWQgPSBiSXNTaG9ydERyb3AgJiYgaXNEZXN0R3JvdXBMb2NrZWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghdGlsZU1vdmVJbmZvLnRpbGVNb3ZlZEZsYWcgfHwgKGllSHRtbDVEbkQgJiYgb0xheW91dC5pc1RhYkJhckNvbGxpc2lvbigpKSB8fCBiSXNTaG9ydERyb3BUb0xvY2tlZCB8fCAoIWJJc0xpbmtQZXJzb25hbGl6YXRpb25TdXBwb3J0ZWQgJiYgdGlsZU1vdmVJbmZvLmRzdEFyZWEgPT09ICJsaW5rcyIpKSB7CiAgICAgICAgICAgICAgICBvRXZlbnRCdXMucHVibGlzaCgibGF1bmNocGFkIiwgInNvcnRhYmxlU3RvcCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vdGlsZSB3YXMgbm90IG1vdmVkCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vSWYgd2UgYXJlIGluIEVkaXRNb2RlIGFuZCB0aGUgdGFyZ2V0IGdyb3VwIGhhcyBubyBsaW5rcyAoZW1wdHkgbGlua3MgYXJlYSkgYW5kIHRoZSBhbmNob3IgYmFyIGlzbid0IGluIHRhYnMgbW9kZSwKICAgICAgICAgICAgLy90aGVuIHdlIGNvbnRpbnVlIGFzIHRpbGUgd2FzIG5vdCBtb3ZlZC4KICAgICAgICAgICAgaWYgKCFiRWRpdE1vZGUgJiYgIWJUYWJNb2RlICYmIHRpbGVNb3ZlSW5mby5kc3RBcmVhID09PSAibGlua3MiICYmICF0aWxlTW92ZUluZm8uZHN0R3JvdXBEYXRhLmdldExpbmtzKCkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBvRXZlbnRCdXMucHVibGlzaCgibGF1bmNocGFkIiwgInNvcnRhYmxlU3RvcCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vdGlsZSB3YXMgbm90IG1vdmVkCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vUmVmcmVzaFNyYyA9IHRydWU7CiAgICAgICAgICAgIG5vUmVmcmVzaERzdCA9IHRydWU7IC8vRGVmYXVsdCAtIHN1cHByZXNzIHJlLXJlbmRlcmluZyBhZnRlciBkcm9wCiAgICAgICAgICAgIC8vaWYgc3JjIGFuZCBkZXN0aW5hdGlvbiBncm91cHMgZGlmZmVyIC0gcmVmcmVzaCBzcmMgYW5kIGRlc3QgZ3JvdXBzCiAgICAgICAgICAgIC8vZWxzZSBpZiBhIHRpbGUgaGFzIG1vdmVkICYgZHJvcHBlZCBpbiBhIGRpZmZlcmVudCBwb3NpdGlvbiBpbiB0aGUgc2FtZSBncm91cCAtIG9ubHkgZGVzdCBzaG91bGQgcmVmcmVzaCAoZGVzdCA9PSBzcmMpCiAgICAgICAgICAgIC8vaWYgYSB0aWxlIHdhcyBwaWNrZWQgYW5kIGRyb3BwZWQgLSBidXQgbmV2ZXIgbW92ZWQgLSB0aGUgcHJldmlvdXMgaWYgd291bGQgaGF2ZSByZXR1cm5lZAogICAgICAgICAgICBpZiAoKHRpbGVNb3ZlSW5mby5zcmNHcm91cCAhPT0gdGlsZU1vdmVJbmZvLmRzdEdyb3VwKSkgewogICAgICAgICAgICAgICAgbm9SZWZyZXNoU3JjID0gbm9SZWZyZXNoRHN0ID0gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGlsZU1vdmVJbmZvLnRpbGUgIT09IHRpbGVNb3ZlSW5mby5kc3RHcm91cC5nZXRUaWxlcygpW3RpbGVNb3ZlSW5mby5kc3RUaWxlSW5kZXhdKSB7CiAgICAgICAgICAgICAgICBub1JlZnJlc2hEc3QgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc1RpbGVVdWlkID0gdGhpcy5fZ2V0VGlsZVV1aWQodGlsZU1vdmVJbmZvLnRpbGUpOwogICAgICAgICAgICBpZiAodGlsZU1vdmVJbmZvLnNyY0dyb3VwICYmIHRpbGVNb3ZlSW5mby5zcmNHcm91cC5yZW1vdmVBZ2dyZWdhdGlvbiAmJiB0aWxlTW92ZUluZm8uc3JjQXJlYSkgewogICAgICAgICAgICAgICAgdGlsZU1vdmVJbmZvLnNyY0dyb3VwLnJlbW92ZUFnZ3JlZ2F0aW9uKCJ0aWxlcyIsIHRpbGVNb3ZlSW5mby50aWxlLCBub1JlZnJlc2hTcmMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB0aGlzIGlzIFRhYiBCYXIgdXNlLWNhc2UsIGFuZCB0aGUgYWN0aW9uIGlzICJsb25nIiBEcmFnJkRyb3Agb2YgYSB0aWxlIG9uIGEgdGFiIChncm91cCk6CiAgICAgICAgICAgIC8vIHRoZSBkZXN0aW5hdGlvbiBncm91cCAod2hvc2UgYWdncmVnYXRpb24gbmVlZHMgdG8gYmUgdXBkYXRlZCkgaXMgbm90IGluIHRoZSBkYXNoYm9hcmQsIHVubGVzcyB0aGUgZHJhZyBpcyB0byB0aGUgc2FtZSBncm91cC4KICAgICAgICAgICAgLy8gSW5zdGVhZCAtIHRoZSBwdWJsaXNoIG9mIG1vdmV0aWxlIGV2ZW50IHdpbGwgdXBkYXRlIHRoZSBncm91cCBpbiB0aGUgbW9kZWwKICAgICAgICAgICAgdmFyIGJTYW1lRHJvcEFyZWEgPSB0aWxlTW92ZUluZm8uZHN0R3JvdXBEYXRhICYmIHRpbGVNb3ZlSW5mby5kc3RHcm91cERhdGEuaW5zZXJ0QWdncmVnYXRpb24gJiYgdGlsZU1vdmVJbmZvLmRzdEFyZWEgPT09IHRpbGVNb3ZlSW5mby5zcmNBcmVhOwoKICAgICAgICAgICAgLy9IYW5kbGVzIHR3byBzY2VuYXJpb3MgLSAxLiBTYW1lIGdyb3VwIGRyb3AgLSB0aWxlIHRvIHRpbGUvbGluayB0byBsaW5rIDIuIExvbmcgZHJvcCAtIHRpbGUgdG8gdGlsZS9saW5rIHRvIGxpbmsKICAgICAgICAgICAgaWYgKGJTYW1lRHJvcEFyZWEpIHsKICAgICAgICAgICAgICAgIHRpbGVNb3ZlSW5mby50aWxlLnNQYXJlbnRBZ2dyZWdhdGlvbk5hbWUgPSB0aWxlTW92ZUluZm8uZHN0QXJlYTsvLyJ0aWxlcyIKICAgICAgICAgICAgICAgIHRpbGVNb3ZlSW5mby5kc3RHcm91cERhdGEuaW5zZXJ0QWdncmVnYXRpb24odGlsZU1vdmVJbmZvLmRzdEFyZWEsIHRpbGVNb3ZlSW5mby50aWxlLCB0aWxlTW92ZUluZm8uZHN0VGlsZUluZGV4LCBub1JlZnJlc2hEc3QpOwoKICAgICAgICAgICAgICAgIG9EZWZlcnJlZCA9IHRoaXMuX2hhbmRsZVNhbWVUeXBlRHJvcCh0aWxlTW92ZUluZm8sIHNUaWxlVXVpZCwgYlNhbWVEcm9wQXJlYSk7CgogICAgICAgICAgICAgICAgLy9IYW5kbGVzIHRocmVlIHNjZW5hcmlvcyAtIDEuIFNob3J0IGRyb3AgMi4gU2FtZSBncm91cCAtIHRpbGUgdG8gbGluay9saW5rIHRvIHRpbGUgMy4gTG9uZyBkcm9wIC0gdGlsZSB0byBsaW5rL2xpbmsgdG8gdGlsZQogICAgICAgICAgICB9IGVsc2UgaWYgKGJJc1Nob3J0RHJvcCkgewogICAgICAgICAgICAgICAgb0RlZmVycmVkID0gdGhpcy5faGFuZGxlU2hvcnREcm9wKHRpbGVNb3ZlSW5mbywgc1RpbGVVdWlkLCBiU2FtZURyb3BBcmVhKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9EZWZlcnJlZCA9IHRoaXMuX2hhbmRsZUNvbnZlcnREcm9wKHRpbGVNb3ZlSW5mbywgYlNhbWVEcm9wQXJlYSwgdWkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5nZXRWaWV3KCkuZ2V0TW9kZWwoKSkgewogICAgICAgICAgICAgICAgdGhpcy5nZXRWaWV3KCkuZ2V0TW9kZWwoKS5zZXRQcm9wZXJ0eSgiL2RyYWdnZWRUaWxlTGlua1BlcnNvbmFsaXphdGlvblN1cHBvcnRlZCIsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9FdmVudEJ1cy5wdWJsaXNoKCJsYXVuY2hwYWQiLCAic29ydGFibGVTdG9wIik7CiAgICAgICAgICAgIHJldHVybiBvRGVmZXJyZWQucHJvbWlzZSgpOwogICAgICAgIH0sCgogICAgICAgIF9oYW5kbGVTYW1lVHlwZURyb3A6IGZ1bmN0aW9uICh0aWxlTW92ZUluZm8sIHNUaWxlVXVpZCwgYlNhbWVEcm9wQXJlYSkgewogICAgICAgICAgICB2YXIgb0V2ZW50QnVzID0gc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLAogICAgICAgICAgICAgICAgb0RlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCk7CiAgICAgICAgICAgIHRpbGVNb3ZlSW5mby50aWxlLl9nZXRCaW5kaW5nQ29udGV4dCgpLm9Nb2RlbC5zZXRQcm9wZXJ0eSh0aWxlTW92ZUluZm8udGlsZS5fZ2V0QmluZGluZ0NvbnRleHQoKS5zUGF0aCArICIvZHJhZ2dlZEluVGFiQmFyVG9Tb3VyY2VHcm91cCIsIGZhbHNlKTsKICAgICAgICAgICAgb0V2ZW50QnVzLnB1Ymxpc2goImxhdW5jaHBhZCIsICJtb3ZldGlsZSIsIHsKICAgICAgICAgICAgICAgIHNUaWxlSWQ6IHNUaWxlVXVpZCwKICAgICAgICAgICAgICAgIHNUb0l0ZW1zOiB0aWxlTW92ZUluZm8uZHN0QXJlYSA/IHRpbGVNb3ZlSW5mby5kc3RBcmVhIDogInRpbGVzIiwKICAgICAgICAgICAgICAgIHNGcm9tSXRlbXM6IHRpbGVNb3ZlSW5mby5zcmNBcmVhID8gdGlsZU1vdmVJbmZvLnNyY0FyZWEgOiAidGlsZXMiLAogICAgICAgICAgICAgICAgc1RpbGVUeXBlOiB0aWxlTW92ZUluZm8uZHN0QXJlYSA/IHRpbGVNb3ZlSW5mby5kc3RBcmVhLnN1YnN0cigwLCB0aWxlTW92ZUluZm8uZHN0QXJlYS5sZW5ndGggLSAxKSA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgIHRvR3JvdXBJZDogdGlsZU1vdmVJbmZvLmRzdEdyb3VwRGF0YS5nZXRHcm91cElkID8gdGlsZU1vdmVJbmZvLmRzdEdyb3VwRGF0YS5nZXRHcm91cElkKCkgOiB0aWxlTW92ZUluZm8uZHN0R3JvdXBEYXRhLmdyb3VwSWQsCiAgICAgICAgICAgICAgICB0b0luZGV4OiB0aWxlTW92ZUluZm8uZHN0VGlsZUluZGV4LAogICAgICAgICAgICAgICAgbG9uZ0Ryb3A6IGJTYW1lRHJvcEFyZWEsCiAgICAgICAgICAgICAgICBjYWxsQmFjazogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG9EZWZlcnJlZC5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gb0RlZmVycmVkLnByb21pc2UoKTsKICAgICAgICB9LAoKICAgICAgICBfaGFuZGxlU2hvcnREcm9wOiBmdW5jdGlvbiAodGlsZU1vdmVJbmZvLCBzVGlsZVV1aWQsIGJTYW1lRHJvcEFyZWEpIHsKICAgICAgICAgICAgdmFyIG9FdmVudEJ1cyA9IHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKSwKICAgICAgICAgICAgICAgIG9EZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpOwogICAgICAgICAgICBvRXZlbnRCdXMucHVibGlzaCgibGF1bmNocGFkIiwgIm1vdmV0aWxlIiwgewogICAgICAgICAgICAgICAgc1RpbGVJZDogc1RpbGVVdWlkLAogICAgICAgICAgICAgICAgc1RvSXRlbXM6IHRpbGVNb3ZlSW5mby5zcmNBcmVhIHx8ICJ0aWxlcyIsCiAgICAgICAgICAgICAgICBzRnJvbUl0ZW1zOiB0aWxlTW92ZUluZm8uc3JjQXJlYSB8fCAidGlsZXMiLAogICAgICAgICAgICAgICAgc1RpbGVUeXBlOiB0aWxlTW92ZUluZm8uc3JjQXJlYSA/IHRpbGVNb3ZlSW5mby5zcmNBcmVhLnN1YnN0cigwLCB0aWxlTW92ZUluZm8uc3JjQXJlYS5sZW5ndGggLSAxKSA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgIHRvR3JvdXBJZDogdGlsZU1vdmVJbmZvLmRzdEdyb3VwRGF0YS5nZXRHcm91cElkID8gdGlsZU1vdmVJbmZvLmRzdEdyb3VwRGF0YS5nZXRHcm91cElkKCkgOiB0aWxlTW92ZUluZm8uZHN0R3JvdXBEYXRhLmdyb3VwSWQsCiAgICAgICAgICAgICAgICB0b0luZGV4OiB0aWxlTW92ZUluZm8uZHN0VGlsZUluZGV4LAogICAgICAgICAgICAgICAgbG9uZ0Ryb3A6IGJTYW1lRHJvcEFyZWEsCiAgICAgICAgICAgICAgICBjYWxsQmFjazogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG9EZWZlcnJlZC5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gb0RlZmVycmVkLnByb21pc2UoKTsKICAgICAgICB9LAoKICAgICAgICBfaGFuZGxlQ29udmVydERyb3A6IGZ1bmN0aW9uICh0aWxlTW92ZUluZm8sIGJTYW1lRHJvcEFyZWEsIHVpKSB7CiAgICAgICAgICAgIHZhciBvRXZlbnRCdXMgPSBzYXAudWkuZ2V0Q29yZSgpLmdldEV2ZW50QnVzKCksCiAgICAgICAgICAgICAgICBvRGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKTsKICAgICAgICAgICAgb0V2ZW50QnVzLnB1Ymxpc2goImxhdW5jaHBhZCIsICJjb252ZXJ0VGlsZSIsIHsKICAgICAgICAgICAgICAgIHRvR3JvdXBJZDogdGlsZU1vdmVJbmZvLmRzdEdyb3VwRGF0YS5nZXRHcm91cElkID8gdGlsZU1vdmVJbmZvLmRzdEdyb3VwRGF0YS5nZXRHcm91cElkKCkgOiB0aWxlTW92ZUluZm8uZHN0R3JvdXBEYXRhLmdyb3VwSWQsCiAgICAgICAgICAgICAgICB0b0luZGV4OiB0aWxlTW92ZUluZm8uZHN0VGlsZUluZGV4LAogICAgICAgICAgICAgICAgdGlsZTogc2FwLnVpLmdldENvcmUoKS5ieUlkKHVpLmlkKSwKICAgICAgICAgICAgICAgIHNyY0dyb3VwSWQ6IHRpbGVNb3ZlSW5mby5zcmNHcm91cC5nZXRHcm91cElkID8gdGlsZU1vdmVJbmZvLnNyY0dyb3VwLmdldEdyb3VwSWQoKSA6IHRpbGVNb3ZlSW5mby5zcmNHcm91cC5ncm91cElkLAogICAgICAgICAgICAgICAgbG9uZ0Ryb3A6IGJTYW1lRHJvcEFyZWEsCiAgICAgICAgICAgICAgICBjYWxsQmFjazogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG9EZWZlcnJlZC5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gb0RlZmVycmVkLnByb21pc2UoKTsKICAgICAgICB9LAoKICAgICAgICBfZ2V0VGlsZVV1aWQ6IGZ1bmN0aW9uIChvVGlsZU9iamVjdCkgewogICAgICAgICAgICBpZiAob1RpbGVPYmplY3QuZ2V0VXVpZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9UaWxlT2JqZWN0LmdldFV1aWQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG9UaWxlTW9kZWxPYmplY3QgPSBvVGlsZU9iamVjdC5nZXRCaW5kaW5nQ29udGV4dCgpLmdldE9iamVjdCgpOwoKICAgICAgICAgICAgaWYgKG9UaWxlTW9kZWxPYmplY3QuZ2V0UGFyZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb1RpbGVNb2RlbE9iamVjdC5nZXRQYXJlbnQoKS5nZXRVdWlkKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvVGlsZU1vZGVsT2JqZWN0LnV1aWQ7CiAgICAgICAgfSwKCiAgICAgICAgX2hhbmRsZURyYWc6IGZ1bmN0aW9uIChldmVudCwgdWkpIHsKICAgICAgICAgICAgdmFyIHRpbGVEcmFnSW5mbyA9IExheW91dC5nZXRMYXlvdXRFbmdpbmUoKS5sYXlvdXRFbmRDYWxsYmFjaygpLAogICAgICAgICAgICAgICAgb1RpbGVNb2RlbCA9IHRpbGVEcmFnSW5mby50aWxlLmdldEJpbmRpbmdDb250ZXh0KCkuZ2V0T2JqZWN0KCksCiAgICAgICAgICAgICAgICBvTW9kZWwgPSB0aGlzLmdldFZpZXcoKS5nZXRNb2RlbCgpOwoKICAgICAgICAgICAgaWYgKG9Nb2RlbCkgewogICAgICAgICAgICAgICAgb01vZGVsLnNldFByb3BlcnR5KCIvZHJhZ2dlZFRpbGVMaW5rUGVyc29uYWxpemF0aW9uU3VwcG9ydGVkIiwgb1RpbGVNb2RlbC5pc0xpbmtQZXJzb25hbGl6YXRpb25TdXBwb3J0ZWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2hhbmRsZVRhYkJhckl0ZW1QcmVzc0V2ZW50SGFuZGxlcjogZnVuY3Rpb24gKHNDaGFubmVsSWQsIHNFdmVudElkLCBvRGF0YSkgewogICAgICAgICAgICB2YXIgb1ZpZXcgPSB0aGlzLmdldFZpZXcoKSwKICAgICAgICAgICAgICAgIG9Nb2RlbCA9IG9WaWV3LmdldE1vZGVsKCksCiAgICAgICAgICAgICAgICBhR3JvdXBzID0gb01vZGVsLmdldFByb3BlcnR5KCIvZ3JvdXBzIiksCiAgICAgICAgICAgICAgICBpR3JvdXBJbmRleCA9IG9EYXRhLmlHcm91cEluZGV4OwoKICAgICAgICAgICAgLy8gZmlyc3QgcmVzZXQgdGhlIGlzR3JvdXBTZWxlY3RlZCBwcm9wZXJ0eSBmb3IgYWxsIGdyb3Vwcy4KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhR3JvdXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvTW9kZWwuc2V0UHJvcGVydHkoIi9ncm91cHMvIiArIGkgKyAiL2lzR3JvdXBTZWxlY3RlZCIsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBzZXQgdGhlIHNlbGVjdGVkIGdyb3VwIChmb3IgdGhlIG1vZGVsIHVwZGF0ZSB3ZSB1c2UgdGhlIG9yaWdpbmFsIGluZGV4KQogICAgICAgICAgICBvTW9kZWwuc2V0UHJvcGVydHkoIi9ncm91cHMvIiArIGlHcm91cEluZGV4ICsgIi9pc0dyb3VwU2VsZWN0ZWQiLCB0cnVlKTsKCiAgICAgICAgICAgIHRoaXMuX2hhbmRsZVRhYkJhckl0ZW1QcmVzcyhzQ2hhbm5lbElkLCBzRXZlbnRJZCwgaUdyb3VwSW5kZXgpOwogICAgICAgIH0sCgogICAgICAgIF9oYW5kbGVUYWJCYXJJdGVtUHJlc3M6IGZ1bmN0aW9uIChzQ2hhbm5lbElkLCBzRXZlbnRJZCwgaUdyb3VwSW5kZXgsIG9FdmVudCkgewogICAgICAgICAgICB2YXIgb1ZpZXcgPSB0aGlzLmdldFZpZXcoKSwKICAgICAgICAgICAgICAgIC8vIEZpeCB0aGUgc2VsZWN0ZWQgZ3JvdXAgaW5kZXggbm90IHRvIGluY2x1ZGUgdGhlIGhpZGRlbiBncm91cHMuCiAgICAgICAgICAgICAgICBzZWxlY3RlZEdyb3VwSW5kZXgsCiAgICAgICAgICAgICAgICBmaXhlZEluZGV4OwoKICAgICAgICAgICAgaWYgKG9FdmVudCkgewogICAgICAgICAgICAgICAgc2VsZWN0ZWRHcm91cEluZGV4ID0gb0V2ZW50LmdldFBhcmFtZXRlcigiZ3JvdXAiKS5nZXRJbmRleCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VsZWN0ZWRHcm91cEluZGV4ID0gaUdyb3VwSW5kZXg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS5wdWJsaXNoKCJsYXVuY2hwYWQiLCAidGFiU2VsZWN0ZWQiLCB7IGlTZWxlY3RlZEdyb3VwOiBzZWxlY3RlZEdyb3VwSW5kZXggfSk7CgogICAgICAgICAgICBmaXhlZEluZGV4ID0gdGhpcy5fZ2V0VmlzaWJsZUdyb3VwSW5kZXgoc2VsZWN0ZWRHcm91cEluZGV4KTsKCiAgICAgICAgICAgIC8vIGFwcGx5IHRoZSBmaWx0ZXIKICAgICAgICAgICAgb1ZpZXcub0Rhc2hib2FyZEdyb3Vwc0JveC5yZW1vdmVMaW5rc0Zyb21VbnNlbGVjdGVkR3JvdXBzKCk7CiAgICAgICAgICAgIG9WaWV3Lm9EYXNoYm9hcmRHcm91cHNCb3guZ2V0QmluZGluZygiZ3JvdXBzIikuZmlsdGVyKFtvVmlldy5vRmlsdGVyU2VsZWN0ZWRHcm91cF0pOwogICAgICAgICAgICAvLyBjaGFuZ2UgdGhlIGFuY2hvciBiYXIgc2VsZWN0aW9uCiAgICAgICAgICAgIG9WaWV3Lm9BbmNob3JOYXZpZ2F0aW9uQmFyLnNldFNlbGVjdGVkSXRlbUluZGV4KGZpeGVkSW5kZXgpOwogICAgICAgICAgICBvVmlldy5vQW5jaG9yTmF2aWdhdGlvbkJhci5yZUFycmFuZ2VOYXZpZ2F0aW9uQmFyRWxlbWVudHMoKTsKICAgICAgICAgICAgLy8gY2hhbmdlIHRpbGVzIHZpc2liaWxpdHkgb2YgdGhlIG5ldyBzZWxlY3RlZCBncm91cAogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHV0aWxzLmhhbmRsZVRpbGVzVmlzaWJpbGl0eSgpOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICB9LAoKICAgICAgICBfZ2V0VmlzaWJsZUdyb3VwSW5kZXg6IGZ1bmN0aW9uIChzZWxlY3RlZEdyb3VwSW5kZXgpIHsKICAgICAgICAgICAgdmFyIGFHcm91cHMgPSB0aGlzLmdldFZpZXcoKS5nZXRNb2RlbCgpLmdldFByb3BlcnR5KCIvZ3JvdXBzIik7CiAgICAgICAgICAgIHZhciBpSGlkZGVuR3JvdXBzQ291bnQgPSAwOwoKICAgICAgICAgICAgLy8gR28gdGhyb3VnaCB0aGUgZ3JvdXBzIHRoYXQgYXJlIGxvY2F0ZWQgYmVmb3JlIHRoZSBzZWxlY3RlZCBncm91cAogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlbGVjdGVkR3JvdXBJbmRleDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoIWFHcm91cHNbaV0uaXNHcm91cFZpc2libGUgfHwgIWFHcm91cHNbaV0udmlzaWJpbGl0eU1vZGVzWzBdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ291bnQgYWxsIGdyb3VwcyB0aGF0IGFyZSBub3QgdmlzaWJsZSBpbiBub24tZWRpdCBtb2RlCiAgICAgICAgICAgICAgICAgICAgaUhpZGRlbkdyb3Vwc0NvdW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBzZWxlY3RlZEdyb3VwSW5kZXggLSBpSGlkZGVuR3JvdXBzQ291bnQ7CiAgICAgICAgfSwKCiAgICAgICAgX2dldE1vZGVsR3JvdXBGcm9tVmlzaWJsZUluZGV4OiBmdW5jdGlvbiAoc2VsZWN0ZWRHcm91cEluZGV4KSB7CiAgICAgICAgICAgIHZhciBhR3JvdXBzID0gdGhpcy5nZXRWaWV3KCkuZ2V0TW9kZWwoKS5nZXRQcm9wZXJ0eSgiL2dyb3VwcyIpLAogICAgICAgICAgICAgICAgaVZpc0dyb3Vwc0NvdW50ID0gMDsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYUdyb3Vwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGFHcm91cHNbaV0uaXNHcm91cFZpc2libGUgJiYgYUdyb3Vwc1tpXS52aXNpYmlsaXR5TW9kZXNbMF0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDb3VudCBhbGwgZ3JvdXBzIHRoYXQgYXJlIG5vdCB2aXNpYmxlIGluIG5vbi1lZGl0IG1vZGUKICAgICAgICAgICAgICAgICAgICBpVmlzR3JvdXBzQ291bnQrKzsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGlWaXNHcm91cHNDb3VudCA+IHNlbGVjdGVkR3JvdXBJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0sCgogICAgICAgIF9oYW5kbGVBbmNob3JJdGVtUHJlc3M6IGZ1bmN0aW9uIChvRXZlbnQpIHsKICAgICAgICAgICAgdmFyIG9WaWV3ID0gdGhpcy5nZXRWaWV3KCksCiAgICAgICAgICAgICAgICBvTW9kZWwgPSBvVmlldy5nZXRNb2RlbCgpLAogICAgICAgICAgICAgICAgYUdyb3VwcyA9IG9Nb2RlbC5nZXRQcm9wZXJ0eSgiL2dyb3VwcyIpOwoKICAgICAgICAgICAgLy9wcmVzcyBvbiBpdGVtIGNvdWxkIGFsc28gYmUgZmlyZWQgZnJvbSBvdmVyZmxvdyBwb3B1cCwgYnV0IGl0IHdpbGwgbm90IGhhdmUgIm1hbnVhbFByZXNzIiBwYXJhbWV0ZXIKICAgICAgICAgICAgaWYgKERldmljZS5zeXN0ZW0ucGhvbmUgJiYgb0V2ZW50LmdldFBhcmFtZXRlcigibWFudWFsUHJlc3MiKSkgewogICAgICAgICAgICAgICAgb0V2ZW50Lm9Tb3VyY2Uub3Blbk92ZXJmbG93UG9wdXAoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcmVzZXQgdGhlIGlzR3JvdXBTZWxlY3RlZCBwcm9wZXJ0eSBmb3IgYWxsIGdyb3VwcyBiZWZvcmUgc2V0IHRoZSBzZWxlY3RlZCBncm91cAogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFHcm91cHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChvTW9kZWwuZ2V0UHJvcGVydHkoIi9ncm91cHMvIiArIGkgKyAiL2lzR3JvdXBTZWxlY3RlZCIpID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgb01vZGVsLnNldFByb3BlcnR5KCIvZ3JvdXBzLyIgKyBpICsgIi9pc0dyb3VwU2VsZWN0ZWQiLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gc2V0IHRoZSBzZWxlY3RlZCBncm91cCAoZm9yIHRoZSBtb2RlbCB1cGRhdGUgd2UgdXNlIHRoZSBvcmlnaW5hbCBpbmRleCkKICAgICAgICAgICAgb01vZGVsLnNldFByb3BlcnR5KCIvZ3JvdXBzLyIgKyBvRXZlbnQuZ2V0UGFyYW1ldGVyKCJncm91cCIpLmdldEluZGV4KCkgKyAiL2lzR3JvdXBTZWxlY3RlZCIsIHRydWUpOwogICAgICAgICAgICBvTW9kZWwuc2V0UHJvcGVydHkoIi9pU2VsZWN0ZWRHcm91cCIsIG9FdmVudC5nZXRQYXJhbWV0ZXIoImdyb3VwIikuZ2V0SW5kZXgoKSk7CgogICAgICAgICAgICAvLyBpZiB0YWJzCiAgICAgICAgICAgIGlmIChvTW9kZWwuZ2V0UHJvcGVydHkoIi9ob21lUGFnZUdyb3VwRGlzcGxheSIpICYmIG9Nb2RlbC5nZXRQcm9wZXJ0eSgiL2hvbWVQYWdlR3JvdXBEaXNwbGF5IikgPT09ICJ0YWJzIiAmJiAhb01vZGVsLmdldFByb3BlcnR5KCIvdGlsZUFjdGlvbk1vZGVBY3RpdmUiKSkgewogICAgICAgICAgICAgICAgdGhpcy5faGFuZGxlVGFiQmFySXRlbVByZXNzKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIG9FdmVudCk7CgogICAgICAgICAgICAgICAgLy8gZWxzZSBzY3JvbGwgb3IgZWRpdCBtb2RlCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZXNldCB0aGUgZmlsdGVyCgogICAgICAgICAgICAgICAgaWYgKCFvTW9kZWwuZ2V0UHJvcGVydHkoIi90aWxlQWN0aW9uTW9kZUFjdGl2ZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgb1ZpZXcub0Rhc2hib2FyZEdyb3Vwc0JveC5nZXRCaW5kaW5nKCJncm91cHMiKS5maWx0ZXIoW25ldyBGaWx0ZXIoImlzR3JvdXBWaXNpYmxlIiwgRmlsdGVyT3BlcmF0b3IuRVEsIHRydWUpXSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG9WaWV3Lm9EYXNoYm9hcmRHcm91cHNCb3guZ2V0QmluZGluZygiZ3JvdXBzIikuZmlsdGVyKFtdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzY3JvbGwgdG8gc2VsZWN0ZWQgZ3JvdXAKICAgICAgICAgICAgICAgIHRoaXMuX3Njcm9sbFRvR3JvdXAoImxhdW5jaHBhZCIsICJzY3JvbGxUb0dyb3VwIiwgewogICAgICAgICAgICAgICAgICAgIGdyb3VwOiBvRXZlbnQuZ2V0UGFyYW1ldGVyKCJncm91cCIpLAogICAgICAgICAgICAgICAgICAgIGdyb3VwQ2hhbmdlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBmb2N1czogKG9FdmVudC5nZXRQYXJhbWV0ZXIoImFjdGlvbiIpID09PSAic2FwZW50ZXIiKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfYWRkR3JvdXBIYW5kbGVyOiBmdW5jdGlvbiAob0RhdGEpIHsKICAgICAgICAgICAgdmFyIGluZGV4LAogICAgICAgICAgICAgICAgcGF0aCA9IG9EYXRhLmdldFNvdXJjZSgpLmdldEJpbmRpbmdDb250ZXh0KCkuZ2V0UGF0aCgpLAogICAgICAgICAgICAgICAgcGFyc2VQYXRoID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICAgICAgaW5kZXggPSB3aW5kb3cucGFyc2VJbnQocGFyc2VQYXRoW3BhcnNlUGF0aC5sZW5ndGggLSAxXSwgMTApOwoKICAgICAgICAgICAgaWYgKG9EYXRhLmdldFNvdXJjZSgpLnNQYXJlbnRBZ2dyZWdhdGlvbk5hbWUgPT09ICJhZnRlckNvbnRlbnQiKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IGluZGV4ICsgMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLnB1Ymxpc2goImxhdW5jaHBhZCIsICJjcmVhdGVHcm91cEF0IiwgewogICAgICAgICAgICAgICAgdGl0bGU6ICIiLAogICAgICAgICAgICAgICAgbG9jYXRpb246IGluZGV4LAogICAgICAgICAgICAgICAgaXNSZW5kZXJlZDogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBfcHVibGlzaEFzeW5jOiBmdW5jdGlvbiAoc0NoYW5uZWxJZCwgc0V2ZW50SWQsIG9EYXRhKSB7CiAgICAgICAgICAgIHZhciBvQnVzID0gc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpOwogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChqUXVlcnkucHJveHkob0J1cy5wdWJsaXNoLCBvQnVzLCBzQ2hhbm5lbElkLCBzRXZlbnRJZCwgb0RhdGEpLCAxKTsKICAgICAgICB9LAogICAgICAgIF9jaGFuZ2VHcm91cFZpc2liaWxpdHk6IGZ1bmN0aW9uIChvR3JvdXBCaW5kaW5nQ3R4KSB7CiAgICAgICAgICAgIHZhciBzQmluZGluZ0N0eFBhdGggPSBvR3JvdXBCaW5kaW5nQ3R4LmdldFBhdGgoKSwKICAgICAgICAgICAgICAgIG9Nb2RlbCA9IG9Hcm91cEJpbmRpbmdDdHguZ2V0TW9kZWwoKSwKICAgICAgICAgICAgICAgIGJHcm91cFZpc2liaWxpdHlTdGF0ZSA9IG9Nb2RlbC5nZXRQcm9wZXJ0eShzQmluZGluZ0N0eFBhdGggKyAiL2lzR3JvdXBWaXNpYmxlIiksCiAgICAgICAgICAgICAgICBvVmlldyA9IHRoaXMuZ2V0VmlldygpOwoKICAgICAgICAgICAgaWYgKG9Nb2RlbC5nZXRQcm9wZXJ0eShzQmluZGluZ0N0eFBhdGggKyAiL2lzRGVmYXVsdEdyb3VwIikKICAgICAgICAgICAgICAgIHx8IG9Nb2RlbC5nZXRQcm9wZXJ0eShzQmluZGluZ0N0eFBhdGggKyAiL2lzR3JvdXBMb2NrZWQiKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvTW9kZWwuc2V0UHJvcGVydHkoc0JpbmRpbmdDdHhQYXRoICsgIi9pc0dyb3VwVmlzaWJsZSIsICFiR3JvdXBWaXNpYmlsaXR5U3RhdGUpOwogICAgICAgICAgICBvVmlldy5vQW5jaG9yTmF2aWdhdGlvbkJhci51cGRhdGVWaXNpYmlsaXR5KCk7CiAgICAgICAgfSwKCiAgICAgICAgLy9QZXJzaXN0IHRoZSBncm91cCB2aXNpYmlsaXR5IGNoYW5nZXMgKGhpZGRlbiBncm91cHMpIGluIHRoZSBiYWNrLWVuZCB1cG9uIGRlYWN0aXZhdGlvbiBvZiB0aGUgQWN0aW9ucyBNb2RlLgogICAgICAgIF9oYW5kbGVHcm91cFZpc2liaWxpdHlDaGFuZ2VzOiBmdW5jdGlvbiAoc0NoYW5uZWxJZCwgc0V2ZW50SWQsIGFPcmlnSGlkZGVuR3JvdXBzSWRzKSB7CiAgICAgICAgICAgIHZhciBvTGF1bmNoUGFnZVNydiA9IHNhcC51c2hlbGwuQ29udGFpbmVyLmdldFNlcnZpY2UoIkxhdW5jaFBhZ2UiKSwKICAgICAgICAgICAgICAgIG9Nb2RlbCA9IHRoaXMuZ2V0VmlldygpLmdldE1vZGVsKCksCiAgICAgICAgICAgICAgICBvSG9tZXBhZ2VNYW5hZ2VyID0gc2FwLnVzaGVsbC5jb21wb25lbnRzLmdldEhvbWVwYWdlTWFuYWdlcigpLAogICAgICAgICAgICAgICAgYUN1cnJlbnRIaWRkZW5Hcm91cHNJZHMgPSBvSG9tZXBhZ2VNYW5hZ2VyLmdldEN1cnJlbnRIaWRkZW5Hcm91cElkcyhvTW9kZWwpLAogICAgICAgICAgICAgICAgYlNhbWVMZW5ndGggPSBhQ3VycmVudEhpZGRlbkdyb3Vwc0lkcy5sZW5ndGggPT09IGFPcmlnSGlkZGVuR3JvdXBzSWRzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGJJbnRlcnNlY3QgPSBiU2FtZUxlbmd0aCwKICAgICAgICAgICAgICAgIG9Qcm9taXNlOwoKICAgICAgICAgICAgLy9DaGVja3Mgd2hldGhlciB0aGVyZSdzIGEgc3ltbWV0cmljIGRpZmZlcmVuY2UgYmV0d2VlbiB0aGUgY3VycmVudCBzZXQgb2YgaGlkZGVuIGdyb3VwcyBhbmQgdGhlIGdlbnVpbmUgb25lCiAgICAgICAgICAgIGFDdXJyZW50SGlkZGVuR3JvdXBzSWRzLnNvbWUoZnVuY3Rpb24gKHNIaWRkZW5Hcm91cElkLCBpSW5kZXgpIHsKICAgICAgICAgICAgICAgIGlmICghYkludGVyc2VjdCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYkludGVyc2VjdCA9IGFPcmlnSGlkZGVuR3JvdXBzSWRzICYmIEFycmF5LnByb3RvdHlwZS5pbmRleE9mLmNhbGwoYU9yaWdIaWRkZW5Hcm91cHNJZHMsIHNIaWRkZW5Hcm91cElkKSAhPT0gLTE7CgogICAgICAgICAgICAgICAgcmV0dXJuICFiSW50ZXJzZWN0OwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmICghYkludGVyc2VjdCkgewogICAgICAgICAgICAgICAgb1Byb21pc2UgPSBvTGF1bmNoUGFnZVNydi5oaWRlR3JvdXBzKGFDdXJyZW50SGlkZGVuR3JvdXBzSWRzKTsKICAgICAgICAgICAgICAgIG9Qcm9taXNlLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG9Nb2RlbC51cGRhdGVCaW5kaW5ncygiZ3JvdXBzIik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG9Qcm9taXNlLmZhaWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtc2dTZXJ2aWNlID0gc2FwLnVzaGVsbC5Db250YWluZXIuZ2V0U2VydmljZSgiTWVzc2FnZSIpOwoKICAgICAgICAgICAgICAgICAgICBtc2dTZXJ2aWNlLmVycm9yKHJlc291cmNlcy5pMThuLmdldFRleHQoImhpZGVHcm91cHNfZXJyb3IiKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF91cGRhdGVTaGVsbEhlYWRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXRoaXMub1NoZWxsVUlTZXJ2aWNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9pbml0aWFsaXplU2hlbGxVSVNlcnZpY2UoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEFzIHRoZSBEYXNoYm9hcmQgaXMgY3VycmVudGx5IHRoZSBkZWZhdWx0IHBhZ2UgZm9yIHRoZSBTaGVsbCwgd2UgY2FsbCBzZXQgdGl0bGUgYW5kIHNldCBoaWVyYXJjaHkgd2l0aCBubyB2YWx1ZQogICAgICAgICAgICAgICAgLy8gc28gdGhlIGRlZmF1bHQgdmFsdWUgd2lsbCBiZSBzZXQKICAgICAgICAgICAgICAgIHRoaXMub1NoZWxsVUlTZXJ2aWNlLnNldFRpdGxlKCk7CiAgICAgICAgICAgICAgICB0aGlzLm9TaGVsbFVJU2VydmljZS5zZXRIaWVyYXJjaHkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9pbml0aWFsaXplU2hlbGxVSVNlcnZpY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHNhcC51aS5yZXF1aXJlKFsic2FwL3VzaGVsbC91aTVzZXJ2aWNlL1NoZWxsVUlTZXJ2aWNlIl0sIGZ1bmN0aW9uIChTaGVsbFVJU2VydmljZSkgewogICAgICAgICAgICAgICAgdGhpcy5vU2hlbGxVSVNlcnZpY2UgPSBuZXcgU2hlbGxVSVNlcnZpY2UoewogICAgICAgICAgICAgICAgICAgIHNjb3BlT2JqZWN0OiB0aGlzLmdldE93bmVyQ29tcG9uZW50KCksCiAgICAgICAgICAgICAgICAgICAgc2NvcGVUeXBlOiAiY29tcG9uZW50IgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAvLyBBcyB0aGUgRGFzaGJvYXJkIGlzIGN1cnJlbnRseSB0aGUgZGVmYXVsdCBwYWdlIGZvciB0aGUgU2hlbGwsIHdlIGNhbGwgc2V0IHRpdGxlIGFuZCBzZXQgaGllcmFyY2h5IHdpdGggbm8gdmFsdWUKICAgICAgICAgICAgICAgIC8vIHNvIHRoZSBkZWZhdWx0IHZhbHVlIHdpbGwgYmUgc2V0CiAgICAgICAgICAgICAgICB0aGlzLm9TaGVsbFVJU2VydmljZS5zZXRUaXRsZSgpOwogICAgICAgICAgICAgICAgdGhpcy5vU2hlbGxVSVNlcnZpY2Uuc2V0SGllcmFyY2h5KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vU2hlbGxVSVNlcnZpY2U7CiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgICAgfSwKCiAgICAgICAgX2RlYWN0aXZhdGVBY3Rpb25Nb2RlSW5UYWJzU3RhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG9WaWV3ID0gdGhpcy5nZXRWaWV3KCksCiAgICAgICAgICAgICAgICBvTW9kZWwgPSBvVmlldy5nZXRNb2RlbCgpLAogICAgICAgICAgICAgICAgaTsKICAgICAgICAgICAgLy8gRmlyc3QgcmVzZXQgdGhlIGlzR3JvdXBTZWxlY3RlZCBwcm9wZXJ0eSBmb3IgYWxsIGdyb3Vwcy4KICAgICAgICAgICAgdmFyIGFHcm91cHMgPSBvTW9kZWwuZ2V0UHJvcGVydHkoIi9ncm91cHMiKTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGFHcm91cHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIG9Nb2RlbC5zZXRQcm9wZXJ0eSgiL2dyb3Vwcy8iICsgaSArICIvaXNHcm91cFNlbGVjdGVkIiwgZmFsc2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgc2VsZWN0ZWRJbmRleCA9IG9WaWV3Lm9BbmNob3JOYXZpZ2F0aW9uQmFyLmdldFNlbGVjdGVkSXRlbUluZGV4KCk7CgogICAgICAgICAgICB2YXIgaUhpZGRlbkdyb3Vwc0NvdW50ID0gMDsKICAgICAgICAgICAgLy8gSWYgdGhlIHNlbGVjdGVkIGdyb3VwIGlzIGEgaGlkZGVuIGdyb3VwLCBnbyB0byB0aGUgZmlyc3QgdmlzaWJsZSBncm91cAogICAgICAgICAgICBpZiAoIXRoaXMuX2lzR3JvdXBWaXNpYmxlKHNlbGVjdGVkSW5kZXgpKSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYUdyb3Vwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5faXNHcm91cFZpc2libGUoaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaUhpZGRlbkdyb3Vwc0NvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIENvdW50IGFsbCBoaWRkZW4gZ3JvdXBzIHRoYXQgYXJlIGxvY2F0ZWQgYmVmb3JlIHRoZSBzZWxlY3RlZCBncm91cAogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlbGVjdGVkSW5kZXg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5faXNHcm91cFZpc2libGUoaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaUhpZGRlbkdyb3Vwc0NvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaXggdGhlIHNlbGVjdGVkIGluZGV4IG5vdCB0byBpbmNsdWRlIHRoZSBoaWRkZW4gZ3JvdXBzCiAgICAgICAgICAgIHZhciBmaXhlZEluZGV4ID0gc2VsZWN0ZWRJbmRleCAtIGlIaWRkZW5Hcm91cHNDb3VudDsKICAgICAgICAgICAgLy8gQ2hhbmdlIHRoZSBhbmNob3IgYmFyIHNlbGVjdGlvbgogICAgICAgICAgICBvVmlldy5vQW5jaG9yTmF2aWdhdGlvbkJhci5hZGp1c3RJdGVtU2VsZWN0aW9uKGZpeGVkSW5kZXgpOwogICAgICAgICAgICBvVmlldy5vQW5jaG9yTmF2aWdhdGlvbkJhci5zZXRTZWxlY3RlZEl0ZW1JbmRleChmaXhlZEluZGV4KTsKCiAgICAgICAgICAgIC8vIFNldCB0aGUgc2VsZWN0ZWQgZ3JvdXAgYW5kIHRoZW4gZmlsdGVyCiAgICAgICAgICAgIG9Nb2RlbC5zZXRQcm9wZXJ0eSgiL2dyb3Vwcy8iICsgc2VsZWN0ZWRJbmRleCArICIvaXNHcm91cFNlbGVjdGVkIiwgdHJ1ZSk7CiAgICAgICAgICAgIG9WaWV3Lm9EYXNoYm9hcmRHcm91cHNCb3gucmVtb3ZlTGlua3NGcm9tQWxsR3JvdXBzKCk7CgogICAgICAgICAgICB2YXIgc0dyb3Vwc01vZGUgPSBvTW9kZWwuZ2V0UHJvcGVydHkoIi9ob21lUGFnZUdyb3VwRGlzcGxheSIpOwogICAgICAgICAgICBpZiAoc0dyb3Vwc01vZGUgJiYgc0dyb3Vwc01vZGUgPT09ICJ0YWJzIikgewogICAgICAgICAgICAgICAgb1ZpZXcub0Rhc2hib2FyZEdyb3Vwc0JveC5nZXRCaW5kaW5nKCJncm91cHMiKS5maWx0ZXIoW29WaWV3Lm9GaWx0ZXJTZWxlY3RlZEdyb3VwXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfaXNHcm91cFZpc2libGU6IGZ1bmN0aW9uIChncm91cEluZGV4KSB7CiAgICAgICAgICAgIHZhciBhR3JvdXBzID0gdGhpcy5nZXRWaWV3KCkuZ2V0TW9kZWwoKS5nZXRQcm9wZXJ0eSgiL2dyb3VwcyIpOwogICAgICAgICAgICByZXR1cm4gKGFHcm91cHNbZ3JvdXBJbmRleF0uaXNHcm91cFZpc2libGUgJiYgYUdyb3Vwc1tncm91cEluZGV4XS52aXNpYmlsaXR5TW9kZXNbMF0pOwogICAgICAgIH0KICAgIH0pOwp9KTsKfSwKCSJzYXAvdXNoZWxsL2NvbXBvbmVudHMvaG9tZXBhZ2UvRGFzaGJvYXJkQ29udGVudC52aWV3LmpzIjpmdW5jdGlvbigpey8vICR7Y29weXJpZ2h0fQoKLyoqCiAqIEBmaWxlT3ZlcnZpZXcgVGhlIEZpb3JpIGxhdW5jaHBhZCBtYWluIHZpZXcuPGJyPgogKiBUaGUgdmlldyBpcyBvZiB0eXBlIDxjb2RlPnNhcC51aS5qc3ZpZXc8L2NvZGU+IHRoYXQgaW5jbHVkZXMgYSA8Y29kZT5zYXAubS5wYWdlPC9jb2RlPgogKiB3aXRoIGEgaGVhZGVyIG9mIHR5cGUgPGNvZGU+c2FwLnVzaGVsbC51aS5sYXVuY2hwYWQuQW5jaG9yTmF2aWdhdGlvbkJhcjwvY29kZT4KICogYW5kIGNvbnRlbnQgb2YgdHlwZSA8Y29kZT5zYXAudXNoZWxsLnVpLmxhdW5jaHBhZC5EYXNoYm9hcmRHcm91cHNDb250YWluZXI8L2NvZGU+LgogKgogKiBAdmVyc2lvbiAke3ZlcnNpb259CiAqIEBuYW1lIHNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5EYXNoYm9hcmRDb250ZW50LnZpZXcKICogQHByaXZhdGUKICovCnNhcC51aS5kZWZpbmUoWwogICAgInNhcC91aS90aGlyZHBhcnR5L2pxdWVyeSIsCiAgICAic2FwL20vbGlicmFyeSIsCiAgICAic2FwL20vUGFnZSIsCiAgICAic2FwL3VpL2NvcmUvQWNjZXNzaWJsZUxhbmRtYXJrUm9sZSIsCiAgICAic2FwL3VpL2NvcmUvbXZjL1ZpZXciLAogICAgInNhcC91aS9EZXZpY2UiLAogICAgInNhcC91aS9tb2RlbC9GaWx0ZXIiLAogICAgInNhcC91c2hlbGwvY29tcG9uZW50cy9ob21lcGFnZS9EYXNoYm9hcmRHcm91cHNCb3giLAogICAgInNhcC91c2hlbGwvQ29uZmlnIiwKICAgICJzYXAvdXNoZWxsL0V2ZW50SHViIiwKICAgICJzYXAvdXNoZWxsL3Jlc291cmNlcyIsCiAgICAic2FwL3VzaGVsbC91aS9sYXVuY2hwYWQvQW5jaG9ySXRlbSIsCiAgICAic2FwL3VzaGVsbC91aS9sYXVuY2hwYWQvQW5jaG9yTmF2aWdhdGlvbkJhciIsCiAgICAic2FwL3VzaGVsbC91dGlscyIsCiAgICAic2FwL3VpL2NvcmUvQ29tcG9uZW50IiwKICAgICJzYXAvdWkvbW9kZWwvRmlsdGVyT3BlcmF0b3IiCl0sIGZ1bmN0aW9uICgKICAgIGpRdWVyeSwKICAgIG9NTGliLAogICAgUGFnZSwKICAgIEFjY2Vzc2libGVMYW5kbWFya1JvbGUsCiAgICBWaWV3LAogICAgRGV2aWNlLAogICAgRmlsdGVyLAogICAgRGFzaGJvYXJkR3JvdXBzQm94LAogICAgQ29uZmlnLAogICAgRXZlbnRIdWIsCiAgICByZXNvdXJjZXMsCiAgICBBbmNob3JJdGVtLAogICAgQW5jaG9yTmF2aWdhdGlvbkJhciwKICAgIHV0aWxzLAogICAgQ29tcG9uZW50LAogICAgRmlsdGVyT3BlcmF0b3IKKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgc2FwLnVpLmpzdmlldygic2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLkRhc2hib2FyZENvbnRlbnQiLCB7CiAgICAgICAgLyoKICAgICAgICAqIENyZWF0aW5nIHRoZSBjb250ZW50IG9mIHRoZSBtYWluIGRhc2hib2FyZCB2aWV3LgogICAgICAgICogVGhlIHZpZXcgaXMgYmFzaWNhbGx5IGEgc2FwLm0uUGFnZSBjb250cm9sIHRoYXQgY29udGFpbnM6CiAgICAgICAgKiAgLSBBbmNob3JOYXZpZ2F0aW9uQmFyIGFzIGhlYWRlci4KICAgICAgICAqICAtIERhc2hib2FyZEdyb3Vwc0JveCB0aGF0IGNvbnRhaW5zIHRoZSBncm91cHMgYW5kIHRpbGVzIGFzIGNvbnRlbnQuCiAgICAgICAgKiAgLSBCYXIgaW4gdGhlIGZvb3RlciBpZiBlZGl0IG1vZGUgaXMgZW5hYmxlZC4KICAgICAgICAqLwogICAgICAgIGNyZWF0ZUNvbnRlbnQ6IGZ1bmN0aW9uIChvQ29udHJvbGxlcikgewogICAgICAgICAgICB0aGlzLm9Nb2RlbCA9IHRoaXMuZ2V0TW9kZWwoKTsKCiAgICAgICAgICAgIHZhciBiRW5hYmxlUGVyc29uYWxpemF0aW9uID0gdGhpcy5vTW9kZWwuZ2V0UHJvcGVydHkoIi9wZXJzb25hbGl6YXRpb24iKSwKICAgICAgICAgICAgICAgIG9Ib21lcGFnZU1hbmFnZXIgPSBzYXAudXNoZWxsLmNvbXBvbmVudHMuZ2V0SG9tZXBhZ2VNYW5hZ2VyID8gc2FwLnVzaGVsbC5jb21wb25lbnRzLmdldEhvbWVwYWdlTWFuYWdlcigpIDogdW5kZWZpbmVkOwoKICAgICAgICAgICAgdGhpcy5pc0NvbWJpID0gRGV2aWNlLnN5c3RlbS5jb21iaTsKICAgICAgICAgICAgdGhpcy5pc1RvdWNoID0gdGhpcy5pc0NvbWJpID8gZmFsc2UgOiAoRGV2aWNlLnN5c3RlbS5waG9uZSB8fCBEZXZpY2Uuc3lzdGVtLnRhYmxldCk7CiAgICAgICAgICAgIHRoaXMucGFyZW50Q29tcG9uZW50ID0gQ29tcG9uZW50LmdldE93bmVyQ29tcG9uZW50Rm9yKHRoaXMpOwogICAgICAgICAgICB0aGlzLmFkZFN0eWxlQ2xhc3MoInNhcFVzaGVsbERhc2hib2FyZFZpZXciKTsKICAgICAgICAgICAgdGhpcy5pZUh0bWw1RG5EID0gYkVuYWJsZVBlcnNvbmFsaXphdGlvbiAmJiBvSG9tZXBhZ2VNYW5hZ2VyICYmIG9Ib21lcGFnZU1hbmFnZXIuaXNJZUh0bWw1RG5EKCk7CiAgICAgICAgICAgIHRoaXMub1JlbmRlcmVyID0gc2FwLnVzaGVsbC5Db250YWluZXIuZ2V0UmVuZGVyZXIoImZpb3JpMiIpOwoKICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZSgibGF1bmNocGFkIiwgImFjdGlvbk1vZGVJbmFjdGl2ZSIsIHRoaXMuX2hhbmRsZUVkaXRNb2RlQ2hhbmdlLCB0aGlzKTsKICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZSgibGF1bmNocGFkIiwgImFjdGlvbk1vZGVBY3RpdmUiLCB0aGlzLl9oYW5kbGVFZGl0TW9kZUNoYW5nZSwgdGhpcyk7CiAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoImxhdW5jaHBhZCIsICJjb250ZW50UmVmcmVzaCIsIHRoaXMuX29uRGFzaGJvYXJkU2hvd24sIHRoaXMpOwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEluIG9yZGVyIHRvIHNhdmUgcGVyZm9ybWFuY2Ugd2UgZGVsYXkgdGhlIGFjdGlvbm1vZGUsIHRoZSBmb290ZXIgY3JlYXRpb24gYW5kIHRoZSBvdmVyZmxvdyBvZiB0aGUgYW5jaG9yQmFyCiAgICAgICAgICAgICAqIHRpbGwgY29yZS1leHQgZmlsZSBoYXMgYmVlbiBsb2FkZWQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB0aGlzLm9Eb2FibGUgPSBFdmVudEh1Yi5vbmNlKCJDb3JlUmVzb3VyY2VzQ29tcGxlbWVudExvYWRlZCIpLmRvKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMub0FuY2hvck5hdmlnYXRpb25CYXIuc2V0T3ZlcmZsb3dFbmFibGVkKHRydWUpOwoKICAgICAgICAgICAgICAgIGlmIChiRW5hYmxlUGVyc29uYWxpemF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgc2FwLnVpLnJlcXVpcmUoWyJzYXAvdXNoZWxsL2NvbXBvbmVudHMvaG9tZXBhZ2UvQWN0aW9uTW9kZSJdLCBmdW5jdGlvbiAoQWN0aW9uTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBBY3Rpb25Nb2RlLmluaXQodGhpcy5vTW9kZWwpOwogICAgICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUZvb3RlcigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NyZWF0ZUFjdGlvbk1vZGVNZW51QnV0dG9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7CgogICAgICAgICAgICB0aGlzLm9SZW5kZXJlci5nZXRSb3V0ZXIoKS5nZXRSb3V0ZSgiaG9tZSIpLmF0dGFjaE1hdGNoZWQodGhpcy5fb25EYXNoYm9hcmRTaG93biwgdGhpcyk7CgogICAgICAgICAgICB0aGlzLm9BbmNob3JOYXZpZ2F0aW9uQmFyID0gdGhpcy5fZ2V0QW5jaG9yTmF2aWdhdGlvbkJhcihvQ29udHJvbGxlcik7CgogICAgICAgICAgICB2YXIgb0Rhc2hib2FyZEdyb3Vwc0JveE1vZHVsZSA9IG5ldyBEYXNoYm9hcmRHcm91cHNCb3goKTsKICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBEYXNoYm9hcmRHcm91cHNCb3ggb2JqZWN0IHRoYXQgY29udGFpbnMgZ3JvdXBzIGFuZCB0aWxlcwogICAgICAgICAgICB0aGlzLm9EYXNoYm9hcmRHcm91cHNCb3ggPSBvRGFzaGJvYXJkR3JvdXBzQm94TW9kdWxlLmNyZWF0ZUdyb3Vwc0JveChvQ29udHJvbGxlciwgdGhpcy5vTW9kZWwpOwoKICAgICAgICAgICAgdGhpcy5vRmlsdGVyU2VsZWN0ZWRHcm91cCA9IG5ldyBGaWx0ZXIoImlzR3JvdXBTZWxlY3RlZCIsIEZpbHRlck9wZXJhdG9yLkVRLCB0cnVlKTsKCiAgICAgICAgICAgIHRoaXMub1BhZ2UgPSBuZXcgUGFnZSgic2FwVXNoZWxsRGFzaGJvYXJkUGFnZSIsIHsKICAgICAgICAgICAgICAgIGN1c3RvbUhlYWRlcjogdGhpcy5vQW5jaG9yTmF2aWdhdGlvbkJhciwKICAgICAgICAgICAgICAgIGxhbmRtYXJrSW5mbzogeyBoZWFkZXJSb2xlOiBBY2Nlc3NpYmxlTGFuZG1hcmtSb2xlLk5hdmlnYXRpb24gfSwKICAgICAgICAgICAgICAgIGZsb2F0aW5nRm9vdGVyOiB0cnVlLAogICAgICAgICAgICAgICAgY29udGVudDogW3RoaXMub0Rhc2hib2FyZEdyb3Vwc0JveF0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLm9QYWdlLmFkZEV2ZW50RGVsZWdhdGUoewogICAgICAgICAgICAgICAgb25BZnRlclJlbmRlcmluZzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBvRG9tUmVmID0gdGhpcy5nZXREb21SZWYoKSwKICAgICAgICAgICAgICAgICAgICAgICAgb1Njcm9sbGFibGVFbGVtZW50ID0gb0RvbVJlZi5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2VjdGlvbiIpOwoKICAgICAgICAgICAgICAgICAgICBqUXVlcnkob1Njcm9sbGFibGVFbGVtZW50WzBdKS5vZmYoInNjcm9sbHN0b3AiLCBvQ29udHJvbGxlci5oYW5kbGVEYXNoYm9hcmRTY3JvbGwpOwogICAgICAgICAgICAgICAgICAgIGpRdWVyeShvU2Nyb2xsYWJsZUVsZW1lbnRbMF0pLm9uKCJzY3JvbGxzdG9wIiwgb0NvbnRyb2xsZXIuaGFuZGxlRGFzaGJvYXJkU2Nyb2xsKTsKICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLm9QYWdlOwogICAgICAgIH0sCgogICAgICAgIGdldEFuY2hvckl0ZW1UZW1wbGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBiSGVscEVuYWJsZWQgPSBDb25maWcubGFzdCgiL2NvcmUvZXh0ZW5zaW9uL2VuYWJsZUhlbHAiKTsKICAgICAgICAgICAgdmFyIG9BbmNob3JJdGVtVGVtcGxhdGUgPSBuZXcgQW5jaG9ySXRlbSh7CiAgICAgICAgICAgICAgICBpbmRleDogIntpbmRleH0iLAogICAgICAgICAgICAgICAgdGl0bGU6ICJ7dGl0bGV9IiwKICAgICAgICAgICAgICAgIGdyb3VwSWQ6ICJ7Z3JvdXBJZH0iLAogICAgICAgICAgICAgICAgZGVmYXVsdEdyb3VwOiAie2lzRGVmYXVsdEdyb3VwfSIsCiAgICAgICAgICAgICAgICB3cml0ZUhlbHBJZDogYkhlbHBFbmFibGVkLAogICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgaXNHcm91cFJlbmRlcmVkOiAie2lzUmVuZGVyZWR9IiwKICAgICAgICAgICAgICAgIHZpc2libGU6IHsKICAgICAgICAgICAgICAgICAgICBwYXJ0czogWyIvdGlsZUFjdGlvbk1vZGVBY3RpdmUiLCAiaXNHcm91cFZpc2libGUiLCAidmlzaWJpbGl0eU1vZGVzIl0sCiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyOiBmdW5jdGlvbiAodGlsZUFjdGlvbk1vZGVBY3RpdmUsIGlzR3JvdXBWaXNpYmxlLCB2aXNpYmlsaXR5TW9kZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRW1wdHkgZ3JvdXBzIHNob3VsZCBub3QgYmUgZGlzcGxheWVkIHdoZW4gcGVyc29uYWxpemF0aW9uIGlzIG9mZiBvcgogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGV5IGFyZSBsb2NrZWQgb3IgZGVmYXVsdCBncm91cCBub3QgaW4gYWN0aW9uIG1vZGUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2aXNpYmlsaXR5TW9kZXNbdGlsZUFjdGlvbk1vZGVBY3RpdmUgPyAxIDogMF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNHcm91cFZpc2libGUgfHwgdGlsZUFjdGlvbk1vZGVBY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGxvY2tlZDogIntpc0dyb3VwTG9ja2VkfSIsCiAgICAgICAgICAgICAgICBpc0dyb3VwRGlzYWJsZWQ6IHsKICAgICAgICAgICAgICAgICAgICBwYXJ0czogWyJpc0dyb3VwTG9ja2VkIiwgIi9pc0luRHJhZyIsICIvaG9tZVBhZ2VHcm91cERpc3BsYXkiXSwKICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6IGZ1bmN0aW9uIChiSXNHcm91cExvY2tlZCwgYklzSW5EcmFnLCBzQW5jaG9yYmFyTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYklzR3JvdXBMb2NrZWQgJiYgYklzSW5EcmFnICYmIHNBbmNob3JiYXJNb2RlID09PSAidGFicyI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHByZXNzOiBmdW5jdGlvbiAob0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5vQW5jaG9yTmF2aWdhdGlvbkJhci5oYW5kbGVBbmNob3JJdGVtUHJlc3Mob0V2ZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBvQW5jaG9ySXRlbVRlbXBsYXRlLmF0dGFjaEJyb3dzZXJFdmVudCgiZm9jdXMiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldE5hdmlnYXRpb25CYXJJdGVtc1Zpc2liaWxpdHkoKTsKICAgICAgICAgICAgfS5iaW5kKHRoaXMub0FuY2hvck5hdmlnYXRpb25CYXIpKTsKCiAgICAgICAgICAgIHJldHVybiBvQW5jaG9ySXRlbVRlbXBsYXRlOwogICAgICAgIH0sCgogICAgICAgIF9nZXRBbmNob3JOYXZpZ2F0aW9uQmFyOiBmdW5jdGlvbiAob0NvbnRyb2xsZXIpIHsKICAgICAgICAgICAgdmFyIG9BbmNob3JOYXZpZ2F0aW9uQmFyID0gbmV3IEFuY2hvck5hdmlnYXRpb25CYXIoImFuY2hvck5hdmlnYXRpb25CYXIiLCB7CiAgICAgICAgICAgICAgICBzZWxlY3RlZEl0ZW1JbmRleDogInsvdG9wR3JvdXBJblZpZXdQb3J0SW5kZXh9IiwKICAgICAgICAgICAgICAgIGl0ZW1QcmVzczogW2Z1bmN0aW9uIChvRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oYW5kbGVBbmNob3JJdGVtUHJlc3Mob0V2ZW50KTsKICAgICAgICAgICAgICAgIH0sIG9Db250cm9sbGVyXSwKICAgICAgICAgICAgICAgIG92ZXJmbG93RW5hYmxlZDogZmFsc2UgLy8gd2Ugd2lsbCBlbmFibGUgdGhlIG92ZXJmbG93IG9uY2UgY29yZUV4dCB3aWxsIGJlIGxvYWRlZCEhIQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChEZXZpY2Uuc3lzdGVtLmRlc2t0b3ApIHsKICAgICAgICAgICAgICAgIG9BbmNob3JOYXZpZ2F0aW9uQmFyLmFkZEV2ZW50RGVsZWdhdGUoewogICAgICAgICAgICAgICAgICAgIG9uc2Fwc2tpcGZvcndhcmQ6IGZ1bmN0aW9uIChvRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNhcC51c2hlbGwucmVuZGVyZXJzLmZpb3JpMi5BY2Nlc3NLZXlzSGFuZGxlci5zZXRJc0ZvY3VzSGFuZGxlZEJ5QW5vdGhlckhhbmRsZXIodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNhcC51c2hlbGwuY29tcG9uZW50cy5Db21wb25lbnRLZXlzSGFuZGxlci5nb1RvVGlsZUNvbnRhaW5lcihvRXZlbnQsIHRoaXMuYkdyb3VwV2FzUHJlc3NlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYkdyb3VwV2FzUHJlc3NlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgb25zYXBza2lwYmFjazogZnVuY3Rpb24gKG9FdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBvRXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5yZW5kZXJlcnMuZmlvcmkyLkFjY2Vzc0tleXNIYW5kbGVyLnNldElzRm9jdXNIYW5kbGVkQnlBbm90aGVySGFuZGxlcih0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5yZW5kZXJlcnMuZmlvcmkyLkFjY2Vzc0tleXNIYW5kbGVyLnNlbmRGb2N1c0JhY2tUb1NoZWxsKG9FdmVudCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBvbnNhcGVudGVyOiBmdW5jdGlvbiAob0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9FdmVudC5zcmNDb250cm9sLmdldERvbVJlZigpLmNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBvbnNhcHNwYWNlOiBmdW5jdGlvbiAob0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9FdmVudC5zcmNDb250cm9sLmdldERvbVJlZigpLmNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9BbmNob3JOYXZpZ2F0aW9uQmFyLmFkZFN0eWxlQ2xhc3MoInNhcENvbnRyYXN0UGx1cyIpOwoKICAgICAgICAgICAgcmV0dXJuIG9BbmNob3JOYXZpZ2F0aW9uQmFyOwogICAgICAgIH0sCgogICAgICAgIF9hY3Rpb25Nb2RlQnV0dG9uUHJlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5vRGFzaGJvYXJkR3JvdXBzQm94LmdldEJpbmRpbmcoImdyb3VwcyIpLmZpbHRlcihbXSk7IC8vIHJlcGxhY2UgbW9kZWwgZmlsdGVyIGlub3JkZXIgdG8gc2hvdyBoaWRkZW4gZ3JvdXBzCiAgICAgICAgICAgIHZhciBkYXNoYm9hcmRHcm91cHMgPSB0aGlzLm9EYXNoYm9hcmRHcm91cHNCb3guZ2V0R3JvdXBzKCk7CiAgICAgICAgICAgIHNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5BY3Rpb25Nb2RlLnRvZ2dsZUFjdGlvbk1vZGUodGhpcy5vTW9kZWwsICJNZW51IEl0ZW0iLCBkYXNoYm9hcmRHcm91cHMpOwogICAgICAgICAgICB0aGlzLm9BbmNob3JOYXZpZ2F0aW9uQmFyLnVwZGF0ZVZpc2liaWxpdHkoKTsKICAgICAgICAgICAgaWYgKHRoaXMub01vZGVsLmdldFByb3BlcnR5KCIvaG9tZVBhZ2VHcm91cERpc3BsYXkiKSA9PT0gInRhYnMiKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vTW9kZWwuZ2V0UHJvcGVydHkoIi90aWxlQWN0aW9uTW9kZUFjdGl2ZSIpKSB7IC8vIFRvIGVkaXQgbW9kZQogICAgICAgICAgICAgICAgICAgIC8vIGZpbmQgdGhlIHNlbGVjdGVkIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgdmFyIGFHcm91cHMgPSB0aGlzLm9Nb2RlbC5nZXRQcm9wZXJ0eSgiL2dyb3VwcyIpLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEdyb3VwOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYUdyb3Vwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYUdyb3Vwc1tpXS5pc0dyb3VwU2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkR3JvdXAgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gc2Nyb2xsIHRvIHNlbGVjdGVkIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRDb250cm9sbGVyKCkuX3Njcm9sbFRvR3JvdXAoImxhdW5jaHBhZCIsICJzY3JvbGxUb0dyb3VwIiwgewogICAgICAgICAgICAgICAgICAgICAgICBncm91cDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0R3JvdXBJZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhR3JvdXBzW3NlbGVjdGVkR3JvdXBdLmdyb3VwSWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwQ2hhbmdlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBUbyBub24tZWRpdCBtb2RlCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRDb250cm9sbGVyKCkuX2RlYWN0aXZhdGVBY3Rpb25Nb2RlSW5UYWJzU3RhdGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9jcmVhdGVBY3Rpb25Nb2RlTWVudUJ1dHRvbjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgb0FjdGlvbkJ1dHRvbk9iamVjdERhdGEgPSB7CiAgICAgICAgICAgICAgICBpZDogIkFjdGlvbk1vZGVCdG4iLAogICAgICAgICAgICAgICAgdGV4dDogcmVzb3VyY2VzLmkxOG4uZ2V0VGV4dCgiYWN0aXZhdGVFZGl0TW9kZSIpLAogICAgICAgICAgICAgICAgaWNvbjogInNhcC1pY29uOi8vZWRpdCIsCiAgICAgICAgICAgICAgICBwcmVzczogdGhpcy5fYWN0aW9uTW9kZUJ1dHRvblByZXNzLmJpbmQodGhpcykKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIGluIGNhc2UgdGhlIGVkaXQgaG9tZSBwYWdlIGJ1dHRvbiB3YXMgbW92ZWQgdG8gdGhlIHNoZWxsIGhlYWRlciwKICAgICAgICAgICAgLy8gaXQgd2FzIGFscmVhZHkgY3JlYXRlZCBhcyBhbiBzaGVsbCBIZWFkIEl0ZW0gaW4gQ29udHJvbGwgTWFuYWdlcgogICAgICAgICAgICAvLyBvbmx5IGhlcmUgd2UgaGF2ZSBhY2Nlc3MgdG8gdGhlIHRleHQgYW5kIHByZXNzIG1ldGhvZAogICAgICAgICAgICB0aGlzLm9UaWxlQWN0aW9uc0J1dHRvbiA9IHNhcC51aS5nZXRDb3JlKCkuYnlJZChvQWN0aW9uQnV0dG9uT2JqZWN0RGF0YS5pZCk7CiAgICAgICAgICAgIGlmICh0aGlzLm9UaWxlQWN0aW9uc0J1dHRvbikgewogICAgICAgICAgICAgICAgdGhpcy5vVGlsZUFjdGlvbnNCdXR0b24uc2V0VG9vbHRpcChvQWN0aW9uQnV0dG9uT2JqZWN0RGF0YS50ZXh0KTsKICAgICAgICAgICAgICAgIHRoaXMub1RpbGVBY3Rpb25zQnV0dG9uLnNldFRleHQob0FjdGlvbkJ1dHRvbk9iamVjdERhdGEudGV4dCk7CiAgICAgICAgICAgICAgICB0aGlzLm9UaWxlQWN0aW9uc0J1dHRvbi5hdHRhY2hQcmVzcyhvQWN0aW9uQnV0dG9uT2JqZWN0RGF0YS5wcmVzcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgb0FkZEFjdGlvbkJ1dHRvblBhcmFtZXRlcnMgPSB7CiAgICAgICAgICAgICAgICAgICAgY29udHJvbFR5cGU6ICJzYXAudXNoZWxsLnVpLmxhdW5jaHBhZC5BY3Rpb25JdGVtIiwKICAgICAgICAgICAgICAgICAgICBvQ29udHJvbFByb3BlcnRpZXM6IG9BY3Rpb25CdXR0b25PYmplY3REYXRhLAogICAgICAgICAgICAgICAgICAgIGJJc1Zpc2libGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYVN0YXRlczogWyJob21lIl0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdGhpcy5vUmVuZGVyZXIuYWRkVXNlckFjdGlvbihvQWRkQWN0aW9uQnV0dG9uUGFyYW1ldGVycykuZG9uZShmdW5jdGlvbiAob0FjdGlvbkJ1dHRvbikgewogICAgICAgICAgICAgICAgICAgIHRoaXMub1RpbGVBY3Rpb25zQnV0dG9uID0gb0FjdGlvbkJ1dHRvbjsKICAgICAgICAgICAgICAgICAgICAvLyBpZiB4UmF5IGlzIGVuYWJsZWQKICAgICAgICAgICAgICAgICAgICBpZiAoQ29uZmlnLmxhc3QoIi9jb3JlL2V4dGVuc2lvbi9lbmFibGVIZWxwIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vVGlsZUFjdGlvbnNCdXR0b24uYWRkU3R5bGVDbGFzcygiaGVscC1pZC1BY3Rpb25Nb2RlQnRuIik7Ly8geFJheSBoZWxwIElECiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9oYW5kbGVFZGl0TW9kZUNoYW5nZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAodGhpcy5vVGlsZUFjdGlvbnNCdXR0b24pIHsKICAgICAgICAgICAgICAgIHRoaXMub1RpbGVBY3Rpb25zQnV0dG9uLnRvZ2dsZVN0eWxlQ2xhc3MoInNhcFVzaGVsbEFjaW9uSXRlbUFjdGl2ZSIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NyZWF0ZUZvb3RlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzYXAudWkucmVxdWlyZShbCiAgICAgICAgICAgICAgICAic2FwL20vQmFyIiwKICAgICAgICAgICAgICAgICJzYXAvbS9CdXR0b24iLAogICAgICAgICAgICAgICAgInNhcC9tL1Rvb2xiYXJTcGFjZXIiCiAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChCYXIsIEJ1dHRvbiwgVG9vbGJhclNwYWNlcikgewogICAgICAgICAgICAgICAgdmFyIG9Gb290ZXIgPSBuZXcgQmFyKCJzYXBVc2hlbGxEYXNoYm9hcmRGb290ZXIiLCB7CiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogInsvdGlsZUFjdGlvbk1vZGVBY3RpdmV9IiwKICAgICAgICAgICAgICAgICAgICBjb250ZW50UmlnaHQ6IFtuZXcgVG9vbGJhclNwYWNlcigpXQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgdmFyIG9Eb25lQnRuID0gbmV3IEJ1dHRvbigic2FwVXNoZWxsRGFzaGJvYXJkRm9vdGVyRG9uZUJ0biIsIHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBvTUxpYi5CdXR0b25UeXBlLkVtcGhhc2l6ZWQsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogcmVzb3VyY2VzLmkxOG4uZ2V0VGV4dCgiY2xvc2VFZGl0TW9kZSIpLAogICAgICAgICAgICAgICAgICAgIHRvb2x0aXA6IHJlc291cmNlcy5pMThuLmdldFRleHQoImV4aXRFZGl0TW9kZSIpLAogICAgICAgICAgICAgICAgICAgIHByZXNzOiB0aGlzLl9hY3Rpb25Nb2RlQnV0dG9uUHJlc3MuYmluZCh0aGlzKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpZiAoRGV2aWNlLnN5c3RlbS5kZXNrdG9wKSB7CiAgICAgICAgICAgICAgICAgICAgb0RvbmVCdG4uYWRkRXZlbnREZWxlZ2F0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIG9uc2Fwc2tpcGZvcndhcmQ6IGZ1bmN0aW9uIChvRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9FdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5yZW5kZXJlcnMuZmlvcmkyLkFjY2Vzc0tleXNIYW5kbGVyLnNldElzRm9jdXNIYW5kbGVkQnlBbm90aGVySGFuZGxlcih0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhcC51c2hlbGwucmVuZGVyZXJzLmZpb3JpMi5BY2Nlc3NLZXlzSGFuZGxlci5zZW5kRm9jdXNCYWNrVG9TaGVsbChvRXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBvbnNhcHNraXBiYWNrOiBmdW5jdGlvbiAob0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvRXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhcC51c2hlbGwucmVuZGVyZXJzLmZpb3JpMi5BY2Nlc3NLZXlzSGFuZGxlci5zZXRJc0ZvY3VzSGFuZGxlZEJ5QW5vdGhlckhhbmRsZXIodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXAudXNoZWxsLmNvbXBvbmVudHMuQ29tcG9uZW50S2V5c0hhbmRsZXIuZ29Ub0ZpcnN0VmlzaWJsZVRpbGVDb250YWluZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgb25zYXB0YWJwcmV2aW91czogZnVuY3Rpb24gKG9FdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXAudXNoZWxsLnJlbmRlcmVycy5maW9yaTIuQWNjZXNzS2V5c0hhbmRsZXIuc2V0SXNGb2N1c0hhbmRsZWRCeUFub3RoZXJIYW5kbGVyKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5jb21wb25lbnRzLkNvbXBvbmVudEtleXNIYW5kbGVyLmdvVG9GaXJzdFZpc2libGVUaWxlQ29udGFpbmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIG9uc2FwdGFibmV4dDogZnVuY3Rpb24gKG9FdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXAudXNoZWxsLnJlbmRlcmVycy5maW9yaTIuQWNjZXNzS2V5c0hhbmRsZXIuc2V0SXNGb2N1c0hhbmRsZWRCeUFub3RoZXJIYW5kbGVyKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5yZW5kZXJlcnMuZmlvcmkyLkFjY2Vzc0tleXNIYW5kbGVyLnNlbmRGb2N1c0JhY2tUb1NoZWxsKG9FdmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBvRm9vdGVyLmFkZENvbnRlbnRSaWdodChvRG9uZUJ0bik7CiAgICAgICAgICAgICAgICB0aGlzLm9QYWdlLnNldEZvb3RlcihvRm9vdGVyKTsKICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgICAgICB9LAoKICAgICAgICBfb25EYXNoYm9hcmRTaG93bjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYkluRGFzaGJvYXJkID0gdGhpcy5vUmVuZGVyZXIgJiYgdGhpcy5vUmVuZGVyZXIuZ2V0Q3VycmVudENvcmVWaWV3KCkgPT09ICJob21lIjsKCiAgICAgICAgICAgIGlmIChiSW5EYXNoYm9hcmQpIHsKICAgICAgICAgICAgICAgIGlmICghRGV2aWNlLnN5c3RlbS5waG9uZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub1JlbmRlcmVyLnNob3dSaWdodEZsb2F0aW5nQ29udGFpbmVyKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmdldENvbnRyb2xsZXIoKS5yZXNpemVIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICB1dGlscy5yZWZyZXNoVGlsZXMoKTsKICAgICAgICAgICAgICAgIGlmIChEZXZpY2Uuc3lzdGVtLmRlc2t0b3ApIHsKICAgICAgICAgICAgICAgICAgICBzYXAudXNoZWxsLmNvbXBvbmVudHMuQ29tcG9uZW50S2V5c0hhbmRsZXIuZ29Ub1RpbGVDb250YWluZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGdldENvbnRyb2xsZXJOYW1lOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiAic2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLkRhc2hib2FyZENvbnRlbnQiOwogICAgICAgIH0sCgogICAgICAgIGV4aXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgVmlldy5wcm90b3R5cGUuZXhpdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgaWYgKHRoaXMub0FuY2hvck5hdmlnYXRpb25CYXIpIHsKICAgICAgICAgICAgICAgIHRoaXMub0FuY2hvck5hdmlnYXRpb25CYXIuaGFuZGxlRXhpdCgpOwogICAgICAgICAgICAgICAgdGhpcy5vQW5jaG9yTmF2aWdhdGlvbkJhci5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMub1RpbGVBY3Rpb25zQnV0dG9uKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9UaWxlQWN0aW9uc0J1dHRvbi5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLm9Eb2FibGUpIHsKICAgICAgICAgICAgICAgIHRoaXMub0RvYWJsZS5vZmYoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMub0RvbmVCdG5MYWJlbCkgewogICAgICAgICAgICAgICAgdGhpcy5vRG9uZUJ0bkxhYmVsLmRlc3Ryb3koKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLnVuc3Vic2NyaWJlKCJsYXVuY2hwYWQiLCAiYWN0aW9uTW9kZUluYWN0aXZlIiwgdGhpcy5faGFuZGxlRWRpdE1vZGVDaGFuZ2UsIHRoaXMpOwogICAgICAgICAgICBzYXAudWkuZ2V0Q29yZSgpLmdldEV2ZW50QnVzKCkudW5zdWJzY3JpYmUoImxhdW5jaHBhZCIsICJhY3Rpb25Nb2RlQWN0aXZlIiwgdGhpcy5faGFuZGxlRWRpdE1vZGVDaGFuZ2UsIHRoaXMpOwogICAgICAgICAgICBzYXAudWkuZ2V0Q29yZSgpLmdldEV2ZW50QnVzKCkudW5zdWJzY3JpYmUoImxhdW5jaHBhZCIsICJjb250ZW50UmVmcmVzaCIsIHRoaXMuX29uRGFzaGJvYXJkU2hvd24sIHRoaXMpOwogICAgICAgIH0KICAgIH0pOwp9LCAvKiBiRXhwb3J0PSAqLyBmYWxzZSk7Cn0sCgkic2FwL3VzaGVsbC9jb21wb25lbnRzL2hvbWVwYWdlL0Rhc2hib2FyZEdyb3Vwc0JveC5qcyI6ZnVuY3Rpb24oKXsvLyAke2NvcHlyaWdodH0KCi8qKgogKiBAZmlsZU92ZXJ2aWV3IEEgbW9kdWxlIHRoYXQgaXMgcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIHRoZSBncm91cHMgcGFydCAoaS5lLiBib3gpIG9mIHRoZSBkYXNoYm9hcmQuPGJyPgogKiBFeHRlbmRzIDxjb2RlPnNhcC51aS5iYXNlLk9iamVjdDwvY29kZT48YnI+CiAqIEV4cG9zZXMgdGhlIHB1YmxpYyBmdW5jdGlvbiA8Y29kZT5jcmVhdGVHcm91cHNCb3g8L2NvZGU+CiAqIEBzZWUgc2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLkRhc2hib2FyZENvbnRlbnQudmlldwogKgogKiBAdmVyc2lvbiAke3ZlcnNpb259CiAqIEBuYW1lIHNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5EYXNoYm9hcmRHcm91cHNCb3gKICogQHNpbmNlIDEuMzUuMAogKiBAcHJpdmF0ZQogKi8Kc2FwLnVpLmRlZmluZShbCiAgICAic2FwL3VzaGVsbC9MYXlvdXQiLAogICAgInNhcC91aS9iYXNlL09iamVjdCIsCiAgICAic2FwL3VpL21vZGVsL0ZpbHRlciIsCiAgICAic2FwL3VpL21vZGVsL0ZpbHRlck9wZXJhdG9yIiwKICAgICJzYXAvdXNoZWxsL3VpL2xhdW5jaHBhZC9UaWxlIiwKICAgICJzYXAvdXNoZWxsL3VpL2xhdW5jaHBhZC9EYXNoYm9hcmRHcm91cHNDb250YWluZXIiLAogICAgInNhcC91c2hlbGwvQ29uZmlnIiwKICAgICJzYXAvdXNoZWxsL0V2ZW50SHViIiwKICAgICJzYXAvdXNoZWxsL3V0aWxzIiwKICAgICJzYXAvdWkvY29yZS9Db21wb25lbnQiLAogICAgInNhcC9tL0dlbmVyaWNUaWxlIiwKICAgICJzYXAvdWkvRGV2aWNlIiwKICAgICJzYXAvdXNoZWxsL3VpL2xhdW5jaHBhZC9QbHVzVGlsZSIsCiAgICAic2FwL3VzaGVsbC9yZXNvdXJjZXMiLAogICAgInNhcC91c2hlbGwvdWkvbGF1bmNocGFkL1RpbGVDb250YWluZXIiLAogICAgInNhcC91c2hlbGwvdWkvbGF1bmNocGFkL0xpbmtUaWxlV3JhcHBlciIsCiAgICAic2FwL20vQnV0dG9uIiwKICAgICJzYXAvdXNoZWxsL3VpL2xhdW5jaHBhZC9BY2Nlc3NpYmlsaXR5Q3VzdG9tRGF0YSIsCiAgICAic2FwL3VzaGVsbC91aS9sYXVuY2hwYWQvR3JvdXBIZWFkZXJBY3Rpb25zIiwKICAgICJzYXAvYmFzZS91dGlsL2lzRW1wdHlPYmplY3QiLAogICAgInNhcC91aS90aGlyZHBhcnR5L2pxdWVyeSIsCiAgICAic2FwL3VpL3BlcmZvcm1hbmNlL01lYXN1cmVtZW50IgpdLCBmdW5jdGlvbiAoCiAgICBMYXlvdXQsCiAgICBiYXNlT2JqZWN0LAogICAgRmlsdGVyLAogICAgRmlsdGVyT3BlcmF0b3IsCiAgICBMYXVuY2hwYWRUaWxlLAogICAgRGFzaGJvYXJkR3JvdXBzQ29udGFpbmVyLAogICAgQ29uZmlnLAogICAgRXZlbnRIdWIsCiAgICB1dGlscywKICAgIENvbXBvbmVudCwKICAgIEdlbmVyaWNUaWxlLAogICAgRGV2aWNlLAogICAgUGx1c1RpbGUsCiAgICByZXNvdXJjZXMsCiAgICBUaWxlQ29udGFpbmVyLAogICAgTGlua1RpbGVXcmFwcGVyLAogICAgQnV0dG9uLAogICAgQWNjZXNzaWJpbGl0eUN1c3RvbURhdGEsCiAgICBHcm91cEhlYWRlckFjdGlvbnMsCiAgICBpc0VtcHR5T2JqZWN0LAogICAgalF1ZXJ5LAogICAgTWVhc3VyZW1lbnQKKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwoKICAgICAgICB2YXIgRGFzaGJvYXJkR3JvdXBzQm94ID0gYmFzZU9iamVjdC5leHRlbmQoInNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5EYXNoYm9hcmRHcm91cHNCb3giLCB7CiAgICAgICAgICAgIG1ldGFkYXRhOiB7CiAgICAgICAgICAgICAgICBwdWJsaWNNZXRob2RzOiBbImNyZWF0ZUdyb3Vwc0JveCJdCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKC8qc0lkLCBtU2V0dGluZ3MqLykgewogICAgICAgICAgICAgICAgLy8gTWFrZSB0aGlzIGNsYXNzIG9ubHkgYXZhaWxhYmxlIG9uY2UKICAgICAgICAgICAgICAgIGlmIChzYXAudXNoZWxsLmNvbXBvbmVudHMuaG9tZXBhZ2UuZ2V0RGFzaGJvYXJkR3JvdXBzQm94ICYmIHNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5nZXREYXNoYm9hcmRHcm91cHNCb3goKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBzYXAudXNoZWxsLmNvbXBvbmVudHMuaG9tZXBhZ2UuZ2V0RGFzaGJvYXJkR3JvdXBzQm94KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzYXAudXNoZWxsLmNvbXBvbmVudHMuaG9tZXBhZ2UuZ2V0RGFzaGJvYXJkR3JvdXBzQm94ID0gKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSh0aGlzLmdldEludGVyZmFjZSgpKSk7CgogICAgICAgICAgICAgICAgdGhpcy5vQ29udHJvbGxlciA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIHRoaXMub0dyb3Vwc0NvbnRhaW5lciA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIHRoaXMuaXNMaW5rUGVyc29uYWxpemF0aW9uU3VwcG9ydGVkID0gc2FwLnVzaGVsbC5Db250YWluZXIuZ2V0U2VydmljZSgiTGF1bmNoUGFnZSIpLmlzTGlua1BlcnNvbmFsaXphdGlvblN1cHBvcnRlZCgpOwoKICAgICAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoImxhdW5jaHBhZCIsICJhY3Rpb25Nb2RlQWN0aXZlIiwgdGhpcy5faGFuZGxlQWN0aW9uTW9kZUNoYW5nZSwgdGhpcyk7CiAgICAgICAgICAgICAgICBzYXAudWkuZ2V0Q29yZSgpLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKCJsYXVuY2hwYWQiLCAiYWN0aW9uTW9kZUluYWN0aXZlIiwgdGhpcy5faGFuZGxlQWN0aW9uTW9kZUNoYW5nZSwgdGhpcyk7CiAgICAgICAgICAgICAgICBzYXAudWkuZ2V0Q29yZSgpLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKCJsYXVuY2hwYWQiLCAiR3JvdXBIZWFkZXJWaXNpYmlsaXR5IiwgdGhpcy5fdXBkYXRlR3JvdXBIZWFkZXJWaXNpYmlsaXR5LCB0aGlzKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS51bnN1YnNjcmliZSgibGF1bmNocGFkIiwgImFjdGlvbk1vZGVBY3RpdmUiLCB0aGlzLl9oYW5kbGVBY3Rpb25Nb2RlQ2hhbmdlLCB0aGlzKTsKICAgICAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS51bnN1YnNjcmliZSgibGF1bmNocGFkIiwgImFjdGlvbk1vZGVJbmFjdGl2ZSIsIHRoaXMuX2hhbmRsZUFjdGlvbk1vZGVDaGFuZ2UsIHRoaXMpOwogICAgICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLnVuc3Vic2NyaWJlKCJsYXVuY2hwYWQiLCAiR3JvdXBIZWFkZXJWaXNpYmlsaXR5IiwgdGhpcy5fdXBkYXRlR3JvdXBIZWFkZXJWaXNpYmlsaXR5LCB0aGlzKTsKICAgICAgICAgICAgICAgIHNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5nZXREYXNoYm9hcmRHcm91cHNCb3ggPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjYWxjdWxhdGVGaWx0ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIGdldCB0aGUgaG9tZUdyb3VwRGlzcGxheU1vZGUgYW5kIGRvIHRoZSBmaWx0ZXIgYWNjb3JkaW5nbHkKICAgICAgICAgICAgICAgIHZhciBmaWx0ZXJzID0gW107CiAgICAgICAgICAgICAgICB2YXIgb0ZpbHRlcjsKICAgICAgICAgICAgICAgIHZhciBzR3JvdXBzTW9kZSA9IHRoaXMub01vZGVsLmdldFByb3BlcnR5KCIvaG9tZVBhZ2VHcm91cERpc3BsYXkiKSwKICAgICAgICAgICAgICAgICAgICBiRWRpdE1vZGUgPSB0aGlzLm9Nb2RlbC5nZXRQcm9wZXJ0eSgiL3RpbGVBY3Rpb25Nb2RlQWN0aXZlIik7CgogICAgICAgICAgICAgICAgaWYgKCFiRWRpdE1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc0dyb3Vwc01vZGUgJiYgc0dyb3Vwc01vZGUgPT09ICJ0YWJzIikgewogICAgICAgICAgICAgICAgICAgICAgICBvRmlsdGVyID0gbmV3IEZpbHRlcigiaXNHcm91cFNlbGVjdGVkIiwgRmlsdGVyT3BlcmF0b3IuRVEsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9GaWx0ZXIgPSBuZXcgRmlsdGVyKCJpc0dyb3VwVmlzaWJsZSIsIEZpbHRlck9wZXJhdG9yLkVRLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZmlsdGVycy5wdXNoKG9GaWx0ZXIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENyZWF0aW5nIHRoZSBncm91cHMgcGFydCAoaS5lLiBib3gpIG9mIHRoZSBkYXNoYm9hcmQKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNyZWF0ZUdyb3Vwc0JveDogZnVuY3Rpb24gKG9Db250cm9sbGVyLCBvTW9kZWwpIHsKICAgICAgICAgICAgICAgIHRoaXMub0NvbnRyb2xsZXIgPSBvQ29udHJvbGxlcjsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBmQWZ0ZXJMYXlvdXRJbml0LAogICAgICAgICAgICAgICAgICAgIGZHcm91cHNDb250YWluZXJBZnRlclJlbmRlcmluZ0hhbmRsZXIsCgogICAgICAgICAgICAgICAgICAgIGdldFBsdXNUaWxlRnJvbUdyb3VwID0gZnVuY3Rpb24gKG9Hcm91cCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3JvdXBEb21SZWYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbHVzVGlsZURvbVJlZjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9Hcm91cCAmJiAoZ3JvdXBEb21SZWYgPSBvR3JvdXAuZ2V0RG9tUmVmKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbHVzVGlsZURvbVJlZiA9IGdyb3VwRG9tUmVmLnF1ZXJ5U2VsZWN0b3IoIi5zYXBVc2hlbGxQbHVzVGlsZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBsdXNUaWxlRG9tUmVmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsdXNUaWxlRG9tUmVmOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIHJlb3JkZXJUaWxlc0NhbGxiYWNrID0gZnVuY3Rpb24gKGxheW91dEluZm8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdXNUaWxlU3RhcnRHcm91cCA9IGdldFBsdXNUaWxlRnJvbUdyb3VwKGxheW91dEluZm8uY3VycmVudEdyb3VwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsdXNUaWxlRW5kR3JvdXAgPSBnZXRQbHVzVGlsZUZyb21Hcm91cChsYXlvdXRJbmZvLmVuZEdyb3VwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzUGx1c1RpbGVWYW5pc2hSZXF1aXJlZCA9IChsYXlvdXRJbmZvLnRpbGVzW2xheW91dEluZm8udGlsZXMubGVuZ3RoIC0gMl0gPT09IGxheW91dEluZm8uaXRlbSkgfHwgKGxheW91dEluZm8uZW5kR3JvdXAuZ2V0VGlsZXMoKS5sZW5ndGggPT09IDApOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNQbHVzVGlsZVZhbmlzaFJlcXVpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0Ll9oaWRlUGx1c1RpbGUocGx1c1RpbGVFbmRHcm91cCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0Ll9zaG93UGx1c1RpbGUocGx1c1RpbGVFbmRHcm91cCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXlvdXRJbmZvLmN1cnJlbnRHcm91cCAhPT0gbGF5b3V0SW5mby5lbmRHcm91cCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5fc2hvd1BsdXNUaWxlKHBsdXNUaWxlU3RhcnRHcm91cCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8vU2luY2UgdGhlIGxheW91dCBpbml0aWFsaXphdGlvbiBpcyBhc3luYywgd2UgbmVlZCB0byBleGVjdXRlIHRoZSBiZWxvdyBmdW5jdGlvbiBhZnRlciBpbml0aWFsaXphdGlvbiBpcyBkb25lCiAgICAgICAgICAgICAgICBmQWZ0ZXJMYXlvdXRJbml0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIC8vUHJldmVudCBQbHVzIFRpbGUgaW5mbHVlbmNlIG9uIHRoZSB0aWxlcyByZW9yZGVyaW5nIGJ5IGV4Y2x1ZGUgaXQgZnJvbSB0aGUgbGF5b3V0IG1hdHJpeCBjYWxjdWxhdGlvbnMKICAgICAgICAgICAgICAgICAgICBMYXlvdXQuZ2V0TGF5b3V0RW5naW5lKCkuc2V0RXhjbHVkZWRDb250cm9sKFBsdXNUaWxlKTsKICAgICAgICAgICAgICAgICAgICAvL0hpZGUgcGx1cyB0aWxlIHdoZW4gY29sbGlzaW9uIHdpdGggaXQKICAgICAgICAgICAgICAgICAgICBMYXlvdXQuZ2V0TGF5b3V0RW5naW5lKCkuc2V0UmVvcmRlclRpbGVzQ2FsbGJhY2suY2FsbChMYXlvdXQubGF5b3V0RW5naW5lLCByZW9yZGVyVGlsZXNDYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGZHcm91cHNDb250YWluZXJBZnRlclJlbmRlcmluZ0hhbmRsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFMYXlvdXQuaXNJbml0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgTGF5b3V0LmluaXQoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0R3JvdXBzOiB0aGlzLmdldEdyb3Vwcy5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0QWxsR3JvdXBzOiB0aGF0LmdldEFsbEdyb3Vwc0Zyb21Nb2RlbC5iaW5kKHRoYXQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNUYWJCYXJBY3RpdmU6IHRoYXQuaXNUYWJCYXJBY3RpdmUuYmluZCh0aGF0KQogICAgICAgICAgICAgICAgICAgICAgICB9KS5kb25lKGZBZnRlckxheW91dEluaXQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy93aGVuIG1lZGlhIGlzIGNoYW5nZWQgd2UgbmVlZCB0byByZXJlbmRlciBMYXlvdXQKICAgICAgICAgICAgICAgICAgICAgICAgLy9tZWRpYSBjb3VsZCBiZSBjaGFuZ2VkIGJ5IFNBUFVJNSB3aXRob3V0IHJlc2l6ZSwgb3IgYW55IG90aGVyIGV2ZW50cy4gbG9vayBmb3IgaW50ZXJuYWwgSW5jaWRlbnQgSUQ6IDE1ODAwMDA2NjgKICAgICAgICAgICAgICAgICAgICAgICAgRGV2aWNlLm1lZGlhLmF0dGFjaEhhbmRsZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJJc0Rlc3Ryb3llZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExheW91dC5yZVJlbmRlckdyb3Vwc0xheW91dChudWxsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGhpcywgRGV2aWNlLm1lZGlhLlJBTkdFU0VUUy5TQVBfU1RBTkRBUkQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9Eb21SZWYgPSB0aGlzLmdldERvbVJlZigpOwogICAgICAgICAgICAgICAgICAgICAgICBvQ29udHJvbGxlci5nZXRWaWV3KCkuc0Rhc2hib2FyZEdyb3Vwc1dyYXBwZXJJZCA9ICFpc0VtcHR5T2JqZWN0KG9Eb21SZWYpICYmIG9Eb21SZWYucGFyZW50Tm9kZSA/IG9Eb21SZWYucGFyZW50Tm9kZS5pZCA6ICIiOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0R3JvdXBzKCkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vVGlsZSBvcGFjaXR5IGlzIGVuYWJsZWQgYnkgZGVmYXVsdCwgdGhlcmVmb3JlIHdlIGhhbmRsZSB0aWxlIG9wYWNpdHkgaW4gYWxsIGNhc2VzIGV4Y2VwdAogICAgICAgICAgICAgICAgICAgICAgICAvL2Nhc2Ugd2hlcmUgZmxhZyBpcyBleHBsaWNpdGx5IHNldCB0byBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRNb2RlbCgpLmdldFByb3BlcnR5KCIvZW5hYmxlVGlsZXNPcGFjaXR5IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHV0aWxzLmhhbmRsZVRpbGVzT3BhY2l0eSh0aGlzLmdldE1vZGVsKCkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIEV2ZW50SHViLmVtaXQoIkNlbnRlclZpZXdQb2ludENvbnRlbnRSZW5kZXJlZCIpOwogICAgICAgICAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS5wdWJsaXNoKCJsYXVuY2hwYWQiLCAiY29udGVudFJlbmRlcmVkIik7CiAgICAgICAgICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLnB1Ymxpc2goImxhdW5jaHBhZCIsICJjb250ZW50UmVmcmVzaCIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0QmluZGluZygiZ3JvdXBzIikuZmlsdGVyKHRoYXQuY2FsY3VsYXRlRmlsdGVyKCkpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB0aGlzLmlzVGFiQmFyQWN0aXZlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9Nb2RlbC5nZXRQcm9wZXJ0eSgiL2hvbWVQYWdlR3JvdXBEaXNwbGF5IikgPT09ICJ0YWJzIjsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdGhpcy5vTW9kZWwgPSBvTW9kZWw7CiAgICAgICAgICAgICAgICB2YXIgZmlsdGVycyA9IHRoaXMuY2FsY3VsYXRlRmlsdGVyKCksCiAgICAgICAgICAgICAgICAgICAgYlVzZUdyaWRDb250YWluZXIgPSBDb25maWcubGFzdCgiL2NvcmUvaG9tZS9ncmlkQ29udGFpbmVyIik7CgogICAgICAgICAgICAgICAgdGhpcy5vR3JvdXBzQ29udGFpbmVyID0gbmV3IERhc2hib2FyZEdyb3Vwc0NvbnRhaW5lcigiZGFzaGJvYXJkR3JvdXBzIiwgewogICAgICAgICAgICAgICAgICAgIGFjY2Vzc2liaWxpdHlMYWJlbDogcmVzb3VyY2VzLmkxOG4uZ2V0VGV4dCgiRGFzaGJvYXJkR3JvdXBzX2xhYmVsIiksCiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU1vZGU6ICJ7L2hvbWVQYWdlR3JvdXBEaXNwbGF5fSIsCiAgICAgICAgICAgICAgICAgICAgYWZ0ZXJSZW5kZXJpbmc6IGZHcm91cHNDb250YWluZXJBZnRlclJlbmRlcmluZ0hhbmRsZXIKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmIChiVXNlR3JpZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNhcC51aS5yZXF1aXJlKFsic2FwL3VzaGVsbC91aS9sYXVuY2hwYWQvR3JpZENvbnRhaW5lciJdLCBmdW5jdGlvbiAoLypHcmlkQ29udGFpbmVyKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5vR3JvdXBzQ29udGFpbmVyLmJpbmRBZ2dyZWdhdGlvbigiZ3JvdXBzIiwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyczogZmlsdGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6ICIvZ3JvdXBzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY3Rvcnk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc1NpemVCZWhhdmlvciA9IENvbmZpZy5sYXN0KCIvY29yZS9ob21lL3NpemVCZWhhdmlvciIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvR3JpZENvbnRhaW5lciA9IHRoYXQuX2NyZWF0ZUdyaWRDb250YWluZXIob0NvbnRyb2xsZXIsIG9Nb2RlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb0dyaWRDb250YWluZXIuc2V0VGlsZVNpemVCZWhhdmlvcihzU2l6ZUJlaGF2aW9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb0dyaWRDb250YWluZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIENvbmZpZy5vbigiL2NvcmUvaG9tZS9zaXplQmVoYXZpb3IiKS5kbyhmdW5jdGlvbiAoc1RpbGVTaXplKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQub0dyb3Vwc0NvbnRhaW5lci5nZXRBZ2dyZWdhdGlvbigiZ3JvdXBzIikuZm9yRWFjaChmdW5jdGlvbiAob0dyb3VwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvR3JvdXAuc2V0VGlsZVNpemVCZWhhdmlvcihzVGlsZVNpemUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vR3JvdXBzQ29udGFpbmVyLmJpbmRBZ2dyZWdhdGlvbigiZ3JvdXBzIiwgewogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJzOiBmaWx0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiAiL2dyb3VwcyIsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhY3Rvcnk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0Ll9jcmVhdGVUaWxlQ29udGFpbmVyKG9Db250cm9sbGVyLCBvTW9kZWwpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKERldmljZS5zeXN0ZW0uZGVza3RvcCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub0dyb3Vwc0NvbnRhaW5lci5hZGRFdmVudERlbGVnYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgb25zYXBza2lwYmFjazogZnVuY3Rpb24gKG9FdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXAudXNoZWxsLnJlbmRlcmVycy5maW9yaTIuQWNjZXNzS2V5c0hhbmRsZXIuc2V0SXNGb2N1c0hhbmRsZWRCeUFub3RoZXJIYW5kbGVyKHRydWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkoIi5zYXBVc2hlbGxBbmNob3JJdGVtIikuaXMoIjp2aXNpYmxlIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXAudXNoZWxsLmNvbXBvbmVudHMuQ29tcG9uZW50S2V5c0hhbmRsZXIuZ29Ub1NlbGVjdGVkQW5jaG9yTmF2aWdhdGlvbkl0ZW0oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5yZW5kZXJlcnMuZmlvcmkyLkFjY2Vzc0tleXNIYW5kbGVyLnNlbmRGb2N1c0JhY2tUb1NoZWxsKG9FdmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgICAgICBvbnNhcHNraXBmb3J3YXJkOiBmdW5jdGlvbiAob0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvRXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvRG9uZUJ0biA9IHdpbmRvdy5kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2FwVXNoZWxsRGFzaGJvYXJkRm9vdGVyRG9uZUJ0biIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9Eb25lQnRuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb0RvbmVCdG4uZm9jdXMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoalF1ZXJ5KCIjc2FwVXNoZWxsRmxvYXRpbmdDb250YWluZXJXcmFwcGVyIikuaXMoIjp2aXNpYmxlIikgJiYgb0V2ZW50Lm9yaWdpbmFsRXZlbnQuc3JjRWxlbWVudC5pZCAhPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBjby1waWxvdCBleGlzdHMgYW5kIHdlIGNhbWUgZnJvbSB0aWxlIC0gbmVlZCB0byBmb2N1cyBvbiBjb3BpbG90IC0gb3RoZXJ3aXNlIC0gb24gdGhlIHNoZWxsIGhlYWRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS5wdWJsaXNoKCJsYXVuY2hwYWQiLCAic2hlbGxGbG9hdGluZ0NvbnRhaW5lcklzQWNjZXNzaWJsZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXAudXNoZWxsLnJlbmRlcmVycy5maW9yaTIuQWNjZXNzS2V5c0hhbmRsZXIuc2V0SXNGb2N1c0hhbmRsZWRCeUFub3RoZXJIYW5kbGVyKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhcC51c2hlbGwucmVuZGVyZXJzLmZpb3JpMi5BY2Nlc3NLZXlzSGFuZGxlci5zZW5kRm9jdXNCYWNrVG9TaGVsbChvRXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAgICAgb25zYXB0YWJuZXh0OiBmdW5jdGlvbiAob0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5vTW9kZWwuZ2V0UHJvcGVydHkoIi90aWxlQWN0aW9uTW9kZUFjdGl2ZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeShkb2N1bWVudC5hY3RpdmVFbGVtZW50KS5jbG9zZXN0KCIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lckhlYWRlciIpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBhcmUgaW5zaWRlIHRoZSBoZWFkZXIuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9OTFkgZm9jdXNlZCBlbGVtZW50IGlzIGxhc3QgYmVmb3JlIHRoZSB0aWxlcy1saXN0IHdlIGNhbGwgdG8gc2V0IGZvY3VzIG9uIHRpbGVzIGxpc3QuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG90aGVyd2lzZSAtIGxldCB0aGUgYnJvd3NlciBoYW5kbGUgaXQuCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIganFDdXJyZW50VGlsZUNvbnRhaW5lciA9IGpRdWVyeShkb2N1bWVudC5hY3RpdmVFbGVtZW50KS5jbG9zZXN0KCIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lciIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zaWRlIGhlYWRlciB3ZSBjYW4gYmUgb24gMiBzZWN0aW9uIGVsZW1lbnRzIC0gdGl0bGUgT1Igb24gYSBoZWFkZXIgYWN0aW9uIGJ1dHRvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiB3ZSBhcmUgb24gdGhlIHRpdGxlIGl0c2VsZgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNDdXJyZW50RWxlbWVudFRpdGxlID0galF1ZXJ5KGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpLmhhc0NsYXNzKCJzYXBVc2hlbGxDb250YWluZXJUaXRsZSIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VhcmNoIGZvciBhY3Rpb25zIGluc2lkZSB0aGUgaGVhZGVyIHRpdGxlIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGpxQ2hpbGRBY3Rpb25zID0ganFDdXJyZW50VGlsZUNvbnRhaW5lci5maW5kKCIuc2FwVXNoZWxsSGVhZGVyQWN0aW9uQnV0dG9uIik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50RWxlbWVudFRpdGxlICYmICFqcUNoaWxkQWN0aW9ucy5sZW5ndGggfHwgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5pZCA9PT0ganFDaGlsZEFjdGlvbnMubGFzdCgpWzBdLmlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoanFDdXJyZW50VGlsZUNvbnRhaW5lci5maW5kKCIuc2FwVXNoZWxsVGlsZSwgLnNhcFVzaGVsbExpbmssIC5zYXBGQ2FyZCIpLmlzKCI6dmlzaWJsZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5jb21wb25lbnRzLkNvbXBvbmVudEtleXNIYW5kbGVyLmdvVG9MYXN0VmlzaXRlZFRpbGUoanFDdXJyZW50VGlsZUNvbnRhaW5lciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoanFDaGlsZEFjdGlvbnMubGVuZ3RoICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQuaWQgIT09IGpxQ2hpbGRBY3Rpb25zLmxhc3QoKVswXS5pZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb0RvbmVCdG4gPSB3aW5kb3cuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNhcFVzaGVsbERhc2hib2FyZEZvb3RlckRvbmVCdG4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob0RvbmVCdG4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9Eb25lQnRuLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgb0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5KCIjc2FwVXNoZWxsRmxvYXRpbmdDb250YWluZXJXcmFwcGVyIikuaXMoIjp2aXNpYmxlIikgJiYgKG9FdmVudC5vcmlnaW5hbEV2ZW50LnNyY0VsZW1lbnQuaWQpICE9PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS5wdWJsaXNoKCJsYXVuY2hwYWQiLCAic2hlbGxGbG9hdGluZ0NvbnRhaW5lcklzQWNjZXNzaWJsZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXAudXNoZWxsLnJlbmRlcmVycy5maW9yaTIuQWNjZXNzS2V5c0hhbmRsZXIuc2V0SXNGb2N1c0hhbmRsZWRCeUFub3RoZXJIYW5kbGVyKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhcC51c2hlbGwucmVuZGVyZXJzLmZpb3JpMi5BY2Nlc3NLZXlzSGFuZGxlci5zZW5kRm9jdXNCYWNrVG9TaGVsbChvRXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAgICAgb25zYXB0YWJwcmV2aW91czogZnVuY3Rpb24gKG9FdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5yZW5kZXJlcnMuZmlvcmkyLkFjY2Vzc0tleXNIYW5kbGVyLnNldElzRm9jdXNIYW5kbGVkQnlBbm90aGVySGFuZGxlcih0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqcUZvY3VzZWQgPSBqUXVlcnkoIjpmb2N1cyIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQub01vZGVsLmdldFByb3BlcnR5KCIvdGlsZUFjdGlvbk1vZGVBY3RpdmUiKSAmJiAhanFGb2N1c2VkLmhhc0NsYXNzKCJzYXBVc2hlbGxUaWxlQ29udGFpbmVySGVhZGVyIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIganFBY3RpdmVFbGVtZW50ID0galF1ZXJ5KGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IGluIGNhc2UgZm9jdXMgaXMgb24gYSB0aWxlIHdlIG5lZWQgY3VzdG9tIGJlaGF2aW9yIHVwb24gc2hpZnQtdGFiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIGxldCB0aGUgYnJvd3NlciBoYW5kbGUgaXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoanFBY3RpdmVFbGVtZW50Lmhhc0NsYXNzKCJzYXBVc2hlbGxUaWxlIikgfHwganFBY3RpdmVFbGVtZW50Lmhhc0NsYXNzKCJzYXBGQ2FyZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9FdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGFrZSByZWZlcmVuY2UgdG8gY3VycmVudCB0aWxlIGNvbnRhaW5lcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIganFDdXJyZW50VGlsZUNvbnRhaW5lciA9IGpxQWN0aXZlRWxlbWVudC5jbG9zZXN0KCIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lciIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gIHNlYXJjaCBmb3IgYWN0aW9ucyBpbnNpZGUgdGhlIGhlYWRlciB0aXRsZSBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqcUxhc3RBY3Rpb24gPSBqcUN1cnJlbnRUaWxlQ29udGFpbmVyLmZpbmQoIi5zYXBVc2hlbGxIZWFkZXJBY3Rpb25CdXR0b24iKS5maWx0ZXIoIjp2aXNpYmxlIikubGFzdCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgYWN0aW9ucyBleGlzdCBvbiBoZWFkZXIgdGl0bGUgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSBhcmUgYWN0aW9ucyBvZiB0aWxlIGNvbnRhaW5lciBoZWFkZXIgLSBmb2N1cyBvbiBsYXN0IG9uZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoanFMYXN0QWN0aW9uLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpxTGFzdEFjdGlvbi5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZWxzZSBmb2N1cyBvbiB0aXRsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganFDdXJyZW50VGlsZUNvbnRhaW5lci5maW5kKCIuc2FwVXNoZWxsQ29udGFpbmVyVGl0bGUiKS5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vR3JvdXBzQ29udGFpbmVyOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZ2V0QWxsR3JvdXBzRnJvbU1vZGVsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vTW9kZWwuZ2V0UHJvcGVydHkoIi9ncm91cHMiKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIF9jcmVhdGVUaWxlQ29udGFpbmVyOiBmdW5jdGlvbiAob0NvbnRyb2xsZXIvKiwgb01vZGVsKi8pIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBvRmlsdGVyID0gbmV3IEZpbHRlcigiaXNUaWxlSW50ZW50U3VwcG9ydGVkIiwgRmlsdGVyT3BlcmF0b3IuRVEsIHRydWUpLAogICAgICAgICAgICAgICAgICAgIG9UaWxlc0NvbnRhaW5lciA9IG5ldyBUaWxlQ29udGFpbmVyKHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyVGV4dDogInt0aXRsZX0iLAogICAgICAgICAgICAgICAgICAgICAgICBzaG93RW1wdHlMaW5rc0FyZWE6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzOiBbIi90aWxlQWN0aW9uTW9kZUFjdGl2ZSIsICJsaW5rcy9sZW5ndGgiLCAiaXNHcm91cExvY2tlZCIsICIvaXNJbkRyYWciLCAiL2hvbWVQYWdlR3JvdXBEaXNwbGF5Il0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6IGZ1bmN0aW9uICh0aWxlQWN0aW9uTW9kZUFjdGl2ZSwgbnVtT2ZMaW5rcywgaXNHcm91cExvY2tlZCwgYklzSW5EcmFnLCBzQW5jaG9yYmFyTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChudW1PZkxpbmtzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNHcm91cExvY2tlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aWxlQWN0aW9uTW9kZUFjdGl2ZSB8fCBiSXNJbkRyYWcgJiYgc0FuY2hvcmJhck1vZGUgPT09ICJ0YWJzIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc2hvd01vYmlsZUFjdGlvbnM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzOiBbIi90aWxlQWN0aW9uTW9kZUFjdGl2ZSJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyOiBmdW5jdGlvbiAoYklzQWN0aW9uTW9kZUFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBiSXNBY3Rpb25Nb2RlQWN0aXZlICYmICF0aGlzLmdldERlZmF1bHRHcm91cCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBzaG93SWNvbjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydHM6IFsiL2lzSW5EcmFnIiwgIi90aWxlQWN0aW9uTW9kZUFjdGl2ZSJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyOiBmdW5jdGlvbiAoYklzSW5EcmFnLCBiSXNBY3Rpb25Nb2RlQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLmdldElzR3JvdXBMb2NrZWQoKSAmJiAoYklzSW5EcmFnIHx8IGJJc0FjdGlvbk1vZGVBY3RpdmUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgZGVsdW1pbmF0ZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydHM6IFsiL2lzSW5EcmFnIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6IGZ1bmN0aW9uIChiSXNJbkRyYWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgcmV0dXJuIG9FdmVudC5vU291cmNlLmdldElzR3JvdXBMb2NrZWQoKSAmJiBiSXNJbkRyYWc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SXNHcm91cExvY2tlZCgpICYmIGJJc0luRHJhZzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtYXRpb25FcnJvcjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydHM6IFsiL2lzSW5EcmFnIiwgIi9kcmFnZ2VkVGlsZUxpbmtQZXJzb25hbGl6YXRpb25TdXBwb3J0ZWQiXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlcjogZnVuY3Rpb24gKGJJc0luRHJhZywgYkRyYWdnZWRUaWxlTGlua1BlcnNvbmFsaXphdGlvblN1cHBvcnRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBiSXNJbkRyYWcgJiYgIWJEcmFnZ2VkVGlsZUxpbmtQZXJzb25hbGl6YXRpb25TdXBwb3J0ZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dCYWNrZ3JvdW5kOiAiey90aWxlQWN0aW9uTW9kZUFjdGl2ZX0iLAogICAgICAgICAgICAgICAgICAgICAgICB0b29sdGlwOiAie3RpdGxlfSIsCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVBY3Rpb25Nb2RlQWN0aXZlOiAiey90aWxlQWN0aW9uTW9kZUFjdGl2ZX0iLAogICAgICAgICAgICAgICAgICAgICAgICBpZUh0bWw1RG5EOiBvQ29udHJvbGxlci5nZXRWaWV3KCkuaWVIdG1sNURuRCwKICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlSGVscDogInsvZW5hYmxlSGVscH0iLAogICAgICAgICAgICAgICAgICAgICAgICBncm91cElkOiAie2dyb3VwSWR9IiwKICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdEdyb3VwOiAie2lzRGVmYXVsdEdyb3VwfSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGlzTGFzdEdyb3VwOiAie2lzTGFzdEdyb3VwfSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGlzR3JvdXBMb2NrZWQ6ICJ7aXNHcm91cExvY2tlZH0iLAogICAgICAgICAgICAgICAgICAgICAgICBpc0dyb3VwU2VsZWN0ZWQ6ICJ7aXNHcm91cFNlbGVjdGVkfSIsCiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dIZWFkZXI6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dHcm91cEhlYWRlcjogIntzaG93R3JvdXBIZWFkZXJ9IiwKICAgICAgICAgICAgICAgICAgICAgICAgaG9tZVBhZ2VHcm91cERpc3BsYXk6ICJ7L2hvbWVQYWdlR3JvdXBEaXNwbGF5fSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRNb2RlOiAie2VkaXRNb2RlfSIsCiAgICAgICAgICAgICAgICAgICAgICAgIHN1cHBvcnRMaW5rUGVyc29uYWxpemF0aW9uOiB0aGlzLmlzTGlua1BlcnNvbmFsaXphdGlvblN1cHBvcnRlZCwKICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGVDaGFuZ2U6IGZ1bmN0aW9uIChvRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS5wdWJsaXNoKCJsYXVuY2hwYWQiLCAiY2hhbmdlR3JvdXBUaXRsZSIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cElkOiBvRXZlbnQuZ2V0U291cmNlKCkuZ2V0R3JvdXBJZCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1RpdGxlOiBvRXZlbnQuZ2V0UGFyYW1ldGVyKCJuZXdUaXRsZSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0VtcHR5TGlua3NBcmVhUGxhY2VIb2xkZXI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzOiBbImxpbmtzL2xlbmd0aCIsICIvaXNJbkRyYWciLCAiL2hvbWVQYWdlR3JvdXBEaXNwbGF5Il0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6IGZ1bmN0aW9uIChudW1PZkxpbmtzLCBiSXNJbkRyYWcsIHNBbmNob3JiYXJNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGJJc0luRHJhZyAmJiBzQW5jaG9yYmFyTW9kZSA9PT0gInRhYnMiICYmICFudW1PZkxpbmtzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBzaG93UGxhY2Vob2xkZXI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzOiBbIi90aWxlQWN0aW9uTW9kZUFjdGl2ZSIsICJ0aWxlcy9sZW5ndGgiXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlcjogZnVuY3Rpb24gKHRpbGVBY3Rpb25Nb2RlQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRpbGVBY3Rpb25Nb2RlQWN0aXZlICYmICF0aGlzLmdldElzR3JvdXBMb2NrZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydHM6IFsiL3RpbGVBY3Rpb25Nb2RlQWN0aXZlIiwgImlzR3JvdXBWaXNpYmxlIiwgInZpc2liaWxpdHlNb2RlcyJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyOiBmdW5jdGlvbiAodGlsZUFjdGlvbk1vZGVBY3RpdmUsIGlzR3JvdXBWaXNpYmxlLCB2aXNpYmlsaXR5TW9kZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFbXB0eSBncm91cHMgc2hvdWxkIG5vdCBiZSBkaXNwbGF5ZWQgd2hlbiBwZXJzb25hbGl6YXRpb24gaXMgb2ZmIG9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhleSBhcmUgbG9ja2VkIG9yIGRlZmF1bHQgZ3JvdXAgbm90IGluIGFjdGlvbiBtb2RlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2aXNpYmlsaXR5TW9kZXNbdGlsZUFjdGlvbk1vZGVBY3RpdmUgPyAxIDogMF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNHcm91cFZpc2libGUgfHwgdGlsZUFjdGlvbk1vZGVBY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGhpZGRlbjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydHM6IFsiL3RpbGVBY3Rpb25Nb2RlQWN0aXZlIiwgImlzR3JvdXBWaXNpYmxlIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6IGZ1bmN0aW9uIChiSXNBY3Rpb25Nb2RlQWN0aXZlLCBiSXNHcm91cFZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYklzQWN0aW9uTW9kZUFjdGl2ZSAmJiAhYklzR3JvdXBWaXNpYmxlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBsaW5rczogdGhpcy5fZ2V0TGlua1RlbXBsYXRlKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiAidGlsZXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFjdG9yeTogdGhpcy5faXRlbUZhY3RvcnkuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcnM6IFtvRmlsdGVyXQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBhZGQ6IC8qb0NvbnRyb2xsZXIuX2FkZFRpbGVDb250YWluZXIsKi8gZnVuY3Rpb24gKG9FdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5faGFuZGxlQWRkVGlsZVRvR3JvdXAob0V2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIG9UaWxlc0NvbnRhaW5lcjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIF9jcmVhdGVHcmlkQ29udGFpbmVyOiBmdW5jdGlvbiAob0NvbnRyb2xsZXIvKiwgb01vZGVsKi8pIHsKICAgICAgICAgICAgICAgIHZhciBHcmlkQ29udGFpbmVyID0gc2FwLnVpLnJlcXVpcmUoInNhcC91c2hlbGwvdWkvbGF1bmNocGFkL0dyaWRDb250YWluZXIiKSwKICAgICAgICAgICAgICAgICAgICBvRmlsdGVyID0gbmV3IEZpbHRlcigiaXNUaWxlSW50ZW50U3VwcG9ydGVkIiwgRmlsdGVyT3BlcmF0b3IuRVEsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBHcmlkQ29udGFpbmVyKHsKICAgICAgICAgICAgICAgICAgICBncm91cElkOiAie2dyb3VwSWR9IiwKICAgICAgICAgICAgICAgICAgICBzaG93SGVhZGVyOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGRlZmF1bHRHcm91cDogIntpc0RlZmF1bHRHcm91cH0iLAogICAgICAgICAgICAgICAgICAgIGlzTGFzdEdyb3VwOiAie2lzTGFzdEdyb3VwfSIsCiAgICAgICAgICAgICAgICAgICAgaGVhZGVyVGV4dDogInt0aXRsZX0iLAogICAgICAgICAgICAgICAgICAgIHNob3dHcm91cEhlYWRlcjogIntzaG93R3JvdXBIZWFkZXJ9IiwKICAgICAgICAgICAgICAgICAgICBob21lUGFnZUdyb3VwRGlzcGxheTogInsvaG9tZVBhZ2VHcm91cERpc3BsYXl9IiwKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzOiBbIi90aWxlQWN0aW9uTW9kZUFjdGl2ZSIsICJpc0dyb3VwVmlzaWJsZSIsICJ2aXNpYmlsaXR5TW9kZXMiXSwKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyOiBmdW5jdGlvbiAodGlsZUFjdGlvbk1vZGVBY3RpdmUsIGlzR3JvdXBWaXNpYmxlLCB2aXNpYmlsaXR5TW9kZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVtcHR5IGdyb3VwcyBzaG91bGQgbm90IGJlIGRpc3BsYXllZCB3aGVuIHBlcnNvbmFsaXphdGlvbiBpcyBvZmYgb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZXkgYXJlIGxvY2tlZCBvciBkZWZhdWx0IGdyb3VwIG5vdCBpbiBhY3Rpb24gbW9kZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2aXNpYmlsaXR5TW9kZXNbdGlsZUFjdGlvbk1vZGVBY3RpdmUgPyAxIDogMF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNHcm91cFZpc2libGUgfHwgdGlsZUFjdGlvbk1vZGVBY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGlzR3JvdXBMb2NrZWQ6ICJ7aXNHcm91cExvY2tlZH0iLAogICAgICAgICAgICAgICAgICAgIGlzR3JvdXBTZWxlY3RlZDogIntpc0dyb3VwU2VsZWN0ZWR9IiwKICAgICAgICAgICAgICAgICAgICBlZGl0TW9kZTogIntlZGl0TW9kZX0iLAogICAgICAgICAgICAgICAgICAgIHNob3dCYWNrZ3JvdW5kOiAiey90aWxlQWN0aW9uTW9kZUFjdGl2ZX0iLAogICAgICAgICAgICAgICAgICAgIHNob3dJY29uOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzOiBbIi9pc0luRHJhZyIsICIvdGlsZUFjdGlvbk1vZGVBY3RpdmUiXSwKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyOiBmdW5jdGlvbiAoYklzSW5EcmFnLCBiSXNBY3Rpb25Nb2RlQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHRoaXMuZ2V0SXNHcm91cExvY2tlZCgpICYmIChiSXNJbkRyYWcgfHwgYklzQWN0aW9uTW9kZUFjdGl2ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB0aWxlQWN0aW9uTW9kZUFjdGl2ZTogInsvdGlsZUFjdGlvbk1vZGVBY3RpdmV9IiwKICAgICAgICAgICAgICAgICAgICBzdXBwb3J0TGlua1BlcnNvbmFsaXphdGlvbjogdGhpcy5pc0xpbmtQZXJzb25hbGl6YXRpb25TdXBwb3J0ZWQsCiAgICAgICAgICAgICAgICAgICAgaWVIdG1sNURuRDogb0NvbnRyb2xsZXIuZ2V0VmlldygpLmllSHRtbDVEbkQsCiAgICAgICAgICAgICAgICAgICAgZW5hYmxlSGVscDogInsvZW5hYmxlSGVscH0iLAogICAgICAgICAgICAgICAgICAgIHNob3dFbXB0eUxpbmtzQXJlYVBsYWNlSG9sZGVyOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzOiBbImxpbmtzL2xlbmd0aCIsICIvaXNJbkRyYWciLCAiL2hvbWVQYWdlR3JvdXBEaXNwbGF5Il0sCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlcjogZnVuY3Rpb24gKG51bU9mTGlua3MsIGJJc0luRHJhZywgc0FuY2hvcmJhck1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBiSXNJbkRyYWcgJiYgc0FuY2hvcmJhck1vZGUgPT09ICJ0YWJzIiAmJiAhbnVtT2ZMaW5rczsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2hvd0VtcHR5TGlua3NBcmVhOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzOiBbIi90aWxlQWN0aW9uTW9kZUFjdGl2ZSIsICJsaW5rcy9sZW5ndGgiLCAiaXNHcm91cExvY2tlZCIsICIvaXNJbkRyYWciLCAiL2hvbWVQYWdlR3JvdXBEaXNwbGF5Il0sCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlcjogZnVuY3Rpb24gKHRpbGVBY3Rpb25Nb2RlQWN0aXZlLCBudW1PZkxpbmtzLCBpc0dyb3VwTG9ja2VkLCBiSXNJbkRyYWcsIHNBbmNob3JiYXJNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobnVtT2ZMaW5rcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0dyb3VwTG9ja2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRpbGVBY3Rpb25Nb2RlQWN0aXZlIHx8IGJJc0luRHJhZyAmJiBzQW5jaG9yYmFyTW9kZSA9PT0gInRhYnMiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB0aXRsZUNoYW5nZTogZnVuY3Rpb24gKG9FdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBzYXAudWkuZ2V0Q29yZSgpLmdldEV2ZW50QnVzKCkucHVibGlzaCgibGF1bmNocGFkIiwgImNoYW5nZUdyb3VwVGl0bGUiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cElkOiBvRXZlbnQuZ2V0U291cmNlKCkuZ2V0R3JvdXBJZCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3VGl0bGU6IG9FdmVudC5nZXRQYXJhbWV0ZXIoIm5ld1RpdGxlIikKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB0b29sdGlwOiAie3RpdGxlfSIsCiAgICAgICAgICAgICAgICAgICAgbGlua3M6IHRoaXMuX2dldExpbmtUZW1wbGF0ZSgpLAogICAgICAgICAgICAgICAgICAgIHRpbGVzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6ICJ0aWxlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhY3Rvcnk6IHRoaXMuX2l0ZW1GYWN0b3J5LmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcnM6IFtvRmlsdGVyXQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgX2dldExpbmtUZW1wbGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIG9GaWx0ZXIgPSBuZXcgRmlsdGVyKCJpc1RpbGVJbnRlbnRTdXBwb3J0ZWQiLCBGaWx0ZXJPcGVyYXRvci5FUSwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzTGlua1BlcnNvbmFsaXphdGlvblN1cHBvcnRlZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6ICJsaW5rcyIsCiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlU2hhcmVhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogbmV3IExpbmtUaWxlV3JhcHBlcih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkOiAie3V1aWR9IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVDYXRhbG9nSWQ6ICJ7dGlsZUNhdGFsb2dJZH0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiAie3RhcmdldH0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNMb2NrZWQ6ICJ7aXNMb2NrZWR9IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVBY3Rpb25Nb2RlQWN0aXZlOiAiey90aWxlQWN0aW9uTW9kZUFjdGl2ZX0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uUmVuZGVyZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWdJbmZvOiAie2RlYnVnSW5mb30iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWVIdG1sNURuRDogdGhpcy5vQ29udHJvbGxlci5nZXRWaWV3KCkuaWVIdG1sNURuRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVWaWV3czogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6ICJjb250ZW50IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBmdW5jdGlvbiAoc0lkLCBvQ29udGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb0NvbnRleHQuZ2V0T2JqZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyUmVuZGVyaW5nOiBmdW5jdGlvbiAob0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGpxSHJlZkVsZW1lbnQgPSBqUXVlcnkodGhpcy5nZXREb21SZWYoKS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYSIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZW1vdmUgdGFiaW5kZXggZnJvbSBsaW5rcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICBzbyB0aGF0IHRoZSBmb2N1cyB3aWxsIG5vdCBiZSBhdXRvbWF0aWNhbGx5IHNldCBvbiB0aGUgZm9jdXNhYmxlIGxpbmsgd2hlbiByZXR1cm5pbmcgdG8gdGhlIGxhdW5jaHBhZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpxSHJlZkVsZW1lbnQuYXR0cigidGFiaW5kZXgiLCAtMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJzOiBbb0ZpbHRlcl0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICBwYXRoOiAibGlua3MiLAogICAgICAgICAgICAgICAgICAgIGZhY3Rvcnk6IGZ1bmN0aW9uIChzSWQsIG9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvQ29udHJvbCA9IG9Db250ZXh0LmdldE9iamVjdCgpLmNvbnRlbnRbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvQ29udHJvbCAmJiBvQ29udHJvbC5iSXNEZXN0cm95ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9Db250cm9sID0gb0NvbnRyb2wuY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9Db250ZXh0LmdldE1vZGVsKCkuc2V0UHJvcGVydHkob0NvbnRleHQuZ2V0UGF0aCgpICsgIi9jb250ZW50LzAiLCBvQ29udHJvbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9Db250cm9sOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZmlsdGVyczogW29GaWx0ZXJdCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgX2l0ZW1GYWN0b3J5OiBmdW5jdGlvbiAoc0lkLCBvQ29udGV4dCkgewogICAgICAgICAgICAgICAgdmFyIG9UaWxlT3JDYXJkID0gb0NvbnRleHQuZ2V0UHJvcGVydHkob0NvbnRleHQuc1BhdGgpLAogICAgICAgICAgICAgICAgICAgIGFDb250ZW50LAogICAgICAgICAgICAgICAgICAgIG9Db250ZW50LAogICAgICAgICAgICAgICAgICAgIG9Db250cm9sLAogICAgICAgICAgICAgICAgICAgIG9NYW5pZmVzdDsKCiAgICAgICAgICAgICAgICBpZiAob1RpbGVPckNhcmQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAob1RpbGVPckNhcmQuaXNDYXJkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFDb250ZW50ID0gb1RpbGVPckNhcmQgJiYgb1RpbGVPckNhcmQuY29udGVudDsKICAgICAgICAgICAgICAgICAgICAgICAgb0NvbnRlbnQgPSBhQ29udGVudCAmJiBhQ29udGVudC5sZW5ndGggJiYgYUNvbnRlbnRbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvQ29udGVudCAmJiBvQ29udGVudFsic2FwLmNhcmQiXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb01hbmlmZXN0ID0gb0NvbnRlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob1RpbGVPckNhcmQubWFuaWZlc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBsYWNlaG9sZGVyIG1hbmlmZXN0IGZvciBibGluZCBsb2FkaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvTWFuaWZlc3QgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInNhcC5mbHAiOiBvVGlsZU9yQ2FyZC5tYW5pZmVzdCAmJiBvVGlsZU9yQ2FyZC5tYW5pZmVzdFsic2FwLmZscCJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzYXAuY2FyZCI6IHsgInR5cGUiOiAiTGlzdCIgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVFcnJvclRpbGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGVtcG9yYXJ5IHNvbHV0aW9uIGZvciBpbmNpZGVudCAxOTgwMjYxMzE1LiBUaGUgbGlicmFyeSAic2FwLnVpLmludGVyZ3JhdGlvbiIgc2hvdWxkIG9ubHkgYmUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbG9hZGVkIG9ubHkgd2hlbiBjYXJkcyBhcmUgdXNlZCBhbmQgc2hvdWxkIGJlIGxvYWRlZCBzeW5jaHJvbm91c2x5LiBSZWZhY3RvcmluZyBpcyBuZWVkZWQgdG8KICAgICAgICAgICAgICAgICAgICAgICAgLy8gZW5hYmxlIHRoZSBhc3luY2hyb25vdXMgbG9hZGluZyBvZiB0aGUgbGlicmFyeS4KICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5sb2FkTGlicmFyeSgic2FwLnVpLmludGVncmF0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBDYXJkID0gc2FwLnVpLnJlcXVpcmVTeW5jKCJzYXAvdWkvaW50ZWdyYXRpb24vd2lkZ2V0cy9DYXJkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIG9Db250cm9sID0gbmV3IENhcmQoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFuaWZlc3Q6IG9NYW5pZmVzdAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBvQ29udHJvbCA9IHRoaXMuX2NyZWF0ZVRpbGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgb1RpbGVPckNhcmQuY29udHJvbElkID0gb0NvbnRyb2wgJiYgb0NvbnRyb2wuZ2V0SWQgJiYgb0NvbnRyb2wuZ2V0SWQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBvQ29udHJvbDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGVzIGEgZ2VuZXJpYyBlcnJvciB0aWxlLiBJdCB3aWxsIGJlIGRpc3BsYXllZCB3aXRoIGEgZ2VuZXJpYyAiQ2Fubm90IGxvYWQgdGlsZSIgc3ViaGVhZGVyLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7c2FwLnVzaGVsbC51aS5sYXVuY2hwYWQuVGlsZX0gVGhlIExhdW5jaHBhZCBUaWxlIGNvbnRhaW5pbmcgYSBHZW5lcmljVGlsZSBpbiBlcnJvciBtb2RlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBfY3JlYXRlRXJyb3JUaWxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IExhdW5jaHBhZFRpbGUoewogICAgICAgICAgICAgICAgICAgIHRpbGVWaWV3czogewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiAiY29udGVudCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhY3Rvcnk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgR2VuZXJpY1RpbGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlOiAiRmFpbGVkIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIF9jcmVhdGVUaWxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgb1RpbGUgPSBuZXcgTGF1bmNocGFkVGlsZSh7CiAgICAgICAgICAgICAgICAgICAgImxvbmciOiAie2xvbmd9IiwKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgbW9kZWwgZmxhZyBkcmFnZ2VkSW5UYWJCYXJUb1NvdXJjZUdyb3VwIHdhcyBzZXQgZm9yIHRoZSB0aWxlIGluIHdoZW4gaXQgd2FzIGRyYWdnZWQgb24gVGFiQmFyIGJldHdlZW4gZ3JvdXBzCiAgICAgICAgICAgICAgICAgICAgaXNEcmFnZ2VkSW5UYWJCYXJUb1NvdXJjZUdyb3VwOiAie2RyYWdnZWRJblRhYkJhclRvU291cmNlR3JvdXB9IiwKICAgICAgICAgICAgICAgICAgICB1dWlkOiAie3V1aWR9IiwKICAgICAgICAgICAgICAgICAgICB0aWxlQ2F0YWxvZ0lkOiAie3RpbGVDYXRhbG9nSWR9IiwKICAgICAgICAgICAgICAgICAgICBpc0N1c3RvbVRpbGU6ICJ7aXNDdXN0b21UaWxlfSIsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiAie3RhcmdldH0iLAogICAgICAgICAgICAgICAgICAgIGlzTG9ja2VkOiAie2lzTG9ja2VkfSIsCiAgICAgICAgICAgICAgICAgICAgbmF2aWdhdGlvbk1vZGU6ICJ7bmF2aWdhdGlvbk1vZGV9IiwKICAgICAgICAgICAgICAgICAgICB0aWxlQWN0aW9uTW9kZUFjdGl2ZTogInsvdGlsZUFjdGlvbk1vZGVBY3RpdmV9IiwKICAgICAgICAgICAgICAgICAgICBzaG93QWN0aW9uc0ljb246ICJ7c2hvd0FjdGlvbnNJY29ufSIsCiAgICAgICAgICAgICAgICAgICAgcmdiYTogIntyZ2JhfSIsCiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uUmVuZGVyZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGRlYnVnSW5mbzogIntkZWJ1Z0luZm99IiwKICAgICAgICAgICAgICAgICAgICBpZUh0bWw1RG5EOiB0aGlzLm9Db250cm9sbGVyLmdldFZpZXcoKS5pZUh0bWw1RG5ELAogICAgICAgICAgICAgICAgICAgIHRpbGVWaWV3czogewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiAiY29udGVudCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhY3Rvcnk6IGZ1bmN0aW9uIChzSWQsIG9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb0NvbnRleHQuZ2V0T2JqZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGNvdmVyRGl2UHJlc3M6IGZ1bmN0aW9uIChvRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyB0aWxlIGhhZCBqdXN0IGJlZW4gbW92ZWQgYW5kIHRoZSBtb3ZlIGl0c2VsZiBkaWQgbm90IGZpbmlzaCByZWZyZXNoaW5nIHRoZSB0aWxlJ3MgdmlldwogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBkbyBub3Qgb3BlbiB0aGUgYWN0aW9ucyBtZW51IHRvIGF2b2lkIGluY29uc2lzdGVuY2llcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9FdmVudC5vU291cmNlLmdldEJpbmRpbmdDb250ZXh0KCkuZ2V0T2JqZWN0KCkudGlsZUlzQmVpbmdNb3ZlZCAmJiBzYXAudXNoZWxsLmNvbXBvbmVudHMuaG9tZXBhZ2UuQWN0aW9uTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLkFjdGlvbk1vZGUuX29wZW5BY3Rpb25zTWVudShvRXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBzaG93QWN0aW9uczogZnVuY3Rpb24gKG9FdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLkFjdGlvbk1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5BY3Rpb25Nb2RlLl9vcGVuQWN0aW9uc01lbnUob0V2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlUHJlc3M6IFt0aGlzLm9Db250cm9sbGVyLl9kYXNoYm9hcmREZWxldGVUaWxlSGFuZGxlciwgdGhpcy5vQ29udHJvbGxlcl0sCiAgICAgICAgICAgICAgICAgICAgcHJlc3M6IFt0aGlzLm9Db250cm9sbGVyLmRhc2hib2FyZFRpbGVQcmVzcywgdGhpcy5vQ29udHJvbGxlcl0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIG9WaWV3UG9ydENvbnRhaW5lciA9IHNhcC51aS5nZXRDb3JlKCkuYnlJZCgidmlld1BvcnRDb250YWluZXIiKTsKICAgICAgICAgICAgICAgIG9UaWxlLmFkZEV2ZW50RGVsZWdhdGUoewogICAgICAgICAgICAgICAgICAgIG9uY2xpY2s6IGZ1bmN0aW9uICgvKm9FdmVudCovKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIE1lYXN1cmVtZW50LnN0YXJ0KCJGTFA6RGFzaGJvYXJkR3JvdXBzQm94Lm9uY2xpY2siLCAiQ2xpY2sgb24gdGlsZSIsICJGTFAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgTWVhc3VyZW1lbnQuc3RhcnQoIkZMUDpPcGVuQXBwbGljYXRpb25vbkNsaWNrIiwgIk9wZW4gQXBwbGljYXRpb24iLCAiRkxQIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGVuZFRpbGVNZWFzdXJlbWVudCAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBNZWFzdXJlbWVudC5lbmQoIkZMUDpEYXNoYm9hcmRHcm91cHNCb3gub25jbGljayIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb1ZpZXdQb3J0Q29udGFpbmVyLmRldGFjaEFmdGVyTmF2aWdhdGUoZW5kVGlsZU1lYXN1cmVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBvVmlld1BvcnRDb250YWluZXIuYXR0YWNoQWZ0ZXJOYXZpZ2F0ZShlbmRUaWxlTWVhc3VyZW1lbnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIG9UaWxlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgX3VwZGF0ZUdyb3VwSGVhZGVyVmlzaWJpbGl0eTogZnVuY3Rpb24gKG9BLCBvQiwgb0dyb3VwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVGaXJzdEdyb3VwSGVhZGVyVmlzaWJpbGl0eSgKICAgICAgICAgICAgICAgICAgICBvR3JvdXAuZ3JvdXAuZ2V0TW9kZWwoKS5nZXRQcm9wZXJ0eSgiL3RpbGVBY3Rpb25Nb2RlQWN0aXZlIiksCiAgICAgICAgICAgICAgICAgICAgdGhpcy5vTW9kZWwuZ2V0UHJvcGVydHkoIi9ob21lUGFnZUdyb3VwRGlzcGxheSIpICE9PSAidGFicyIpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgX3VwZGF0ZUZpcnN0R3JvdXBIZWFkZXJWaXNpYmlsaXR5OiBmdW5jdGlvbiAoYklzRWRpdE1vZGUsIGJFbmFibGVBbmNob3JCYXIpIHsKICAgICAgICAgICAgICAgIHZhciBhR3JvdXBzID0gdGhpcy5vR3JvdXBzQ29udGFpbmVyLmdldEdyb3VwcygpLAogICAgICAgICAgICAgICAgICAgIGlGaXJzdFZpc2libGUsCiAgICAgICAgICAgICAgICAgICAgaVZpc2libGVHcm91cHMgPSAwOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYUdyb3Vwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChhR3JvdXBzW2ldLmdldFByb3BlcnR5KCJ2aXNpYmxlIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaVZpc2libGVHcm91cHMrKzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpRmlyc3RWaXNpYmxlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlGaXJzdFZpc2libGUgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYUdyb3Vwc1tpXS5zZXRTaG93R3JvdXBIZWFkZXIoYklzRWRpdE1vZGUgfHwgYkVuYWJsZUFuY2hvckJhcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGlGaXJzdFZpc2libGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHZhciBzR3JvdXBzTW9kZSA9IHRoaXMub01vZGVsLmdldFByb3BlcnR5KCIvaG9tZVBhZ2VHcm91cERpc3BsYXkiKSwKICAgICAgICAgICAgICAgICAgICAgICAgYlZpc2libGUgPSBiSXNFZGl0TW9kZSB8fCAoaVZpc2libGVHcm91cHMgPT09IDEgJiYgYkVuYWJsZUFuY2hvckJhciksCiAgICAgICAgICAgICAgICAgICAgICAgIGJGaXJzdEdyb3VwID0gYUdyb3Vwcy5sZW5ndGggPiAxIHx8IHNHcm91cHNNb2RlID09PSAidGFicyI7CiAgICAgICAgICAgICAgICAgICAgYUdyb3Vwc1tpRmlyc3RWaXNpYmxlXS5zZXRTaG93R3JvdXBIZWFkZXIoYlZpc2libGUsIGJGaXJzdEdyb3VwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIF9oYW5kbGVBY3Rpb25Nb2RlQ2hhbmdlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYkFjdGl2ZU1vZGUgPSB0aGlzLm9Nb2RlbC5nZXRQcm9wZXJ0eSgiL3RpbGVBY3Rpb25Nb2RlQWN0aXZlIik7CiAgICAgICAgICAgICAgICBpZiAoYkFjdGl2ZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZGRUaWxlQ29udGFpbmVyc0NvbnRlbnQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaW4gb3JkZXIgdG8gc2V0IGdyb3VwcyBhZ2FpbiB0byB0aGVpciByaWdodCBwb3NpdGlvbiBhZnRlciBjbG9zaW5nIGVkaXQgbW9kZSwgd2Ugd2lsbCBuZWVkIHRvIHJlLXJlbmRlcgogICAgICAgICAgICAgICAgICAgIC8vIHRoZSBncm91cHMgbGF5b3V0LiBXZSBuZWVkIGl0IGZvciB0aGUgTG9ja2VkIEdyb3VwcyBDb21wYWN0IExheW91dCBmZWF0dXJlCiAgICAgICAgICAgICAgICAgICAgTGF5b3V0LnJlUmVuZGVyR3JvdXBzTGF5b3V0KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgX2FkZFRpbGVDb250YWluZXJzQ29udGVudDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGFHcm91cHMgPSB0aGlzLm9Hcm91cHNDb250YWluZXIuZ2V0R3JvdXBzKCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFHcm91cHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb0dyb3VwID0gYUdyb3Vwc1tpXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFvR3JvdXAuZ2V0QmVmb3JlQ29udGVudCgpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBvR3JvdXAuYWRkQmVmb3JlQ29udGVudCh0aGlzLl9nZXRCZWZvcmVDb250ZW50KCkpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKCFvR3JvdXAuZ2V0QWZ0ZXJDb250ZW50KCkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9Hcm91cC5hZGRBZnRlckNvbnRlbnQodGhpcy5fZ2V0QWZ0ZXJDb250ZW50KCkpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKCFvR3JvdXAuZ2V0SGVhZGVyQWN0aW9ucygpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBvR3JvdXAuYWRkSGVhZGVyQWN0aW9uKHRoaXMuX2dldEdyb3VwSGVhZGVyQWN0aW9uKCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIF9oYW5kbGVBZGRHcm91cEJ1dHRvblByZXNzOiBmdW5jdGlvbiAob0RhdGEpIHsKICAgICAgICAgICAgICAgIHRoaXMub0NvbnRyb2xsZXIuX2FkZEdyb3VwSGFuZGxlcihvRGF0YSk7CiAgICAgICAgICAgICAgICB0aGlzLl9hZGRUaWxlQ29udGFpbmVyc0NvbnRlbnQoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIF9nZXRCZWZvcmVDb250ZW50OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgb0FkZEdyb3VwQnV0dG9uID0gbmV3IEJ1dHRvbih7CiAgICAgICAgICAgICAgICAgICAgaWNvbjogInNhcC1pY29uOi8vYWRkIiwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiByZXNvdXJjZXMuaTE4bi5nZXRUZXh0KCJhZGRfZ3JvdXBfYXQiKSwKICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiAiez0gISR7aXNHcm91cExvY2tlZH0gJiYgISR7aXNEZWZhdWx0R3JvdXB9ICYmICR7L3RpbGVBY3Rpb25Nb2RlQWN0aXZlfX0iLAogICAgICAgICAgICAgICAgICAgIGVuYWJsZWQ6ICJ7PSAhJHsvZWRpdFRpdGxlfX0iLAogICAgICAgICAgICAgICAgICAgIHByZXNzOiBbdGhpcy5faGFuZGxlQWRkR3JvdXBCdXR0b25QcmVzcy5iaW5kKHRoaXMpXQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBvQWRkR3JvdXBCdXR0b24uYWRkU3R5bGVDbGFzcygic2FwVXNoZWxsQWRkR3JvdXBCdXR0b24iKTsKICAgICAgICAgICAgICAgIG9BZGRHcm91cEJ1dHRvbi5hZGRDdXN0b21EYXRhKG5ldyBBY2Nlc3NpYmlsaXR5Q3VzdG9tRGF0YSh7CiAgICAgICAgICAgICAgICAgICAga2V5OiAidGFiaW5kZXgiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiLTEiLAogICAgICAgICAgICAgICAgICAgIHdyaXRlVG9Eb206IHRydWUKICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gb0FkZEdyb3VwQnV0dG9uOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgX2dldEFmdGVyQ29udGVudDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIG9BZGRHcm91cEJ1dHRvbiA9IG5ldyBCdXR0b24oewogICAgICAgICAgICAgICAgICAgIGljb246ICJzYXAtaWNvbjovL2FkZCIsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogcmVzb3VyY2VzLmkxOG4uZ2V0VGV4dCgiYWRkX2dyb3VwX2F0IiksCiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogIns9ICR7aXNMYXN0R3JvdXB9ICYmICR7L3RpbGVBY3Rpb25Nb2RlQWN0aXZlfX0iLAogICAgICAgICAgICAgICAgICAgIGVuYWJsZWQ6ICJ7PSAhJHsvZWRpdFRpdGxlfX0iLAogICAgICAgICAgICAgICAgICAgIHByZXNzOiBbdGhpcy5faGFuZGxlQWRkR3JvdXBCdXR0b25QcmVzcy5iaW5kKHRoaXMpXQogICAgICAgICAgICAgICAgfSkuYWRkU3R5bGVDbGFzcygic2FwVXNoZWxsQWRkR3JvdXBCdXR0b24iKTsKICAgICAgICAgICAgICAgIG9BZGRHcm91cEJ1dHRvbi5hZGRTdHlsZUNsYXNzKCJzYXBVc2hlbGxBZGRHcm91cEJ1dHRvbiIpOwogICAgICAgICAgICAgICAgb0FkZEdyb3VwQnV0dG9uLmFkZEN1c3RvbURhdGEobmV3IEFjY2Vzc2liaWxpdHlDdXN0b21EYXRhKHsKICAgICAgICAgICAgICAgICAgICBrZXk6ICJ0YWJpbmRleCIsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICItMSIsCiAgICAgICAgICAgICAgICAgICAgd3JpdGVUb0RvbTogdHJ1ZQogICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgIHJldHVybiBvQWRkR3JvdXBCdXR0b247CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBfZ2V0R3JvdXBIZWFkZXJBY3Rpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgR3JvdXBIZWFkZXJBY3Rpb25zKHsKICAgICAgICAgICAgICAgICAgICBjb250ZW50OiB0aGlzLl9nZXRIZWFkZXJBY3Rpb25zKCksCiAgICAgICAgICAgICAgICAgICAgdGlsZUFjdGlvbk1vZGVBY3RpdmU6ICJ7L3RpbGVBY3Rpb25Nb2RlQWN0aXZlfSIsCiAgICAgICAgICAgICAgICAgICAgaXNPdmVyZmxvdzogInsvaXNQaG9uZVdpZHRofSIKICAgICAgICAgICAgICAgIH0pLmFkZFN0eWxlQ2xhc3MoInNhcFVzaGVsbE92ZXJsYXlHcm91cEFjdGlvblBhbmVsIik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBfZ2V0SGVhZGVyQWN0aW9uczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGFIZWFkZXJCdXR0b25zID0gW107CgogICAgICAgICAgICAgICAgaWYgKENvbmZpZy5sYXN0KCIvY29yZS9ob21lL2dyaWRDb250YWluZXIiKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBvQWRkVGlsZUJ1dHRvbiA9IG5ldyBCdXR0b24oewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiByZXNvdXJjZXMuaTE4bi5nZXRUZXh0KCJBZGRUaWxlQnRuIiksCiAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGU6ICJ7PSAhJHtpc0dyb3VwTG9ja2VkfX0iLAogICAgICAgICAgICAgICAgICAgICAgICBlbmFibGVkOiAiez0gISR7L2VkaXRUaXRsZX19IiwKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc3M6IHRoaXMuX2hhbmRsZUFkZFRpbGVUb0dyb3VwLmJpbmQodGhpcykKICAgICAgICAgICAgICAgICAgICB9KS5hZGRTdHlsZUNsYXNzKCJzYXBVc2hlbGxIZWFkZXJBY3Rpb25CdXR0b24iKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKERldmljZS5zeXN0ZW0ucGhvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb0FkZFRpbGVCdXR0b24uc2V0SWNvbigic2FwLWljb246Ly9hZGQiKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGFIZWFkZXJCdXR0b25zLnB1c2gob0FkZFRpbGVCdXR0b24pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGFIZWFkZXJCdXR0b25zLnB1c2gobmV3IEJ1dHRvbih7CiAgICAgICAgICAgICAgICAgICAgdGV4dDogewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiAiaXNHcm91cFZpc2libGUiLAogICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6IGZ1bmN0aW9uIChiSXNHcm91cFZpc2libGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvdXJjZXMuaTE4bi5nZXRUZXh0KGJJc0dyb3VwVmlzaWJsZSA/ICJIaWRlR3JvdXBCdG4iIDogIlNob3dHcm91cEJ0biIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBpY29uOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6ICJpc0dyb3VwVmlzaWJsZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlcjogZnVuY3Rpb24gKGJJc0dyb3VwVmlzaWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKERldmljZS5zeXN0ZW0ucGhvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYklzR3JvdXBWaXNpYmxlID8gInNhcC1pY29uOi8vaGlkZSIgOiAic2FwLWljb246Ly9zaG93IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogIns9ICR7L2VuYWJsZUhpZGVHcm91cHN9ICYmICEke2lzR3JvdXBMb2NrZWR9ICYmICEke2lzRGVmYXVsdEdyb3VwfX0iLAogICAgICAgICAgICAgICAgICAgIGVuYWJsZWQ6ICJ7PSAhJHsvZWRpdFRpdGxlfX0iLAogICAgICAgICAgICAgICAgICAgIHByZXNzOiBmdW5jdGlvbiAob0V2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvU291cmNlID0gb0V2ZW50LmdldFNvdXJjZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb0dyb3VwQmluZGluZ0N0eCA9IG9Tb3VyY2UuZ2V0QmluZGluZ0NvbnRleHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vQ29udHJvbGxlci5fY2hhbmdlR3JvdXBWaXNpYmlsaXR5KG9Hcm91cEJpbmRpbmdDdHgpOwogICAgICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKQogICAgICAgICAgICAgICAgfSkuYWRkU3R5bGVDbGFzcygic2FwVXNoZWxsSGVhZGVyQWN0aW9uQnV0dG9uIikpOwoKICAgICAgICAgICAgICAgIGFIZWFkZXJCdXR0b25zLnB1c2gobmV3IEJ1dHRvbih7CiAgICAgICAgICAgICAgICAgICAgdGV4dDogewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiAicmVtb3ZhYmxlIiwKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyOiBmdW5jdGlvbiAoYklzUmVtb3ZhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb3VyY2VzLmkxOG4uZ2V0VGV4dChiSXNSZW1vdmFibGUgPyAiRGVsZXRlR3JvdXBCdG4iIDogIlJlc2V0R3JvdXBCdG4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgaWNvbjogewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoOiAicmVtb3ZhYmxlIiwKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyOiBmdW5jdGlvbiAoYklzUmVtb3ZhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoRGV2aWNlLnN5c3RlbS5waG9uZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBiSXNSZW1vdmFibGUgPyAic2FwLWljb246Ly9kZWxldGUiIDogInNhcC1pY29uOi8vcmVmcmVzaCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHZpc2libGU6ICJ7PSAhJHtpc0RlZmF1bHRHcm91cH19IiwKICAgICAgICAgICAgICAgICAgICBlbmFibGVkOiAiez0gISR7L2VkaXRUaXRsZX19IiwKICAgICAgICAgICAgICAgICAgICBwcmVzczogZnVuY3Rpb24gKG9FdmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb1NvdXJjZSA9IG9FdmVudC5nZXRTb3VyY2UoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9Hcm91cEJpbmRpbmdDdHggPSBvU291cmNlLmdldEJpbmRpbmdDb250ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub0NvbnRyb2xsZXIuX2hhbmRsZUdyb3VwRGVsZXRpb24ob0dyb3VwQmluZGluZ0N0eCk7CiAgICAgICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpCiAgICAgICAgICAgICAgICB9KS5hZGRTdHlsZUNsYXNzKCJzYXBVc2hlbGxIZWFkZXJBY3Rpb25CdXR0b24iKSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGFIZWFkZXJCdXR0b25zOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgX2hhbmRsZUFkZFRpbGVUb0dyb3VwOiBmdW5jdGlvbiAob0V2ZW50KSB7CiAgICAgICAgICAgICAgICAvL0ZpeCBpbnRlcm5hbCBpbmNpZGVudCAjMTc4MDM3MDIyMiAyMDE3CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQudG9EZXRhaWwpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC50b0RldGFpbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgQ29tcG9uZW50LmdldE93bmVyQ29tcG9uZW50Rm9yKHRoaXMub0NvbnRyb2xsZXIuZ2V0VmlldygpLnBhcmVudENvbXBvbmVudCkuZ2V0Um91dGVyKCkubmF2VG8oImFwcGZpbmRlciIsIHsKICAgICAgICAgICAgICAgICAgICAiaW5uZXJIYXNoKiI6ICJjYXRhbG9nLyIgKyBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldEdyb3VwOiBlbmNvZGVVUklDb21wb25lbnQob0V2ZW50LmdldFNvdXJjZSgpLmdldEJpbmRpbmdDb250ZXh0KCkuc1BhdGgpCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgX2hpZGVQbHVzVGlsZTogZnVuY3Rpb24gKHBsdXNUaWxlRG9tUmVmKSB7CiAgICAgICAgICAgICAgICBpZiAocGx1c1RpbGVEb21SZWYpIHsKICAgICAgICAgICAgICAgICAgICBwbHVzVGlsZURvbVJlZi5jbGFzc0xpc3QuYWRkKCJzYXBVc2hlbGxIaWRlUGx1c1RpbGUiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIF9zaG93UGx1c1RpbGU6IGZ1bmN0aW9uIChwbHVzVGlsZURvbVJlZikgewogICAgICAgICAgICAgICAgaWYgKHBsdXNUaWxlRG9tUmVmKSB7CiAgICAgICAgICAgICAgICAgICAgcGx1c1RpbGVEb21SZWYuY2xhc3NMaXN0LnJlbW92ZSgic2FwVXNoZWxsSGlkZVBsdXNUaWxlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIERhc2hib2FyZEdyb3Vwc0JveDsKICAgIH0pOwp9LAoJInNhcC91c2hlbGwvY29tcG9uZW50cy9ob21lcGFnZS9EYXNoYm9hcmRVSUFjdGlvbnMuanMiOmZ1bmN0aW9uKCl7Ly8gJHtjb3B5cmlnaHR9CgovKioKICogQGZpbGVPdmVydmlldyBBIG1vZHVsZSB0aGF0IGlzIHJlc3BvbnNpYmxlIGZvciBpbml0aWFsaXppbmcgdGhlIGRhc2hib2FyZCBVSUFjdGlvbnMgKGkuZS4gZHJhZyBhbmQgZHJvcCkgb2YgZ3JvdXBzIGFuZCB0aWxlcy48YnI+CiAqIEV4dGVuZHMgPGNvZGU+c2FwLnVpLmJhc2UuT2JqZWN0PC9jb2RlPjxicj4KICogRXhwb3NlcyB0aGUgcHVibGljIGZ1bmN0aW9uIDxjb2RlPmluaXRpYWxpemVVSUFjdGlvbnM8L2NvZGU+CiAqCiAqIEB2ZXJzaW9uICR7dmVyc2lvbn0KICogQG5hbWUgc2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLkRhc2hib2FyZFVJQWN0aW9ucwogKiBAc2luY2UgMS4zNS4wCiAqIEBwcml2YXRlCiAqLwpzYXAudWkuZGVmaW5lKFsKICAgICJzYXAvdWkvYmFzZS9PYmplY3QiLAogICAgInNhcC91c2hlbGwvTGF5b3V0IiwKICAgICJzYXAvdWkvRGV2aWNlIiwKICAgICJzYXAvdWkvdGhpcmRwYXJ0eS9qcXVlcnkiLAogICAgInNhcC9iYXNlL0xvZyIKXSwgZnVuY3Rpb24gKAogICAgYmFzZU9iamVjdCwKICAgIExheW91dCwKICAgIERldmljZSwKICAgIGpRdWVyeSwKICAgIExvZwopIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgRGFzaGJvYXJkVUlBY3Rpb25zID0gYmFzZU9iamVjdC5leHRlbmQoInNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5EYXNoYm9hcmRVSUFjdGlvbnMiLCB7CiAgICAgICAgbWV0YWRhdGE6IHsKICAgICAgICAgICAgcHVibGljTWV0aG9kczogWyJpbml0aWFsaXplVUlBY3Rpb25zIl0KICAgICAgICB9LAoKICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKC8qc0lkLCBtU2V0dGluZ3MqLykgewogICAgICAgICAgICB0aGlzLmFUYWJCYXJJdGVtc0xvY2F0aW9uID0gW107CgogICAgICAgICAgICAvLyBNYWtlIHRoaXMgY2xhc3Mgb25seSBhdmFpbGFibGUgb25jZQogICAgICAgICAgICBpZiAoc2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLmdldERhc2hib2FyZFVJQWN0aW9ucyAmJiBzYXAudXNoZWxsLmNvbXBvbmVudHMuaG9tZXBhZ2UuZ2V0RGFzaGJvYXJkVUlBY3Rpb25zKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzYXAudXNoZWxsLmNvbXBvbmVudHMuaG9tZXBhZ2UuZ2V0RGFzaGJvYXJkVUlBY3Rpb25zKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLmdldERhc2hib2FyZFVJQWN0aW9ucyA9IChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSh0aGlzLmdldEludGVyZmFjZSgpKSk7CgogICAgICAgICAgICB0aGlzLm9UaWxlVUlBY3Rpb25zID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLm9MaW5rVUlBY3Rpb25zID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLm9Hcm91cFVJQWN0aW9ucyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdGhpcy5vQ29udHJvbGxlciA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdGhpcy5VSUFjdGlvbnNJbml0aWFsaXplZCA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gRW5hYmxpbmcgYW5kIGRpc2FibGluZyBkcmFnIGFuZCBkcm9wIG9mIGdyb3VwcyAoZ3JvdXBzVUlBY3Rpb24pIGRlcGVuZHMgb2YgYWN0aXZhdGlvbiBhbmQgYWN0aXZhdGlvbiBvZiBBY3Rpb25Nb2RlCiAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoImxhdW5jaHBhZCIsICJhY3Rpb25Nb2RlQWN0aXZlIiwgdGhpcy5fZW5hYmxlR3JvdXBVSUFjdGlvbnMsIHRoaXMpOwogICAgICAgICAgICBzYXAudWkuZ2V0Q29yZSgpLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKCJsYXVuY2hwYWQiLCAiYWN0aW9uTW9kZUluYWN0aXZlIiwgdGhpcy5fZGlzYWJsZUdyb3VwVUlBY3Rpb25zLCB0aGlzKTsKICAgICAgICB9LAoKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS51bnN1YnNjcmliZSgibGF1bmNocGFkIiwgImFjdGlvbk1vZGVBY3RpdmUiLCB0aGlzLl9lbmFibGVHcm91cFVJQWN0aW9ucywgdGhpcyk7CiAgICAgICAgICAgIHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKS51bnN1YnNjcmliZSgibGF1bmNocGFkIiwgImFjdGlvbk1vZGVJbmFjdGl2ZSIsIHRoaXMuX2Rpc2FibGVHcm91cFVJQWN0aW9ucywgdGhpcyk7CiAgICAgICAgICAgIHNhcC51c2hlbGwuY29tcG9uZW50cy5ob21lcGFnZS5nZXREYXNoYm9hcmRVSUFjdGlvbnMgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHRoaXMub0dyb3VwVUlBY3Rpb25zID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5vVGlsZVVJQWN0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMub0xpbmtVSUFjdGlvbnMgPSBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENyZWF0aW5nIFVJQWN0aW9uIG9iamVjdHMgZm9yIHRpbGVzIGFuZCBncm91cHMgaW4gb3JkZXIgdG8gYWxsb3cgZGFzaGJvYXJkIGRyYWcgYW5kIGRyb3AgYWN0aW9ucwogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IFRoZSBEYXNoYm9hcmRDb250ZW50LmNvbnRyb2xsZXIgaW5zdGFuY2UKICAgICAgICAgKgogICAgICAgICAqIEBzaW5jZSAxLjM1CiAgICAgICAgICoKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemVVSUFjdGlvbnM6IGZ1bmN0aW9uIChvQ29udHJvbGxlcikgewogICAgICAgICAgICB0aGlzLm9Db250cm9sbGVyID0gb0NvbnRyb2xsZXI7CiAgICAgICAgICAgIC8vIElmIFRhYkJhciBtb2RlIGFjdGl2ZSAtIGNhbGN1bGF0ZSBUYWJCYXIgaXRlbXMgcG9zaXRpb24KICAgICAgICAgICAgaWYgKG9Db250cm9sbGVyLmdldFZpZXcoKS5nZXRNb2RlbCgpLmdldFByb3BlcnR5KCIvaG9tZVBhZ2VHcm91cERpc3BsYXkiKSA9PT0gInRhYnMiKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9maWxsVGFiQmFySXRlbXNBcnJheSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaXNMaW5rUGVyc29uYWxpemF0aW9uU3VwcG9ydGVkID0gc2FwLnVzaGVsbC5Db250YWluZXIgPyBzYXAudXNoZWxsLkNvbnRhaW5lci5nZXRTZXJ2aWNlKCJMYXVuY2hQYWdlIikuaXNMaW5rUGVyc29uYWxpemF0aW9uU3VwcG9ydGVkKCkgOiBudWxsOwogICAgICAgICAgICB2YXIgaVBhZ2VXaWR0aCA9IGpRdWVyeSgiI3NhcFVzaGVsbERhc2hib2FyZFBhZ2UiKS53aWR0aCgpOwoKICAgICAgICAgICAgdmFyIHNEYXNoYm9hcmRHcm91cHNXcmFwcGVySWQgPSBvQ29udHJvbGxlci5nZXRWaWV3KCkuc0Rhc2hib2FyZEdyb3Vwc1dyYXBwZXJJZCwKICAgICAgICAgICAgICAgIGJBY3Rpb25Nb2RlQWN0aXZlLAogICAgICAgICAgICAgICAgYlJpZ2h0VG9MZWZ0ID0gc2FwLnVpLmdldENvcmUoKS5nZXRDb25maWd1cmF0aW9uKCkuZ2V0UlRMKCksCgogICAgICAgICAgICAgICAgLy8gT2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIGNvbW1vbiBhdHRyaWJ1dGVkIHJlcXVpcmVkIG9mIHRoZSBjcmVhdGlvbiBvZiBvVGlsZVVJQWN0aW9ucyBhbmQgb0dyb3VwVUlBY3Rpb25zIGluIFdpbjggdXNlLWNhc2UKICAgICAgICAgICAgICAgIG9Db21tb25VSUFjdGlvbnNEYXRhRm9yV2luOCA9IHsKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJTZWxlY3RvcjogIiNkYXNoYm9hcmRHcm91cHMiLAogICAgICAgICAgICAgICAgICAgIHdyYXBwZXJTZWxlY3Rvcjogc0Rhc2hib2FyZEdyb3Vwc1dyYXBwZXJJZCA/ICIjIiArIHNEYXNoYm9hcmRHcm91cHNXcmFwcGVySWQgOiB1bmRlZmluZWQsIC8vIFRoZSBpZCBvZiB0aGUgPHNlY3Rpb24+IHRoYXQgd3JhcHMgZGFzaGJvYXJkR3JvdXBzIGRpdjogI19fcGFnZTAtY29udAogICAgICAgICAgICAgICAgICAgIHJvb3RTZWxlY3RvcjogIiNzaGVsbCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvLyBPYmplY3QgdGhhdCBjb250YWlucyB0aGUgY29tbW9uIGF0dHJpYnV0ZWQgcmVxdWlyZWQgb2YgdGhlIGNyZWF0aW9uIG9mIG9UaWxlVUlBY3Rpb25zIGFuZCBvR3JvdXBVSUFjdGlvbnMsIGluY2x1ZGluZyBXaW44IGF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgIG9Db21tb25VSUFjdGlvbnNEYXRhID0galF1ZXJ5LmV4dGVuZCh0cnVlLCB7fSwgb0NvbW1vblVJQWN0aW9uc0RhdGFGb3JXaW44LCB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoTW9kZURlbGF5OiAxMDAwLAogICAgICAgICAgICAgICAgICAgIGlzVG91Y2g6IG9Db250cm9sbGVyLmdldFZpZXcoKS5pc1RvdWNoLAogICAgICAgICAgICAgICAgICAgIGlzQ29tYmk6IG9Db250cm9sbGVyLmdldFZpZXcoKS5pc0NvbWJpLAogICAgICAgICAgICAgICAgICAgIGRlYnVnOiBmYWxzZQogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBvTGlua1VJQWN0aW9uc0RhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgZHJhZ2dhYmxlU2VsZWN0b3I6ICIuc2FwVXNoZWxsTGlua1RpbGUiLAogICAgICAgICAgICAgICAgICAgIHBsYWNlSG9sZGVyQ2xhc3M6ICJzYXBVc2hlbGxMaW5rVGlsZS1wbGFjZWhvbGRlciIsCiAgICAgICAgICAgICAgICAgICAgY2xvbmVDbGFzczogInNhcFVzaGVsbExpbmtUaWxlLWNsb25lIiwKICAgICAgICAgICAgICAgICAgICBzdGFydENhbGxiYWNrOiB0aGlzLl9oYW5kbGVUaWxlVUlTdGFydC5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIGVuZENhbGxiYWNrOiB0aGlzLl9oYW5kbGVMaW5rRHJvcC5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIGRyYWdDYWxsYmFjazogdGhpcy5faGFuZGxlU3RhcnREcmFnVGlsZS5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIG9uQmVmb3JlQ3JlYXRlQ2xvbmU6IHRoaXMuX29uQmVmb3JlQ3JlYXRlTGlua0Nsb25lLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgZHJhZ0FuZFNjcm9sbENhbGxiYWNrOiB0aGlzLl9oYW5kbGVUaWxlRHJhZ01vdmUuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBlbmREcmFnQW5kU2Nyb2xsQ2FsbGJhY2s6IHRoaXMuX2hhbmRsZVRpbGVEcmFnQW5kU2Nyb2xsQ29udGludWF0aW9uLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgbW92ZVRvbGVyYW5jZTogb0NvbnRyb2xsZXIuZ2V0VmlldygpLmlzVG91Y2ggfHwgb0NvbnRyb2xsZXIuZ2V0VmlldygpLmlzQ29tYmkgPyAxMCA6IDMsCiAgICAgICAgICAgICAgICAgICAgaXNMYXlvdXRFbmdpbmU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWREcmFnZ2FibGVTZWxlY3RvcjogInNhcFVzaGVsbExvY2tlZFRpbGUiLCAvL2NoZWNrIGxpY2tlZCBsaW5rcwogICAgICAgICAgICAgICAgICAgIG9uRHJhZ1N0YXJ0VUlIYW5kbGVyOiB0aGlzLl9tYXJrRGlzYWJsZUdyb3Vwcy5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIG9uRHJhZ0VuZFVJSGFuZGxlcjogdGhpcy5fZW5kVUlIYW5kbGVyLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0TGVmdDogYlJpZ2h0VG9MZWZ0ID8gaVBhZ2VXaWR0aCA6IC1pUGFnZVdpZHRoLAogICAgICAgICAgICAgICAgICAgIGRlZmF1bHRNb3VzZU1vdmVIYW5kbGVyOiBmdW5jdGlvbiAoKSB7IH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBvVGlsZVVJQWN0aW9uc0RhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgZHJhZ2dhYmxlU2VsZWN0b3I6ICIuc2FwVXNoZWxsVGlsZSIsCiAgICAgICAgICAgICAgICAgICAgZHJhZ2dhYmxlU2VsZWN0b3JFeGNsdWRlOiAiLnNhcFVzaGVsbFBsdXNUaWxlIiwKICAgICAgICAgICAgICAgICAgICBwbGFjZUhvbGRlckNsYXNzOiAic2FwVXNoZWxsVGlsZS1wbGFjZWhvbGRlciIsCiAgICAgICAgICAgICAgICAgICAgY2xvbmVDbGFzczogInNhcFVzaGVsbFRpbGUtY2xvbmUiLAogICAgICAgICAgICAgICAgICAgIGRlbHRhVG9wOiAtNDQsCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsQ29udGFpbmVyU2VsZWN0b3I6IHVuZGVmaW5lZCwgLy8gQFRPRE8gcmVtb3ZlIHRoaXMKICAgICAgICAgICAgICAgICAgICBzdGFydENhbGxiYWNrOiB0aGlzLl9oYW5kbGVUaWxlVUlTdGFydC5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIGVuZENhbGxiYWNrOiB0aGlzLl9oYW5kbGVUaWxlRHJvcC5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIGRyYWdDYWxsYmFjazogdGhpcy5faGFuZGxlU3RhcnREcmFnVGlsZS5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIGRyYWdBbmRTY3JvbGxDYWxsYmFjazogdGhpcy5faGFuZGxlVGlsZURyYWdNb3ZlLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgZW5kRHJhZ0FuZFNjcm9sbENhbGxiYWNrOiB0aGlzLl9oYW5kbGVUaWxlRHJhZ0FuZFNjcm9sbENvbnRpbnVhdGlvbi5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIG1vdmVUb2xlcmFuY2U6IG9Db250cm9sbGVyLmdldFZpZXcoKS5pc1RvdWNoIHx8IG9Db250cm9sbGVyLmdldFZpZXcoKS5pc0NvbWJpID8gMTAgOiAzLAogICAgICAgICAgICAgICAgICAgIGlzTGF5b3V0RW5naW5lOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGRpc2FibGVkRHJhZ2dhYmxlU2VsZWN0b3I6ICJzYXBVc2hlbGxMb2NrZWRUaWxlIiwKICAgICAgICAgICAgICAgICAgICBvbkRyYWdTdGFydFVJSGFuZGxlcjogdGhpcy5fbWFya0Rpc2FibGVHcm91cHMuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBvbkRyYWdFbmRVSUhhbmRsZXI6IHRoaXMuX2VuZFVJSGFuZGxlci5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIG9mZnNldExlZnQ6IGJSaWdodFRvTGVmdCA/IGlQYWdlV2lkdGggOiAtaVBhZ2VXaWR0aCwKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0TW91c2VNb3ZlSGFuZGxlcjogZnVuY3Rpb24gKCkgeyB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb0dyb3VwVUlBY3Rpb25zRGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICBkcmFnZ2FibGVTZWxlY3RvcjogIi5zYXBVc2hlbGxEYXNoYm9hcmRHcm91cHNDb250YWluZXJJdGVtOm5vdCguc2FwVXNoZWxsRGlzYWJsZURyYWdBbmREcm9wKSIsCiAgICAgICAgICAgICAgICAgICAgZHJhZ2dhYmxlU2VsZWN0b3JCbG9ja2VyOiAiLnNhcFVzaGVsbFRpbGVzQ29udGFpbmVyLXNvcnRhYmxlLCAuc2FwVXNoZWxsVGlsZUNvbnRhaW5lckJlZm9yZUNvbnRlbnQsIC5zYXBVc2hlbGxUaWxlQ29udGFpbmVyQWZ0ZXJDb250ZW50IiwKICAgICAgICAgICAgICAgICAgICBkcmFnZ2FibGVTZWxlY3RvckV4Y2x1ZGU6ICIuc2FwVXNoZWxsSGVhZGVyQWN0aW9uQnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICBwbGFjZUhvbGRlckNsYXNzOiAic2FwVXNoZWxsRGFzaGJvYXJkR3JvdXBzQ29udGFpbmVySXRlbS1wbGFjZWhvbGRlciIsCiAgICAgICAgICAgICAgICAgICAgY2xvbmVDbGFzczogInNhcFVzaGVsbERhc2hib2FyZEdyb3Vwc0NvbnRhaW5lckl0ZW0tY2xvbmUiLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0Q2FsbGJhY2s6IHRoaXMuX2hhbmRsZUdyb3Vwc1VJU3RhcnQuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBlbmRDYWxsYmFjazogdGhpcy5faGFuZGxlR3JvdXBEcm9wLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgZHJhZ0NhbGxiYWNrOiB0aGlzLl9oYW5kbGVHcm91cFN0YXJ0RHJhZy5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIG1vdmVUb2xlcmFuY2U6IG9Db250cm9sbGVyLmdldFZpZXcoKS5pc1RvdWNoIHx8IG9Db250cm9sbGVyLmdldFZpZXcoKS5pc0NvbWJpID8gMTAgOiAwLjEsCiAgICAgICAgICAgICAgICAgICAgaXNMYXlvdXRFbmdpbmU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGlzVmVydGljYWxEcmFnT25seTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBkcmFnZ2FibGVFbGVtZW50OiAiLnNhcFVzaGVsbFRpbGVDb250YWluZXJIZWFkZXIiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb1dpbjhUaWxlVUlBY3Rpb25zRGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAidGlsZXMiLAogICAgICAgICAgICAgICAgICAgIGRyYWdnYWJsZVNlbGVjdG9yOiAiLnNhcFVzaGVsbFRpbGUiLAogICAgICAgICAgICAgICAgICAgIHBsYWNlSG9sZGVyQ2xhc3M6ICJzYXBVc2hlbGxUaWxlLXBsYWNlaG9sZGVyIiwKICAgICAgICAgICAgICAgICAgICBjbG9uZUNsYXNzOiAic2FwVXNoZWxsVGlsZS1jbG9uZSIsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRDYWxsYmFjazogdGhpcy5faGFuZGxlVGlsZVVJU3RhcnQuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBlbmRDYWxsYmFjazogdGhpcy5faGFuZGxlVGlsZURyb3AuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBkcmFnQ2FsbGJhY2s6IHRoaXMuX2hhbmRsZVN0YXJ0RHJhZ1RpbGUuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBkcmFnQW5kU2Nyb2xsQ2FsbGJhY2s6IHRoaXMuX2hhbmRsZVRpbGVEcmFnTW92ZS5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIG9uRHJhZ1N0YXJ0VUlIYW5kbGVyOiB0aGlzLl9tYXJrRGlzYWJsZUdyb3Vwcy5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIG9uRHJhZ0VuZFVJSGFuZGxlcjogdGhpcy5fZW5kVUlIYW5kbGVyLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0TGVmdDogYlJpZ2h0VG9MZWZ0ID8gaVBhZ2VXaWR0aCA6IC1pUGFnZVdpZHRoCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb1dpbjhMaW5rVUlBY3Rpb25zRGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAibGlua3MiLAogICAgICAgICAgICAgICAgICAgIGRyYWdnYWJsZVNlbGVjdG9yOiAiLnNhcFVzaGVsbExpbmtUaWxlIiwKICAgICAgICAgICAgICAgICAgICBwbGFjZUhvbGRlckNsYXNzOiAic2FwVXNoZWxsTGlua1RpbGUtcGxhY2Vob2xkZXIiLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0Q2FsbGJhY2s6IHRoaXMuX2hhbmRsZVRpbGVVSVN0YXJ0LmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgZW5kQ2FsbGJhY2s6IHRoaXMuX2hhbmRsZUxpbmtEcm9wLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgZHJhZ0NhbGxiYWNrOiB0aGlzLl9oYW5kbGVTdGFydERyYWdUaWxlLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgZHJhZ0FuZFNjcm9sbENhbGxiYWNrOiB0aGlzLl9oYW5kbGVUaWxlRHJhZ01vdmUuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBvbkJlZm9yZUNyZWF0ZUNsb25lOiB0aGlzLl9vbkJlZm9yZUNyZWF0ZUxpbmtDbG9uZS5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIG9uRHJhZ1N0YXJ0VUlIYW5kbGVyOiB0aGlzLl9tYXJrRGlzYWJsZUdyb3Vwcy5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIG9uRHJhZ0VuZFVJSGFuZGxlcjogdGhpcy5fZW5kVUlIYW5kbGVyLmJpbmQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0TGVmdDogYlJpZ2h0VG9MZWZ0ID8gaVBhZ2VXaWR0aCA6IC1pUGFnZVdpZHRoCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb1dpbjhHcm91cFVJQWN0aW9uc0RhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogImdyb3VwcyIsCiAgICAgICAgICAgICAgICAgICAgZHJhZ2dhYmxlU2VsZWN0b3I6ICIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lckhlYWRlciIsCiAgICAgICAgICAgICAgICAgICAgcGxhY2VIb2xkZXJDbGFzczogInNhcFVzaGVsbERhc2hib2FyZEdyb3Vwc0NvbnRhaW5lckl0ZW0tcGxhY2Vob2xkZXIiLAogICAgICAgICAgICAgICAgICAgIF9wdWJsaXNoQXN5bmM6IG9Db250cm9sbGVyLl9wdWJsaXNoQXN5bmMKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDcmVhdGluZyB0aGUgc2FwLnVzaGVsbC5VSUFjdGlvbnMgb2JqZWN0cyBmb3IgdGlsZXMgYW5kIGdyb3VwcwogICAgICAgICAgICBpZiAob0NvbnRyb2xsZXIuZ2V0VmlldygpLm9EYXNoYm9hcmRHcm91cHNCb3guZ2V0R3JvdXBzKCkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAob0NvbnRyb2xsZXIuZ2V0VmlldygpLmdldE1vZGVsKCkuZ2V0UHJvcGVydHkoIi9wZXJzb25hbGl6YXRpb24iKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghb0NvbnRyb2xsZXIuZ2V0VmlldygpLmllSHRtbDVEbkQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2FwLnVpLnJlcXVpcmUoWyJzYXAvdXNoZWxsL1VJQWN0aW9ucyJdLCBmdW5jdGlvbiAoVUlBY3Rpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNhYmxlIHRoZSBwcmV2aW91cyBpbnN0YW5jZXMgb2YgVUlBY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9kaXNhYmxlVGlsZVVJQWN0aW9ucygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGlzYWJsZUdyb3VwVUlBY3Rpb25zKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9kaXNhYmxlTGlua1VJQWN0aW9ucygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhbmQgZW5hYmxlIHRpbGVzIFVJQWN0aW9ucwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vVGlsZVVJQWN0aW9ucyA9IG5ldyBVSUFjdGlvbnMoalF1ZXJ5LmV4dGVuZCh0cnVlLCB7fSwgb0NvbW1vblVJQWN0aW9uc0RhdGEsIG9UaWxlVUlBY3Rpb25zRGF0YSkpLmVuYWJsZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGdyb3VwcyBVSUFjdGlvbnMsIGVuYWJsaW5nIGhhcHBlbnMgYWNjb3JkaW5nIHRvIEFjdGlvbk1vZGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub0dyb3VwVUlBY3Rpb25zID0gbmV3IFVJQWN0aW9ucyhqUXVlcnkuZXh0ZW5kKHRydWUsIHt9LCBvQ29tbW9uVUlBY3Rpb25zRGF0YSwgb0dyb3VwVUlBY3Rpb25zRGF0YSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0xpbmtQZXJzb25hbGl6YXRpb25TdXBwb3J0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9MaW5rVUlBY3Rpb25zID0gbmV3IFVJQWN0aW9ucyhqUXVlcnkuZXh0ZW5kKHRydWUsIHt9LCBvQ29tbW9uVUlBY3Rpb25zRGF0YSwgb0xpbmtVSUFjdGlvbnNEYXRhKSkuZW5hYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYkFjdGlvbk1vZGVBY3RpdmUgPSBvQ29udHJvbGxlci5nZXRWaWV3KCkuZ2V0TW9kZWwoKS5nZXRQcm9wZXJ0eSgiL3RpbGVBY3Rpb25Nb2RlQWN0aXZlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYkFjdGlvbk1vZGVBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9Hcm91cFVJQWN0aW9ucy5lbmFibGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzYXAudWkucmVxdWlyZShbInNhcC91c2hlbGwvVUlBY3Rpb25zV2luOCJdLCBmdW5jdGlvbiAoVUlBY3Rpb25zV2luOCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGlzYWJsZVRpbGVVSUFjdGlvbnMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Rpc2FibGVHcm91cFVJQWN0aW9ucygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGlzYWJsZUxpbmtVSUFjdGlvbnMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhbmQgZW5hYmxlIHRpbGVzIGFuZCBncm91cHMgVUlBY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9UaWxlVUlBY3Rpb25zID0gVUlBY3Rpb25zV2luOC5nZXRJbnN0YW5jZShqUXVlcnkuZXh0ZW5kKHRydWUsIHt9LCBvQ29tbW9uVUlBY3Rpb25zRGF0YUZvcldpbjgsIG9XaW44VGlsZVVJQWN0aW9uc0RhdGEpKS5lbmFibGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub0xpbmtVSUFjdGlvbnMgPSBVSUFjdGlvbnNXaW44LmdldEluc3RhbmNlKGpRdWVyeS5leHRlbmQodHJ1ZSwge30sIG9Db21tb25VSUFjdGlvbnNEYXRhRm9yV2luOCwgb1dpbjhMaW5rVUlBY3Rpb25zRGF0YSkpLmVuYWJsZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vR3JvdXBVSUFjdGlvbnMgPSBVSUFjdGlvbnNXaW44LmdldEluc3RhbmNlKGpRdWVyeS5leHRlbmQodHJ1ZSwge30sIG9Db21tb25VSUFjdGlvbnNEYXRhRm9yV2luOCwgb1dpbjhHcm91cFVJQWN0aW9uc0RhdGEpKS5lbmFibGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfZW5hYmxlR3JvdXBVSUFjdGlvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMub0dyb3VwVUlBY3Rpb25zKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9Hcm91cFVJQWN0aW9ucy5lbmFibGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGRpc2FibGVBbGxEYXNoYm9hcmRVaUFjdGlvbjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLl9kaXNhYmxlVGlsZVVJQWN0aW9ucygpOwogICAgICAgICAgICB0aGlzLl9kaXNhYmxlTGlua1VJQWN0aW9ucygpOwogICAgICAgICAgICB0aGlzLl9kaXNhYmxlR3JvdXBVSUFjdGlvbnMoKTsKCiAgICAgICAgfSwKCiAgICAgICAgX2Rpc2FibGVUaWxlVUlBY3Rpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm9UaWxlVUlBY3Rpb25zKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9UaWxlVUlBY3Rpb25zLmRpc2FibGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9kaXNhYmxlTGlua1VJQWN0aW9uczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAodGhpcy5vTGlua1VJQWN0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5vTGlua1VJQWN0aW9ucy5kaXNhYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfZGlzYWJsZUdyb3VwVUlBY3Rpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm9Hcm91cFVJQWN0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5vR3JvdXBVSUFjdGlvbnMuZGlzYWJsZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIC8vICoqKioqKioqKioqKioqKioqKioqKioqKioqKiBUaWxlIFVJQWN0aW9ucyBmdW5jdGlvbnMgLSBCZWdpbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioKCiAgICAgICAgX2hhbmRsZVRpbGVEcmFnTW92ZTogZnVuY3Rpb24gKGNmZykgewogICAgICAgICAgICBpZiAoIWNmZy5pc1Njcm9sbGluZykgewogICAgICAgICAgICAgICAgTGF5b3V0LmdldExheW91dEVuZ2luZSgpLm1vdmVEcmFnZ2FibGUoY2ZnLm1vdmVYLCBjZmcubW92ZVksIHRoaXMuYVRhYkJhckl0ZW1zTG9jYXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2hhbmRsZVRpbGVEcmFnQW5kU2Nyb2xsQ29udGludWF0aW9uOiBmdW5jdGlvbiAobW92ZVkpIHsKICAgICAgICAgICAgdmFyIG9BbmNob3JCYXJPZmZzZXQgPSBqUXVlcnkoIiNhbmNob3JOYXZpZ2F0aW9uQmFyIikub2Zmc2V0KCksCiAgICAgICAgICAgICAgICBpQW5jaG9yQmFyT2Zmc2V0VG9wID0gb0FuY2hvckJhck9mZnNldC50b3A7CgogICAgICAgICAgICBpZiAobW92ZVkgPCBpQW5jaG9yQmFyT2Zmc2V0VG9wKSB7CiAgICAgICAgICAgICAgICBMYXlvdXQuZ2V0TGF5b3V0RW5naW5lKCkuX2NhbmNlbExvbmdEcm9wVGltbWVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIExheW91dC5nZXRMYXlvdXRFbmdpbmUoKS5faXNUYWJCYXJDb2xsaXNpb24obW92ZVkpOwogICAgICAgIH0sCgogICAgICAgIF9maWxsVGFiQmFySXRlbXNBcnJheTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYUl0ZW1zID0galF1ZXJ5KCIuc2FwVXNoZWxsQW5jaG9ySXRlbSIpLAogICAgICAgICAgICAgICAgaUxlbmd0aCA9IGFJdGVtcy5sZW5ndGgsCiAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgIGlCYXNpY1dpZHRoVW5pdCA9IDEwLAogICAgICAgICAgICAgICAgaVRlbXBJbmRleCA9IDAsCiAgICAgICAgICAgICAgICBpVGVtcEluZGV4XywKICAgICAgICAgICAgICAgIGFUYWJCYXJJdGVtc0Jhc2ljID0gW10sCiAgICAgICAgICAgICAgICBvSXRlbSwKICAgICAgICAgICAgICAgIG9JdGVtTWVhc3VyZXMsCiAgICAgICAgICAgICAgICBvSXRlbVdpZHRoLAogICAgICAgICAgICAgICAgaU51bU9mQmFzaWNVbml0czsKCiAgICAgICAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGlMZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgIG9JdGVtID0gYUl0ZW1zW2luZGV4XTsKICAgICAgICAgICAgICAgIG9JdGVtTWVhc3VyZXMgPSBvSXRlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCiAgICAgICAgICAgICAgICBhVGFiQmFySXRlbXNCYXNpY1tpbmRleF0gPSBvSXRlbU1lYXN1cmVzLndpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGlMZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgIG9JdGVtV2lkdGggPSBhVGFiQmFySXRlbXNCYXNpY1tpbmRleF07CiAgICAgICAgICAgICAgICBpZiAob0l0ZW1XaWR0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaU51bU9mQmFzaWNVbml0cyA9IE1hdGgucm91bmQob0l0ZW1XaWR0aCAvIGlCYXNpY1dpZHRoVW5pdCk7CiAgICAgICAgICAgICAgICBmb3IgKGlUZW1wSW5kZXhfID0gaVRlbXBJbmRleDsgaVRlbXBJbmRleF8gPCBpVGVtcEluZGV4ICsgaU51bU9mQmFzaWNVbml0czsgaVRlbXBJbmRleF8rKykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYVRhYkJhckl0ZW1zTG9jYXRpb25baVRlbXBJbmRleF9dID0gaW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpVGVtcEluZGV4ID0gaVRlbXBJbmRleF87CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfaGFuZGxlVGlsZVVJU3RhcnQ6IGZ1bmN0aW9uIChldnQsIHVpKSB7CiAgICAgICAgICAgIGlmICgoRGV2aWNlLmJyb3dzZXIubXNpZSkgJiYKICAgICAgICAgICAgICAgICgobmF2aWdhdG9yLm1zTWF4VG91Y2hQb2ludHMgPiAwKSB8fCAobmF2aWdhdG9yLm1heFRvdWNoUG9pbnRzID4gMCkpKSB7CiAgICAgICAgICAgICAgICAvL1JlbW92ZSB0aXRsZSBzbyB0b29sdGlwIHdpbGwgbm90IGJlIGRpc3BsYXllZCB3aGlsZSBkcmFnZ2luZyB0aWxlIChJRTEwIGFuZCBhYm92ZSkKICAgICAgICAgICAgICAgIHRoaXMudGl0bGVFbGVtZW50ID0gdWkucXVlcnlTZWxlY3RvcigiW3RpdGxlXSIpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGl0bGVFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgLy9pdCBzb2x2ZXMgaXNzdWUgd2l0aCBJRSBhbmQgYW5kcm9pZCwgd2hlbiBicm93c2VycyBhdXRvbWF0aWNhbGx5IHNob3cgdG9vbHRpcAogICAgICAgICAgICAgICAgICAgIHRoaXMudGl0bGVFbGVtZW50LnNldEF0dHJpYnV0ZSgiZGF0YS10aXRsZSIsIHRoaXMudGl0bGVFbGVtZW50LmdldEF0dHJpYnV0ZSgidGl0bGUiKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50aXRsZUVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJ0aXRsZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NoYW5nZVRpbGVEcmFnQW5kRHJvcEFuaW1hdGU6IGZ1bmN0aW9uIChldnQsIHVpKSB7CiAgICAgICAgICAgIHZhciBkYXNoYm9hcmRQYWdlU2Nyb2xsVG9wID0gdGhpcy5kcmFnTkRyb3BEYXRhLmpxRGFzaGJvYXJkLnNjcm9sbFRvcCgpLAogICAgICAgICAgICAgICAganFUaWxlLAogICAgICAgICAgICAgICAgdGlsZSwKICAgICAgICAgICAgICAgIGN1cnJlbnRUaWxlUG9zaXRpb24sCiAgICAgICAgICAgICAgICBjdXJyZW50VGlsZU9mZnNldCwKICAgICAgICAgICAgICAgIHRpbGVMZWZ0T2Zmc2V0LAogICAgICAgICAgICAgICAgaVRpbGVUb3BPZmZzZXQsCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgb0Nsb25lZFRpbGU7CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5kcmFnTkRyb3BEYXRhLmpxRHJhZ2dhYmxlRWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGpxVGlsZSA9IHRoaXMuZHJhZ05Ecm9wRGF0YS5qcURyYWdnYWJsZUVsZW1lbnRzLmVxKGkpOwogICAgICAgICAgICAgICAgdGlsZSA9IGpxVGlsZVswXTsKICAgICAgICAgICAgICAgIC8vR2V0IHRoZSBvcmlnaW5hbCB0aWxlIGFuZCBpdHMgY2xvbmUKICAgICAgICAgICAgICAgIGN1cnJlbnRUaWxlUG9zaXRpb24gPSBqcVRpbGUucG9zaXRpb24oKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRUaWxlT2Zmc2V0ID0ganFUaWxlLm9mZnNldCgpOwogICAgICAgICAgICAgICAgaWYgKChjdXJyZW50VGlsZU9mZnNldC5sZWZ0ID09PSB0aWxlLm9mZnNldC5sZWZ0KSAmJiAoY3VycmVudFRpbGVPZmZzZXQudG9wID09PSB0aWxlLm9mZnNldC50b3ApKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aWxlLnBvc2l0aW9uID0gY3VycmVudFRpbGVQb3NpdGlvbjsKICAgICAgICAgICAgICAgIHRpbGUub2Zmc2V0ID0gY3VycmVudFRpbGVPZmZzZXQ7CiAgICAgICAgICAgICAgICBvQ2xvbmVkVGlsZSA9IGpxVGlsZS5kYXRhKCJjbG9uZSIpOwogICAgICAgICAgICAgICAgaWYgKCFvQ2xvbmVkVGlsZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vR2V0IHRoZSBpbnZpc2libGUgdGlsZSB0aGF0IGhhcyBzbmFwcGVkIHRvIHRoZSBuZXcKICAgICAgICAgICAgICAgIC8vbG9jYXRpb24sIGdldCBpdHMgcG9zaXRpb24sIGFuZCBhbmltYXRlIHRoZSB2aXNpYmxlCiAgICAgICAgICAgICAgICAvL2Nsb25lIHRvIGl0CiAgICAgICAgICAgICAgICB0aWxlTGVmdE9mZnNldCA9IHRpbGUucG9zaXRpb24ubGVmdCArIHRoaXMuZHJhZ05Ecm9wRGF0YS5jb250YWluZXJMZWZ0TWFyZ2luOwogICAgICAgICAgICAgICAgaVRpbGVUb3BPZmZzZXQgPSB0aGlzLl9nZXRUaWxlVG9wT2Zmc2V0KGpxVGlsZSwgdGlsZS5wb3NpdGlvbiwgZGFzaGJvYXJkUGFnZVNjcm9sbFRvcCk7CgogICAgICAgICAgICAgICAgLy9TdG9wIGN1cnJlbnRseSBydW5uaW5nIGFuaW1hdGlvbnMKICAgICAgICAgICAgICAgIC8vV2l0aG91dCB0aGlzLCBhbmltYXRpb25zIHdvdWxkIHF1ZXVlIHVwCiAgICAgICAgICAgICAgICBvQ2xvbmVkVGlsZS5zdG9wKHRydWUsIGZhbHNlKS5hbmltYXRlKHsgbGVmdDogdGlsZUxlZnRPZmZzZXQsIHRvcDogaVRpbGVUb3BPZmZzZXQgfSwgeyBkdXJhdGlvbjogMjUwIH0sIHsgZWFzaW5nOiAic3dpbmciIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX3ByZXZlbnRUZXh0U2VsZWN0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vUHJldmVudCBzZWxlY3Rpb24gb2YgdGV4dCBvbiB0aWxlcyBhbmQgZ3JvdXBzCiAgICAgICAgICAgIGlmICh3aW5kb3cuZ2V0U2VsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luZG93LmdldFNlbGVjdGlvbigpOwogICAgICAgICAgICAgICAgLy8gZml4IElFOSBpc3N1ZSAoQ1NTIDE1ODAxODEzOTEpCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBjb250aW51ZSByZWdhcmRsZXNzIG9mIGVycm9yCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB1aSA6IHRpbGUgRE9NIHJlZmVyZW5jZQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgX2hhbmRsZVN0YXJ0RHJhZ1RpbGU6IGZ1bmN0aW9uIChldnQsIHRpbGVFbGVtZW50KSB7CiAgICAgICAgICAgIHRoaXMuX3ByZXZlbnRUZXh0U2VsZWN0aW9uKCk7CgogICAgICAgICAgICBMYXlvdXQuZ2V0TGF5b3V0RW5naW5lKCkubGF5b3V0U3RhcnRDYWxsYmFjayh0aWxlRWxlbWVudCk7CiAgICAgICAgICAgIC8vUHJldmVudCB0aGUgdGlsZSB0byBiZSBsYXVuY2hlZCBhZnRlciBkcm9wCiAgICAgICAgICAgIGpRdWVyeSh0aWxlRWxlbWVudCkuZmluZCgiYSIpLnJlbW92ZUF0dHIoImhyZWYiKTsKICAgICAgICAgICAgdGhpcy5vQ29udHJvbGxlci5faGFuZGxlRHJhZy5jYWxsKHRoaXMub0NvbnRyb2xsZXIsIGV2dCwgdGlsZUVsZW1lbnQpOwogICAgICAgICAgICBzYXAudWkuZ2V0Q29yZSgpLmdldEV2ZW50QnVzKCkucHVibGlzaCgibGF1bmNocGFkIiwgInNvcnRhYmxlU3RhcnQiKTsKICAgICAgICB9LAoKICAgICAgICBfb25CZWZvcmVDcmVhdGVMaW5rQ2xvbmU6IGZ1bmN0aW9uIChldnQsIExpbmtFbGVtZW50KSB7CiAgICAgICAgICAgIC8vd2UgbmVlZCB0byBzYXZlIHRoZSBsaW5rIGJvdW5kaW5nIHJlY3RzIGJlZm9yZSB1aWFjdGlvbnMuanMgY3JlYXRlIGEgY2xvbmUgYmVjYXVzZSBhZnRlciBpdCBvTGluay5nZXRCb3VuZGluZ1JlY3RzIHdpbGwgcmV0dXJuIHplcm8gb2Zmc2V0cwogICAgICAgICAgICBMYXlvdXQuZ2V0TGF5b3V0RW5naW5lKCkuc2F2ZUxpbmtCb3VuZGluZ1JlY3RzKExpbmtFbGVtZW50KTsKICAgICAgICB9LAoKICAgICAgICBfaGFuZGxlTGlua0Ryb3A6IGZ1bmN0aW9uIChldnQsIHRpbGVFbGVtZW50LCBvQWRkaXRpb25hbFBhcmFtcykgewogICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKSwKICAgICAgICAgICAgICAgIG9Qcm9taXNlOwoKICAgICAgICAgICAgaWYgKExheW91dC5pc1RhYkJhckFjdGl2ZSgpKSB7CiAgICAgICAgICAgICAgICBMYXlvdXQudGFiQmFyVGlsZURyb3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKERldmljZS5icm93c2VyLm1zaWUpICYmCiAgICAgICAgICAgICAgICAoKG5hdmlnYXRvci5tc01heFRvdWNoUG9pbnRzID4gMCkgfHwgKG5hdmlnYXRvci5tYXhUb3VjaFBvaW50cyA+IDApKSAmJiB0aGlzLnRpdGxlRWxlbWVudCkgewogICAgICAgICAgICAgICAgLy9pdCBzb2x2ZXMgaXNzdWUgd2l0aCBJRSBhbmQgYW5kcm9pZCwgd2hlbiBicm93c2VycyBhdXRvbWF0aWNhbGx5IHNob3cgdG9vbHRpcAogICAgICAgICAgICAgICAgdGhpcy50aXRsZUVsZW1lbnQuc2V0QXR0cmlidXRlKCJ0aXRsZSIsIHRoaXMudGl0bGVFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS10aXRsZSIpKTsvL2NoZWNrIGlmIHdlIG5lZWQgdGhpcwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChEZXZpY2UuZGVza3RvcCkgewogICAgICAgICAgICAgICAgalF1ZXJ5KCJib2R5IikucmVtb3ZlQ2xhc3MoInNhcFVzaGVsbERpc2FibGVVc2VyU2VsZWN0Iik7Ly9jaGVjayBpZiB3ZSBuZWVkIHRoaXMKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoTGF5b3V0LmdldExheW91dEVuZ2luZSgpLmlzTGlua0ludGVyc2VjdGVkKCkgfHwgTGF5b3V0LmdldExheW91dEVuZ2luZSgpLmlzT3JpZ2luYWxBcmVhQ2hhbmdlZCgpKSB7CiAgICAgICAgICAgICAgICBvUHJvbWlzZSA9IHRoaXMub0NvbnRyb2xsZXIuX2hhbmRsZURyb3AuY2FsbCh0aGlzLm9Db250cm9sbGVyLCBldnQsIHRpbGVFbGVtZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9Qcm9taXNlKSB7CiAgICAgICAgICAgICAgICBvUHJvbWlzZS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBqUXVlcnkoIiNkYXNoYm9hcmRHcm91cHMgLnNhcFVzaGVsbEhpZGVQbHVzVGlsZSIpLnJlbW92ZUNsYXNzKCJzYXBVc2hlbGxIaWRlUGx1c1RpbGUiKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgICAgIH0sIDMwMCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTsKICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHVpIDogdGlsZSBET00gcmVmZXJlbmNlCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICBfaGFuZGxlVGlsZURyb3A6IGZ1bmN0aW9uIChldnQsIHRpbGVFbGVtZW50LCBvQWRkaXRpb25hbFBhcmFtcykgewogICAgICAgICAgICBpZiAoTGF5b3V0LmdldExheW91dEVuZ2luZSgpLmlzT3JpZ2luYWxBcmVhQ2hhbmdlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlVGlsZVRvTGlua0Ryb3AoZXZ0LCB0aWxlRWxlbWVudCwgb0FkZGl0aW9uYWxQYXJhbXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVUaWxlVG9UaWxlRHJvcChldnQsIHRpbGVFbGVtZW50LCBvQWRkaXRpb25hbFBhcmFtcyk7CiAgICAgICAgfSwKCiAgICAgICAgX2hhbmRsZVRpbGVUb0xpbmtEcm9wOiBmdW5jdGlvbiAoZXZ0LCB0aWxlRWxlbWVudCwgb0FkZGl0aW9uYWxQYXJhbXMpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUxpbmtEcm9wKGV2dCwgdGlsZUVsZW1lbnQsIG9BZGRpdGlvbmFsUGFyYW1zKTsKICAgICAgICB9LAoKICAgICAgICBfaGFuZGxlVGlsZVRvVGlsZURyb3A6IGZ1bmN0aW9uIChldnQsIHRpbGVFbGVtZW50LCBvQWRkaXRpb25hbFBhcmFtcykgewogICAgICAgICAgICB2YXIganFDbG9uZSwKICAgICAgICAgICAgICAgIG9Ib3ZlcmVkVGFiQmFySXRlbSwKICAgICAgICAgICAgICAgIG9UYWJCYXJEcmFnZ2VkVGlsZSwKICAgICAgICAgICAgICAgIGhhbmRsZVRpbGVEcm9wSW50ZXJuYWwgPSBmdW5jdGlvbiAoZXZ0LCB0aWxlRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIGpRdWVyeSgiI2Rhc2hib2FyZEdyb3VwcyAuc2FwVXNoZWxsSGlkZVBsdXNUaWxlIikucmVtb3ZlQ2xhc3MoInNhcFVzaGVsbEhpZGVQbHVzVGlsZSIpOwogICAgICAgICAgICAgICAgICAgIGlmICgoRGV2aWNlLmJyb3dzZXIubXNpZSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKChuYXZpZ2F0b3IubXNNYXhUb3VjaFBvaW50cyA+IDApIHx8IChuYXZpZ2F0b3IubWF4VG91Y2hQb2ludHMgPiAwKSkgJiYgdGhpcy50aXRsZUVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9pdCBzb2x2ZXMgaXNzdWUgd2l0aCBJRSBhbmQgYW5kcm9pZCwgd2hlbiBicm93c2VycyBhdXRvbWF0aWNhbGx5IHNob3cgdG9vbHRpcAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRpdGxlRWxlbWVudC5zZXRBdHRyaWJ1dGUoInRpdGxlIiwgdGhpcy50aXRsZUVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXRpdGxlIikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLm9Db250cm9sbGVyLl9oYW5kbGVEcm9wLmNhbGwodGhpcy5vQ29udHJvbGxlciwgZXZ0LCB0aWxlRWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKERldmljZS5kZXNrdG9wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeSgiYm9keSIpLnJlbW92ZUNsYXNzKCJzYXBVc2hlbGxEaXNhYmxlVXNlclNlbGVjdCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICBvSG92ZXJlZFRhYkJhckl0ZW0gPSBqUXVlcnkoIi5zYXBVc2hlbGxUYWJCYXJIb3Zlck9uIik7CiAgICAgICAgICAgIG9Ib3ZlcmVkVGFiQmFySXRlbS5yZW1vdmVDbGFzcygic2FwVXNoZWxsVGFiQmFySG92ZXJPbiIpOwoKICAgICAgICAgICAgb1RhYkJhckRyYWdnZWRUaWxlID0galF1ZXJ5KCIuc2FwVXNoZWxsVGlsZURyYWdPcGFjaXR5Iik7CiAgICAgICAgICAgIG9UYWJCYXJEcmFnZ2VkVGlsZS5yZW1vdmVDbGFzcygic2FwVXNoZWxsVGlsZURyYWdPcGFjaXR5Iik7CgogICAgICAgICAgICBpZiAoTGF5b3V0LmlzVGFiQmFyQWN0aXZlKCkpIHsKICAgICAgICAgICAgICAgIExheW91dC50YWJCYXJUaWxlRHJvcHBlZCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJbiB0YWIgYmFyIG1vZGUsIHdoZW4gdGhlIHRpbGUgaXMgZHJvcHBlZCBvbiBhbiBhbmNob3IgdGFiIGJhciBpdGVtLgogICAgICAgICAgICAvLyBJbiB0aGlzIGNhc2UgdGhlIHRpbGUgc2hvdWxkIG5vdCBmbG93IGJhY2sgdG8gdGhlIHNvdXJjZSBncm91cAogICAgICAgICAgICBpZiAoTGF5b3V0LmlzVGFiQmFyQWN0aXZlKCkgJiYgTGF5b3V0LmlzT25UYWJCYXJFbGVtZW50KCkpIHsKICAgICAgICAgICAgICAgIGlmIChvQWRkaXRpb25hbFBhcmFtcyAmJiBvQWRkaXRpb25hbFBhcmFtcy5jbG9uZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBvRGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKTsKICAgICAgICAgICAgICAgICAgICBqcUNsb25lID0galF1ZXJ5KG9BZGRpdGlvbmFsUGFyYW1zLmNsb25lKTsKICAgICAgICAgICAgICAgICAgICBqcUNsb25lLmNzcygiZGlzcGxheSIsICJub25lIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9EZWZlcnJlZC5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZVRpbGVEcm9wSW50ZXJuYWwuY2FsbCh0aGlzLCBldnQsIHRpbGVFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICB9LmJpbmQodGhpcyksIDMwMCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9EZWZlcnJlZC5wcm9taXNlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBoYW5kbGVUaWxlRHJvcEludGVybmFsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGhhbmRsZVRpbGVEcm9wSW50ZXJuYWwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9LAoKICAgICAgICBfZ2V0VGlsZVRvcE9mZnNldDogZnVuY3Rpb24gKG9UaWxlLCBwb3NpdGlvbiwgZGFzaGJvYXJkU2Nyb2xsVG9wKSB7CiAgICAgICAgICAgIHZhciBpID0gMCwKICAgICAgICAgICAgICAgIGlUaWxlVG9wT2Zmc2V0ID0gaSArIGRhc2hib2FyZFNjcm9sbFRvcDsKCiAgICAgICAgICAgIGlUaWxlVG9wT2Zmc2V0ICs9IG9UaWxlLmNsb3Nlc3QoIi5zYXBVc2hlbGxEYXNoYm9hcmRHcm91cHNDb250YWluZXJJdGVtIikucG9zaXRpb24oKS50b3A7CiAgICAgICAgICAgIGlUaWxlVG9wT2Zmc2V0ICs9IHBvc2l0aW9uLnRvcDsKICAgICAgICAgICAgcmV0dXJuIGlUaWxlVG9wT2Zmc2V0OwogICAgICAgIH0sCgogICAgICAgIC8vRHVyaW5nIGRyYWcgYWN0aW9uLCBsb2NrZWQgZ3JvdXBzIHNob3VsZCBiZSBtYXJrIHdpdGggYSBsb2NrZWQgaWNvbiBhbmQgZ3JvdXAgb3BhY2l0eSBzaG91bGQgYmUgY2hhbmdlZCB0byBncmF5aXNoCiAgICAgICAgX21hcmtEaXNhYmxlR3JvdXBzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm9Db250cm9sbGVyLmdldFZpZXcoKS5nZXRNb2RlbCgpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9Db250cm9sbGVyLmdldFZpZXcoKS5nZXRNb2RlbCgpLnNldFByb3BlcnR5KCIvaXNJbkRyYWciLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vb25jZSBkJmQgZW5kcywgcmVzdG9yZSBsb2NrZWQgZ3JvdXBzIGFwcGVhcmFuY2UgYW5kIHJlbW92ZSBsb2NrZWQgaWNvbnMgYW5kIGdyYXlzY2FsZQogICAgICAgIF9lbmRVSUhhbmRsZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMub0NvbnRyb2xsZXIuZ2V0VmlldygpLmdldE1vZGVsKCkpIHsKICAgICAgICAgICAgICAgIHRoaXMub0NvbnRyb2xsZXIuZ2V0VmlldygpLmdldE1vZGVsKCkuc2V0UHJvcGVydHkoIi9pc0luRHJhZyIsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vICoqKioqKioqKioqKioqKioqKioqKioqKioqKiogVGlsZSBVSUFjdGlvbnMgZnVuY3Rpb25zIC0gRW5kICoqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICAvLyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgLy8gKioqKioqKioqKioqKioqKioqKioqKioqKioqIEdyb3VwIFVJQWN0aW9ucyBmdW5jdGlvbnMgLSBCZWdpbiAqKioqKioqKioqKioqKioqKioqKioqKioqKgoKICAgICAgICBfaGFuZGxlR3JvdXBTdGFydERyYWc6IGZ1bmN0aW9uIChldnQsIHVpKSB7CiAgICAgICAgICAgIHRoaXMub1RpbGVVSUFjdGlvbnMuZGlzYWJsZSgpOwogICAgICAgICAgICBpZiAodGhpcy5vTGlua1VJQWN0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5vTGlua1VJQWN0aW9ucy5kaXNhYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGdyb3VwQ29udGFpbmVyQ2xvbmUgPSBqUXVlcnkoIi5zYXBVc2hlbGxEYXNoYm9hcmRHcm91cHNDb250YWluZXJJdGVtLWNsb25lIiksCiAgICAgICAgICAgICAgICBncm91cENvbnRhaW5lckNsb25lVGl0bGUgPSBncm91cENvbnRhaW5lckNsb25lLmZpbmQoIi5zYXBVc2hlbGxDb250YWluZXJUaXRsZSIpLAogICAgICAgICAgICAgICAgdGl0bGVIZWlnaHQgPSBncm91cENvbnRhaW5lckNsb25lVGl0bGUuaGVpZ2h0KCksCiAgICAgICAgICAgICAgICB0aXRsZVdpZHRoID0gZ3JvdXBDb250YWluZXJDbG9uZVRpdGxlLndpZHRoKCksCiAgICAgICAgICAgICAgICBncm91cHNUb3AsCiAgICAgICAgICAgICAgICBncm91cFBsYWNlaG9sZGVyLAogICAgICAgICAgICAgICAgZ3JvdXBDbG9uZSwKICAgICAgICAgICAgICAgIHNjcm9sbFksCiAgICAgICAgICAgICAgICBiUmlnaHRUb0xlZnQgPSBzYXAudWkuZ2V0Q29yZSgpLmdldENvbmZpZ3VyYXRpb24oKS5nZXRSVEwoKTsKCiAgICAgICAgICAgIGlmICghRGV2aWNlLnN5c3RlbS5waG9uZSkgewogICAgICAgICAgICAgICAgZ3JvdXBDb250YWluZXJDbG9uZS5maW5kKCIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lckVkaXRNb2RlIikub2Zmc2V0KHsKICAgICAgICAgICAgICAgICAgICB0b3A6IHRoaXMub0dyb3VwVUlBY3Rpb25zLmdldE1vdmUoKS55IC0gdGl0bGVIZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgbGVmdDogYlJpZ2h0VG9MZWZ0ID8galF1ZXJ5KCIjc2FwVXNoZWxsRGFzaGJvYXJkUGFnZSIpLndpZHRoKCkgKyB0aGlzLm9Hcm91cFVJQWN0aW9ucy5nZXRNb3ZlKCkueCArIHRpdGxlV2lkdGggOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9Hcm91cFVJQWN0aW9ucy5nZXRNb3ZlKCkueCAtICh0aXRsZVdpZHRoIC8gMikKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgalF1ZXJ5KCIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lckJlZm9yZUNvbnRlbnQiKS5hZGRDbGFzcygic2FwVXNoZWxsVGlsZUNvbnRhaW5lckhpZGRlbiIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgalF1ZXJ5KCIuc2FwVXNoZWxsVGlsZXNDb250YWluZXItc29ydGFibGUiKS5hZGRDbGFzcygic2FwVXNoZWxsVGlsZUNvbnRhaW5lclJlbW92ZUNvbnRlbnQiKTsKICAgICAgICAgICAgICAgIGpRdWVyeSgiLnNhcFVzaGVsbExpbmVNb2RlQ29udGFpbmVyLCAuc2FwVXNoZWxsTGlua3NDb250YWluZXIiKS5hZGRDbGFzcygic2FwVXNoZWxsVGlsZUNvbnRhaW5lclJlbW92ZUNvbnRlbnQiKTsKICAgICAgICAgICAgICAgIGpRdWVyeSgiLnNhcFVzaGVsbFRpbGVDb250YWluZXJCZWZvcmVDb250ZW50IikuYWRkQ2xhc3MoInNhcFVzaGVsbFRpbGVDb250YWluZXJSZW1vdmVDb250ZW50Iik7CiAgICAgICAgICAgICAgICBqUXVlcnkoIi5zYXBVc2hlbGxDb250YWluZXJIZWFkZXJBY3Rpb25zIikuYWRkQ2xhc3MoInNhcFVzaGVsbFRpbGVDb250YWluZXJIaWRkZW4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBqUXVlcnkoIi5zYXBVc2hlbGxUaWxlQ29udGFpbmVyQWZ0ZXJDb250ZW50IikuYWRkQ2xhc3MoInNhcFVzaGVsbFRpbGVDb250YWluZXJSZW1vdmVDb250ZW50Iik7CiAgICAgICAgICAgIGpRdWVyeSh1aSkuZmluZCgiLnNhcFVzaGVsbENvbnRhaW5lckhlYWRlckFjdGlvbnMiKS5hZGRDbGFzcygic2FwVXNoZWxsVGlsZUNvbnRhaW5lckhpZGRlbiIpOwoKICAgICAgICAgICAgdGhpcy5vQ29udHJvbGxlci5nZXRWaWV3KCkuZ2V0TW9kZWwoKS5zZXRQcm9wZXJ0eSgiL2lzSW5EcmFnIiwgdHJ1ZSk7CiAgICAgICAgICAgIGpRdWVyeSh1aSkuYXR0cigic3RhcnRQb3MiLCBqUXVlcnkodWkpLmluZGV4KCkpOwoKICAgICAgICAgICAgTG9nLmluZm8oInN0YXJ0UG9zIC0gIiArIGpRdWVyeSh1aSkuaW5kZXgoKSk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLnB1Ymxpc2goImxhdW5jaHBhZCIsICJzb3J0YWJsZVN0YXJ0Iik7CiAgICAgICAgICAgIH0sIDApOwoKICAgICAgICAgICAgLy9zY3JvbGwgdG8gZ3JvdXAKICAgICAgICAgICAgZ3JvdXBzVG9wID0galF1ZXJ5KCIjZGFzaGJvYXJkR3JvdXBzIikub2Zmc2V0KCkudG9wOwogICAgICAgICAgICBncm91cFBsYWNlaG9sZGVyID0galF1ZXJ5KCIuc2FwVXNoZWxsRGFzaGJvYXJkR3JvdXBzQ29udGFpbmVySXRlbS1wbGFjZWhvbGRlciIpLm9mZnNldCgpLnRvcDsKICAgICAgICAgICAgZ3JvdXBDbG9uZSA9IGpRdWVyeSgiLnNhcFVzaGVsbERhc2hib2FyZEdyb3Vwc0NvbnRhaW5lckl0ZW0tY2xvbmUiKS5vZmZzZXQoKS50b3A7CiAgICAgICAgICAgIHNjcm9sbFkgPSBncm91cFBsYWNlaG9sZGVyIC0gZ3JvdXBzVG9wIC0gZ3JvdXBDbG9uZTsKICAgICAgICAgICAgalF1ZXJ5KCIuc2FwVXNoZWxsRGFzaGJvYXJkVmlldyBzZWN0aW9uIikuYW5pbWF0ZSh7IHNjcm9sbFRvcDogc2Nyb2xsWSB9LCAwKTsKICAgICAgICB9LAoKICAgICAgICBfaGFuZGxlR3JvdXBzVUlTdGFydDogZnVuY3Rpb24gKGV2dCwgdWkpIHsKICAgICAgICAgICAgalF1ZXJ5KHVpKS5maW5kKCIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lckNvbnRlbnQiKS5jc3MoIm91dGxpbmUtY29sb3IiLCAidHJhbnNwYXJlbnQiKTsKICAgICAgICB9LAoKICAgICAgICBfaGFuZGxlR3JvdXBEcm9wOiBmdW5jdGlvbiAoZXZ0LCB1aSkgewogICAgICAgICAgICB2YXIgb0J1cyA9IHNhcC51aS5nZXRDb3JlKCkuZ2V0RXZlbnRCdXMoKSwKICAgICAgICAgICAgICAgIGpRdWVyeU9iaiA9IGpRdWVyeSh1aSksCiAgICAgICAgICAgICAgICBmaXJzdENoaWxkSWQgPSBqUXVlcnkoalF1ZXJ5T2JqLmNoaWxkcmVuKClbMF0pLmF0dHIoImlkIiksCiAgICAgICAgICAgICAgICBvR3JvdXAgPSBzYXAudWkuZ2V0Q29yZSgpLmJ5SWQoZmlyc3RDaGlsZElkKSwKICAgICAgICAgICAgICAgIG9EYXNoYm9hcmRHcm91cHMgPSBzYXAudWkuZ2V0Q29yZSgpLmJ5SWQoImRhc2hib2FyZEdyb3VwcyIpLAogICAgICAgICAgICAgICAgb0RhdGEgPSB7IGdyb3VwOiBvR3JvdXAsIGdyb3VwQ2hhbmdlZDogZmFsc2UsIGZvY3VzOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgbk5ld0luZGV4ID0galF1ZXJ5T2JqLmluZGV4KCk7CgogICAgICAgICAgICBqUXVlcnlPYmouc3RhcnRQb3MgPSB3aW5kb3cucGFyc2VJbnQoalF1ZXJ5T2JqLmF0dHIoInN0YXJ0UG9zIiksIDEwKTsKICAgICAgICAgICAgb0Rhc2hib2FyZEdyb3Vwcy5yZW1vdmVBZ2dyZWdhdGlvbigiZ3JvdXBzIiwgb0dyb3VwLCB0cnVlKTsKICAgICAgICAgICAgb0Rhc2hib2FyZEdyb3Vwcy5pbnNlcnRBZ2dyZWdhdGlvbigiZ3JvdXBzIiwgb0dyb3VwLCBuTmV3SW5kZXgsIHRydWUpOwoKICAgICAgICAgICAgdGhpcy5faGFuZGxlR3JvdXBNb3ZlZChldnQsIHsgaXRlbTogalF1ZXJ5T2JqIH0pOwogICAgICAgICAgICBqUXVlcnlPYmoucmVtb3ZlQXR0cigic3RhcnRQb3MiKTsKICAgICAgICAgICAgc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLnB1Ymxpc2goImxhdW5jaHBhZCIsICJzb3J0YWJsZVN0b3AiKTsKCiAgICAgICAgICAgIC8vIGF2b2lkIHRpbGUgdG8gYmUgY2xpY2tlZCBhZnRlciBncm91cCB3YXMgZHJvcHBlZAogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGpRdWVyeSgiLnNhcFVzaGVsbENvbnRhaW5lckhlYWRlckFjdGlvbnMiKS5yZW1vdmVDbGFzcygic2FwVXNoZWxsVGlsZUNvbnRhaW5lckhpZGRlbiIpOwogICAgICAgICAgICAgICAgalF1ZXJ5KCIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lckJlZm9yZUNvbnRlbnQiKS5yZW1vdmVDbGFzcygic2FwVXNoZWxsVGlsZUNvbnRhaW5lckhpZGRlbiIpOwogICAgICAgICAgICAgICAgalF1ZXJ5KCIuc2FwVXNoZWxsVGlsZUNvbnRhaW5lckJlZm9yZUNvbnRlbnQiKS5yZW1vdmVDbGFzcygic2FwVXNoZWxsVGlsZUNvbnRhaW5lclJlbW92ZUNvbnRlbnQiKTsKICAgICAgICAgICAgICAgIGpRdWVyeSgiLnNhcFVzaGVsbFRpbGVDb250YWluZXJBZnRlckNvbnRlbnQiKS5yZW1vdmVDbGFzcygic2FwVXNoZWxsVGlsZUNvbnRhaW5lclJlbW92ZUNvbnRlbnQiKTsKICAgICAgICAgICAgICAgIGpRdWVyeSgiLnNhcFVzaGVsbFRpbGVzQ29udGFpbmVyLXNvcnRhYmxlIikucmVtb3ZlQ2xhc3MoInNhcFVzaGVsbFRpbGVDb250YWluZXJSZW1vdmVDb250ZW50Iik7CiAgICAgICAgICAgICAgICBqUXVlcnkoIi5zYXBVc2hlbGxMaW5lTW9kZUNvbnRhaW5lciwgLnNhcFVzaGVsbExpbmtzQ29udGFpbmVyIikucmVtb3ZlQ2xhc3MoInNhcFVzaGVsbFRpbGVDb250YWluZXJSZW1vdmVDb250ZW50Iik7CiAgICAgICAgICAgIH0sIDApOwoKICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoalF1ZXJ5LnByb3h5KG9CdXMucHVibGlzaCwgb0J1cywgImxhdW5jaHBhZCIsICJzY3JvbGxUb0dyb3VwIiwgb0RhdGEpLCAxKTsKICAgICAgICAgICAgdGhpcy5vVGlsZVVJQWN0aW9ucy5lbmFibGUoKTsKICAgICAgICAgICAgaWYgKHRoaXMub0xpbmtVSUFjdGlvbnMpIHsKICAgICAgICAgICAgICAgIHRoaXMub0xpbmtVSUFjdGlvbnMuZW5hYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfaGFuZGxlR3JvdXBNb3ZlZDogZnVuY3Rpb24gKGV2dCwgdWkpIHsKICAgICAgICAgICAgdmFyIGZyb21JbmRleCA9IHVpLml0ZW0uc3RhcnRQb3MsCiAgICAgICAgICAgICAgICB0b0luZGV4ID0gdWkuaXRlbS5pbmRleCgpLAogICAgICAgICAgICAgICAgb01vZGVsID0gdGhpcy5vQ29udHJvbGxlci5nZXRWaWV3KCkuZ2V0TW9kZWwoKTsKCiAgICAgICAgICAgIGlmICh0b0luZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgdGhpcy5vQ29udHJvbGxlci5fcHVibGlzaEFzeW5jKCJsYXVuY2hwYWQiLCAibW92ZUdyb3VwIiwgewogICAgICAgICAgICAgICAgICAgIGZyb21JbmRleDogZnJvbUluZGV4LAogICAgICAgICAgICAgICAgICAgIHRvSW5kZXg6IHRvSW5kZXgKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgb01vZGVsLnNldFByb3BlcnR5KCIvaXNJbkRyYWciLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gKioqKioqKioqKioqKioqKioqKioqKioqKioqKiBHcm91cCBVSUFjdGlvbnMgZnVuY3Rpb25zIC0gRW5kICoqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICAvLyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgoKICAgICAgICBfc2V0Q29udHJvbGxlcjogZnVuY3Rpb24gKG9Db250cm9sbGVyKSB7CiAgICAgICAgICAgIHRoaXMub0NvbnRyb2xsZXIgPSBvQ29udHJvbGxlcjsKICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gRGFzaGJvYXJkVUlBY3Rpb25zOwp9KTsKfSwKCSJzYXAvdXNoZWxsL2NvbXBvbmVudHMvaG9tZXBhZ2UvRkxQQW5hbHl0aWNzLmpzIjpmdW5jdGlvbigpey8vICR7Y29weXJpZ2h0fQ0KDQpzYXAudWkuZGVmaW5lKFsNCiAgICAic2FwL3VzaGVsbC9zZXJ2aWNlcy9BcHBDb25maWd1cmF0aW9uIiwgLy8gVE9ETzogcGVuZGluZyBkZXBlbmRlbmN5IG1pZ3JhdGlvbg0KICAgICJzYXAvYmFzZS9Mb2ciLA0KICAgICJzYXAvdWkvdGhpcmRwYXJ0eS9qcXVlcnkiDQpdLCBmdW5jdGlvbiAoQXBwQ29uZmlndXJhdGlvbiwgTG9nLCBqUXVlcnkpIHsNCiAgICAidXNlIHN0cmljdCI7DQoNCiAgICAvKiBnbG9iYWwgaGFzaGVyICovDQoNCiAgICAvKioNCiAgICAgKiBNYW5hZ2UgVXNhZ2VBbmFseXRpY3MgZXZlbnQgbG9nZ2luZyBhcyBhIHJlc3VsdCBvZiBGTFAgdXNlciBmbG93cw0KICAgICAqLw0KDQogICAgLy8gTGF1bmNocGFkIGFjdGlvbiBldmVudHMgdGhhdCB0cmlnZ2VyIGxvZ2dpbmcNCiAgICB2YXIgYU9ic2VydmVkTGF1bmNocGFkQWN0aW9ucyA9IFsiZGVsZXRlVGlsZSIsICJhY3Rpb25Nb2RlQWN0aXZlIiwgImNhdGFsb2dUaWxlQ2xpY2siLCAiZGFzaGJvYXJkVGlsZUNsaWNrIiwgImRhc2hib2FyZFRpbGVMaW5rQ2xpY2siXSwNCiAgICAgICAgb0V2ZW50QnVzID0gc2FwLnVpLmdldENvcmUoKS5nZXRFdmVudEJ1cygpLA0KICAgICAgICB0aGF0ID0gdGhpcywNCiAgICAgICAgb0xhdW5jaGVkQXBwbGljYXRpb25zID0ge307DQoNCiAgICAvKioNCiAgICAgKiBVcGRhdGVzIG9MYXVuY2hlZEFwcGxpY2F0aW9ucyB3aXRoIHRoZSB0aXRsZSBhbmQgb3BlbmluZyB0aW1lIG9mIHRoZSBnaXZlbiBhcHBsaWNhdGlvbg0KICAgICAqLw0KICAgIGZ1bmN0aW9uIHNhdmVPcGVuQXBwaWNhdGlvbkRhdGEgKGFwcGxpY2F0aW9uSWQpIHsNCiAgICAgICAgdmFyIG9NZXRhZGF0YU9mVGFyZ2V0ID0gc2FwLnVzaGVsbC5zZXJ2aWNlcy5BcHBDb25maWd1cmF0aW9uLmdldE1ldGFkYXRhKCk7IC8vIFRPRE86IHBlbmRpbmcgZGVwZW5kZW5jeSBtaWdyYXRpb24NCiAgICAgICAgb0xhdW5jaGVkQXBwbGljYXRpb25zW2FwcGxpY2F0aW9uSWRdID0ge307DQogICAgICAgIG9MYXVuY2hlZEFwcGxpY2F0aW9uc1thcHBsaWNhdGlvbklkXS5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpOw0KICAgICAgICBvTGF1bmNoZWRBcHBsaWNhdGlvbnNbYXBwbGljYXRpb25JZF0udGl0bGUgPSBvTWV0YWRhdGFPZlRhcmdldC50aXRsZTsNCiAgICB9DQoNCiAgICAvKioNCiAgICAgKiBMb2dzIGEgIlRpbWUgaW4gQXBwIiBldmVudCBhY2NvcmRpbmcgdG8gdGhlIGdpdmVuIGFwcGxpY2F0aW9uIElEDQogICAgICoNCiAgICAgKiBDYWxjdWxhdGVzIHRoZSB0aW1lIGFjY29yZGluZyB0byB0aGUgY3VycmVudCAoY2xvc2luZykgdGltZQ0KICAgICAqICBhbmQgdGhlIG9wZW5pbmcgdGltZSB0aGF0IGlzIGtlcHQgb24gb0xhdW5jaGVkQXBwbGljYXRpb25zW2FwcGxpY2F0aW9uSWRdDQogICAgICovDQogICAgZnVuY3Rpb24gbG9nVGltZUluQXBwRXZlbnQgKGFwcGxpY2F0aW9uSWQpIHsNCiAgICAgICAgdmFyIGFwcER1cmF0aW9uID0gMDsNCg0KICAgICAgICB0cnkgew0KICAgICAgICAgICAgYXBwRHVyYXRpb24gPSAobmV3IERhdGUoKSAtIG9MYXVuY2hlZEFwcGxpY2F0aW9uc1thcHBsaWNhdGlvbklkXS5zdGFydFRpbWUpIC8gMTAwMDsNCiAgICAgICAgICAgIHNhcC51c2hlbGwuQ29udGFpbmVyLmdldFNlcnZpY2UoIlVzYWdlQW5hbHl0aWNzIikubG9nQ3VzdG9tRXZlbnQoIkZMUDogVGltZSBpbiBBcHBsaWNhdGlvbiAoc2VjKSIsIGFwcER1cmF0aW9uLCBbb0xhdW5jaGVkQXBwbGljYXRpb25zW2FwcGxpY2F0aW9uSWRdLnRpdGxlXSk7DQogICAgICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgICAgICAgIExvZy53YXJuaW5nKCJEdXJhdGlvbiBpbiBhcHBsaWNhdGlvbiAiICsgYXBwbGljYXRpb25JZCArICIgY291bGQgbm90IGJlIGNhbGN1bGF0ZWQiLCBudWxsLCAic2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLkZMUEFuYWx5dGljcyIpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgLyoqDQogICAgICogSGFuZGxlciBmb3IgcHVibGlzaGVkIHVzYWdlQW5hbHl0aWNzIGV2ZW50cy4NCiAgICAgKi8NCiAgICBmdW5jdGlvbiBoYW5kbGVBY3Rpb24gKHNDaGFubmVsSWQsIHNFdmVudElkLCBvRGF0YSkgew0KICAgICAgICB2YXIgc0FwcGxpY2F0aW9uSWQgPSBoYXNoZXIuZ2V0SGFzaCgpLA0KICAgICAgICAgICAgc0FwcGxpY2F0aW9uVGl0bGU7DQoNCiAgICAgICAgd2luZG93LnN3YS5jdXN0b20xID0geyByZWY6IHNBcHBsaWNhdGlvbklkIH07DQogICAgICAgIHN3aXRjaCAoc0V2ZW50SWQpIHsNCiAgICAgICAgICAgIGNhc2UgImFwcE9wZW5lZCI6DQogICAgICAgICAgICAgICAgLy8gSW4gb3JkZXIgdG8gYmUgbm90aWZpZWQgd2hlbiBhcHBsaWNhdGlvbnMgYXJlIGxhdW5jaGVkIC0gd2UgcmVseSBvbiBuYXZDb250YWluZXIncyBhdHRhY2hBZnRlck5hdmlnYXRlIGV2ZW50Lg0KICAgICAgICAgICAgICAgIC8vIGJ1dCBmb3IgdGhlIGZpcnN0IG5hdmlnYXRpb24gKGUuZy4gbG9naW4gb3IgZGlyZWN0IFVSTCBpbiBhIG5ldyB0YWIpIHdlIHN0aWxsIG5lZWQgdGhlICJhcHBPcGVuZWQiIGV2ZW50Lg0KICAgICAgICAgICAgICAgIHNhdmVPcGVuQXBwaWNhdGlvbkRhdGEoc0FwcGxpY2F0aW9uSWQpOw0KICAgICAgICAgICAgICAgIHNhcC51c2hlbGwuQ29udGFpbmVyLmdldFNlcnZpY2UoIlVzYWdlQW5hbHl0aWNzIikubG9nQ3VzdG9tRXZlbnQoIkZMUDogQXBwbGljYXRpb24gT3BlbmVkIiwgIkRpcmVjdCBMYXVuY2giLCBbb0xhdW5jaGVkQXBwbGljYXRpb25zW3NBcHBsaWNhdGlvbklkXS50aXRsZV0pOw0KICAgICAgICAgICAgICAgIG9FdmVudEJ1cy51bnN1YnNjcmliZSgic2FwLnVzaGVsbCIsICJhcHBPcGVuZWQiLCBoYW5kbGVBY3Rpb24pOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSAiYm9va21hcmtUaWxlQWRkZWQiOg0KICAgICAgICAgICAgICAgIHNBcHBsaWNhdGlvblRpdGxlID0gd2luZG93LmRvY3VtZW50LnRpdGxlOw0KICAgICAgICAgICAgICAgIHNhcC51c2hlbGwuQ29udGFpbmVyLmdldFNlcnZpY2UoIlVzYWdlQW5hbHl0aWNzIikubG9nQ3VzdG9tRXZlbnQoIkZMUDogUGVyc29uYWxpemF0aW9uIiwgIlNhdmUgYXMgVGlsZSIsIFsNCiAgICAgICAgICAgICAgICAgICAgc0FwcGxpY2F0aW9uVGl0bGUsDQogICAgICAgICAgICAgICAgICAgIG9EYXRhICYmIG9EYXRhLmdyb3VwICYmIG9EYXRhLmdyb3VwLnRpdGxlID8gb0RhdGEuZ3JvdXAudGl0bGUgOiAiIiwNCiAgICAgICAgICAgICAgICAgICAgb0RhdGEgJiYgb0RhdGEuZ3JvdXAgJiYgb0RhdGEuZ3JvdXAuaWQgPyBvRGF0YS5ncm91cC5pZCA6ICIiLA0KICAgICAgICAgICAgICAgICAgICBvRGF0YSAmJiBvRGF0YS50aWxlICYmIG9EYXRhLnRpbGUudGl0bGUgPyBvRGF0YS50aWxlLnRpdGxlIDogc0FwcGxpY2F0aW9uVGl0bGUNCiAgICAgICAgICAgICAgICBdKTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGNhc2UgImFjdGlvbk1vZGVBY3RpdmUiOg0KICAgICAgICAgICAgICAgIHNhcC51c2hlbGwuQ29udGFpbmVyLmdldFNlcnZpY2UoIlVzYWdlQW5hbHl0aWNzIikubG9nQ3VzdG9tRXZlbnQoIkZMUDogUGVyc29uYWxpemF0aW9uIiwgIkVudGVyIEFjdGlvbiBNb2RlIiwgW29EYXRhLnNvdXJjZV0pOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSAiY2F0YWxvZ1RpbGVDbGljayI6DQogICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5Db250YWluZXIuZ2V0U2VydmljZSgiVXNhZ2VBbmFseXRpY3MiKS5sb2dDdXN0b21FdmVudCgiRkxQOiBBcHBsaWNhdGlvbiBMYXVuY2ggcG9pbnQiLCAiQ2F0YWxvZyIsIFtdKTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGNhc2UgImRhc2hib2FyZFRpbGVDbGljayI6DQogICAgICAgICAgICAgICAgc2FwLnVzaGVsbC5Db250YWluZXIuZ2V0U2VydmljZSgiVXNhZ2VBbmFseXRpY3MiKS5sb2dDdXN0b21FdmVudCgiRkxQOiBBcHBsaWNhdGlvbiBMYXVuY2ggcG9pbnQiLCAiSG9tZXBhZ2UiLCBbXSk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBjYXNlICJkYXNoYm9hcmRUaWxlTGlua0NsaWNrIjoNCiAgICAgICAgICAgICAgICBzYXAudXNoZWxsLkNvbnRhaW5lci5nZXRTZXJ2aWNlKCJVc2FnZUFuYWx5dGljcyIpLmxvZ0N1c3RvbUV2ZW50KCJGTFA6IEFwcGxpY2F0aW9uIExhdW5jaCBwb2ludCIsICJUaWxlIEdyb3VwIExpbmsiLCBbXSk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgLyoqDQogICAgICogSGFuZGxlciBvZiBuYXZDb250YWluZXIncyBBZnRlck5hdmlnYXRlIGV2ZW50IChpLmUuIG5hdmlnYXRpb24gYmV0d2VlbiB0aGUgY29udGFpbmVyJ3MgcGFnZXMpDQogICAgICoNCiAgICAgKiAtIExvZ3MgIlRpbWVJbkFwcEV2ZW50IiBmb3IgdGhlIHNvdXJjZSBhcHBsaWNhdGlvbiAoaS5lLiBmcm9tIHdoaWNoIHRoZSBuYXZpZ2F0aW9uIG9jY3VycmVkKQ0KICAgICAqIC0gVXBkYXRlZCBkYXRhIGFib3V0IHRoZSBvcGVuZWQgYXBwbGljYXRpb24NCiAgICAgKiAtIExvZ3MgIkFwcGxpY2F0aW9uIE9wZW5lZCIgZXZlbnQNCiAgICAgKi8NCiAgICBmdW5jdGlvbiBoYW5kbGVBZnRlck5hdmlnYXRlIChvRXZlbnQpIHsNCiAgICAgICAgdmFyIHNGcm9tQXBwbGljYXRpb25JZCwNCiAgICAgICAgICAgIHNUb0FwcGxpY2F0aW9uSWQsDQogICAgICAgICAgICBvVGFyZ2V0QXBwbGljYXRpb247DQoNCiAgICAgICAgLy8gRm9yIHRoZSBzb3VyY2UgYXBwbGljYXRpb24gKHRoZSBvbmUgZnJvbSB3aGljaCB0aGUgdXNlciBuYXZpZ2F0ZXMpIC0NCiAgICAgICAgLy8gQ2FsY3VsYXRlIHRoZSB0aW1lIGR1cmF0aW9uIGFuZCBsb2cgYSAiVGltZSBpbiBBcHBsaWNhdGlvbiIgZXZlbnQNCiAgICAgICAgaWYgKG9FdmVudC5nZXRQYXJhbWV0ZXIoImZyb20iKSAmJiBvRXZlbnQuZ2V0UGFyYW1ldGVyKCJ0byIpKSB7DQogICAgICAgICAgICBzRnJvbUFwcGxpY2F0aW9uSWQgPSBvRXZlbnQuZ2V0UGFyYW1ldGVyKCJmcm9tIikuZ2V0SWQoKS5yZXBsYWNlKCJhcHBsaWNhdGlvbi0iLCAiIikucmVwbGFjZSgiYXBwbGljYXRpb25TaGVsbFBhZ2UtIiwgIiIpOw0KICAgICAgICAgICAgd2luZG93LnN3YS5jdXN0b20xID0geyByZWY6IHNGcm9tQXBwbGljYXRpb25JZCB9Ow0KICAgICAgICAgICAgbG9nVGltZUluQXBwRXZlbnQoc0Zyb21BcHBsaWNhdGlvbklkKTsNCiAgICAgICAgICAgIC8vIEZvciB0aGUgdGFyZ2V0IGFwcGxpY2F0aW9uICh0aGUgb25lIHRvIHdoaWNoIHRoZSB1c2VyIG5hdmlnYXRlcykgLQ0KICAgICAgICAgICAgLy8gS2VlcCB0aGUgb3BlbmluZyB0aW1lIGFuZCB0aXRsZSwgYW5kIGxvZyBhbiAiQXBwbGljYXRpb24gT3BlbmVkIiBldmVudA0KICAgICAgICAgICAgb1RhcmdldEFwcGxpY2F0aW9uID0gb0V2ZW50LmdldFBhcmFtZXRlcigidG8iKTsNCiAgICAgICAgICAgIHNUb0FwcGxpY2F0aW9uSWQgPSBvVGFyZ2V0QXBwbGljYXRpb24uZ2V0SWQoKS5yZXBsYWNlKCJhcHBsaWNhdGlvbi0iLCAiIikucmVwbGFjZSgiYXBwbGljYXRpb25TaGVsbFBhZ2UtIiwgIiIpOw0KICAgICAgICAgICAgc2F2ZU9wZW5BcHBpY2F0aW9uRGF0YShzVG9BcHBsaWNhdGlvbklkKTsNCiAgICAgICAgICAgIHdpbmRvdy5zd2EuY3VzdG9tMSA9IHsgcmVmOiBzVG9BcHBsaWNhdGlvbklkIH07DQogICAgICAgICAgICBzYXAudXNoZWxsLkNvbnRhaW5lci5nZXRTZXJ2aWNlKCJVc2FnZUFuYWx5dGljcyIpLmxvZ0N1c3RvbUV2ZW50KCJGTFA6IEFwcGxpY2F0aW9uIE9wZW5lZCIsICJGaW9yaSBOYXZpZ2F0aW9uIiwgW29MYXVuY2hlZEFwcGxpY2F0aW9uc1tzVG9BcHBsaWNhdGlvbklkXS50aXRsZV0pOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgLyoqDQogICAgICogSGFuZGxlciBvZiBicm93c2VyIHRhYiBjbG9zZSBldmVudA0KICAgICAqDQogICAgICogTG9ncyBhICJUaW1lIGluIEFwcCIgZXZlbnQNCiAgICAgKi8NCiAgICBqUXVlcnkod2luZG93KS5vbigidW5sb2FkIiwgZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICAgIHZhciBjdXJyZW50QXBwID0gd2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDEpOw0KICAgICAgICBsb2dUaW1lSW5BcHBFdmVudChjdXJyZW50QXBwKTsNCiAgICB9KTsNCg0KICAgIHRyeSB7DQogICAgICAgIHNhcC51aS5nZXRDb3JlKCkuYnlJZCgidmlld1BvcnRDb250YWluZXIiKS5hdHRhY2hBZnRlck5hdmlnYXRlKGhhbmRsZUFmdGVyTmF2aWdhdGUsIHRoYXQpOw0KICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgICAgTG9nLndhcm5pbmcoIkZhaWx1cmUgd2hlbiBzdWJzY3JpYmluZyB0byB2aWV3UG9ydENvbnRhaW5lciAnQWZ0ZXJOYXZpZ2F0ZScgZXZlbnQiLCBudWxsLCAic2FwLnVzaGVsbC5jb21wb25lbnRzLmhvbWVwYWdlLkZMUEFuYWx5dGljcyIpOw0KICAgIH0NCiAgICBvRXZlbnRCdXMuc3Vic2NyaWJlKCJzYXAudXNoZWxsLnNlcnZpY2VzLkJvb2ttYXJrIiwgImJvb2ttYXJrVGlsZUFkZGVkIiwgaGFuZGxlQWN0aW9uLCB0aGF0KTsNCiAgICBhT2JzZXJ2ZWRMYXVuY2hwYWRBY3Rpb25zLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsNCiAgICAgICAgb0V2ZW50QnVzLnN1YnNjcmliZSgibGF1bmNocGFkIiwgaXRlbSwgaGFuZGxlQWN0aW9uLCB0aGF0KTsNCiAgICB9KTsNCiAgICBvRXZlbnRCdXMuc3Vic2NyaWJlKCJzYXAudXNoZWxsIiwgImFwcE9wZW5lZCIsIGhhbmRsZUFjdGlvbiwgdGhhdCk7DQp9LCAvKiBiRXhwb3J0PSAqLyBmYWxzZSk7DQp9Cn0sIkNvbXBvbmVudC1wcmVsb2FkIgopOwo=</ActualData>
          </HTTPData>
        </HTTPDataSet>
        <IsExternalData>false</IsExternalData>
      </HTTPBody>
      <TcpPackets>
        <PacketInfo time="1676531" offset="0" length="542" />
        <PacketInfo time="1676531" offset="542" length="27550" />
      </TcpPackets>
    </HTTPResponse>
  </HTTPTask>
</HTTPSnapshot>